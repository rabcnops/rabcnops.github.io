<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>基于 Docker 的 MySQL GTID 主从复制与测试 | Rabcnops</title><meta name="author" content="Rab"><meta name="copyright" content="Rab"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基于 Docker 的 MySQL GTID 主从复制与测试。">
<meta property="og:type" content="article">
<meta property="og:title" content="基于 Docker 的 MySQL GTID 主从复制与测试">
<meta property="og:url" content="https://blog.rabcnops.cn/posts/articles/96e13b9f.html">
<meta property="og:site_name" content="Rabcnops">
<meta property="og:description" content="基于 Docker 的 MySQL GTID 主从复制与测试。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png">
<meta property="article:published_time" content="2023-05-03T15:20:00.000Z">
<meta property="article:modified_time" content="2023-05-03T15:44:30.025Z">
<meta property="article:author" content="Rab">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png"><link rel="shortcut icon" href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg"><link rel="canonical" href="https://blog.rabcnops.cn/posts/articles/96e13b9f.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="ChZGTmJgK6Cd-KcODCRca2hnXQkjF16b5ykmjM1Anl8"/><meta name="baidu-site-verification" content="codeva-VkkS25uSFS"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"文章发布于","messageNext":"天前，文章内容可能已经过期，请持续关注本博客最新文档！"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Rab","link":"链接: ","source":"来源: Rabcnops","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于 Docker 的 MySQL GTID 主从复制与测试',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-03 23:44:30'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/iconfont.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Rabcnops" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-ziyuan3"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-tag"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont icon-fenlei"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-lianjie_URL"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-mingpian2"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Rabcnops"><img class="site-icon" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rablogo.png"/></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-ziyuan3"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-tag"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont icon-fenlei"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-lianjie_URL"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-mingpian2"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">基于 Docker 的 MySQL GTID 主从复制与测试</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-03T15:20:00.000Z" title="发表于 2023-05-03 23:20:00">2023-05-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-03T15:44:30.025Z" title="更新于 2023-05-03 23:44:30">2023-05-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/">关系型数据库</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">MySQL</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="基于 Docker 的 MySQL GTID 主从复制与测试"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基于-Docker-的-MySQL-GTID-主从复制与测试"><a href="#基于-Docker-的-MySQL-GTID-主从复制与测试" class="headerlink" title="基于 Docker 的 MySQL GTID 主从复制与测试"></a><center>基于 Docker 的 MySQL GTID 主从复制与测试</center></h1><p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png" alt="ms-mysql"></p>
<hr>
<h2 id="一、规划"><a href="#一、规划" class="headerlink" title="一、规划"></a>一、规划</h2><h3 id="1-1-基础环境"><a href="#1-1-基础环境" class="headerlink" title="1.1 基础环境"></a>1.1 基础环境</h3><p>1、服务器环境</p>
<ul>
<li><p>Linux：CentOS 7.9</p>
</li>
<li><p>Docker：23.0.4</p>
</li>
<li><p>Docker-compose：2.7.0</p>
</li>
<li><p>Sysbench：1.0.20</p>
</li>
</ul>
<p>2、服务&#x2F;应用</p>
<ul>
<li>MySQL：8.0.33</li>
</ul>
<h3 id="1-2-应用架构"><a href="#1-2-应用架构" class="headerlink" title="1.2 应用架构"></a>1.2 应用架构</h3><blockquote>
<p>复制：双主双从，实现主从复制、主主复制；</p>
<p>读写：master 实例具备<code>读写权限</code>，slave 实例具备<code>只读权限</code>。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/M-S.png" alt="M-S"></p>
<h3 id="1-3-路径规划"><a href="#1-3-路径规划" class="headerlink" title="1.3 路径规划"></a>1.3 路径规划</h3><blockquote>
<p>数据持久化管理。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── master1</span><br><span class="line">│   ├── conf</span><br><span class="line">│   ├── data</span><br><span class="line">│   └── logs</span><br><span class="line">├── master2</span><br><span class="line">│   ├── conf</span><br><span class="line">│   ├── data</span><br><span class="line">│   └── logs</span><br><span class="line">├── slave1</span><br><span class="line">│   ├── conf</span><br><span class="line">│   ├── data</span><br><span class="line">│   └── logs</span><br><span class="line">└── slave2</span><br><span class="line">    ├── conf</span><br><span class="line">    ├── data</span><br><span class="line">    └── logs</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230429181901803.png" alt="image-20230429181901803"></p>
<h2 id="二、部署"><a href="#二、部署" class="headerlink" title="二、部署"></a>二、部署</h2><h3 id="2-1-服务部署"><a href="#2-1-服务部署" class="headerlink" title="2.1 服务部署"></a>2.1 服务部署</h3><p>1、安装 docker 服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://csdn-rab.oss-cn-chengdu.aliyuncs.com/shellscript/docker_install.sh | bash</span><br></pre></td></tr></table></figure>

<p>2、安装 docker-compse 编排工具</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://rab-package.oss-cn-hangzhou.aliyuncs.com/binary/el7/docker-compose/2.7.0/docker-compose-linux-x86_64</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x docker-compose-linux-x86_64 &amp;&amp; <span class="built_in">mv</span> docker-compose-linux-x86_64 /usr/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>3、安装 MySQL 服务</p>
<blockquote>
<p>使用 Docker-compose 进行编排。</p>
</blockquote>
<ul>
<li><p>创建持久化目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /root/mysql_install/&#123;master1/&#123;data,logs,conf&#125;,master2/&#123;data,logs,conf&#125;,slave1/&#123;data,logs,conf&#125;,slave2/&#123;data,logs,conf&#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 777 /root/mysql_install/&#123;master1/&#123;data,logs&#125;,master2/&#123;data,logs&#125;,slave1/&#123;data,logs&#125;,slave2/&#123;data,logs&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>临时测试-删除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /root/mysql_install/&#123;master1/&#123;data/*,logs/*&#125;,master2/&#123;data/*,logs/*&#125;,slave1/&#123;data/*,logs/*&#125;,slave2/&#123;data/*,logs/*&#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>分别上传配置文件（my.cnf）至 conf 目录下</p>
<blockquote>
<p>Master1 配置文件（server-id 为1，其他不变）</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># innodb_force_recovery = 6  # 数据恢复参数，在数据表结构异常时使用（缺省值为0）</span></span><br><span class="line">port = 3306</span><br><span class="line">datadir         = /var/lib/mysql</span><br><span class="line">log-error       = /var/log/mysql/error.log</span><br><span class="line">innodb-data-file-path = /var/lib/mysql/ibdata1:1G;/var/lib/mysql/ibdata2:1G;/var/lib/mysql/ibdata3:1G</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line">max_connections = 2000</span><br><span class="line">max_user_connections = 1900</span><br><span class="line">max_connect_errors = 100000</span><br><span class="line">max_allowed_packet = 50M</span><br><span class="line">lower_case_table_names = 1</span><br><span class="line">default-time_zone = <span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1055异常处理</span></span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line"><span class="comment"># GTID及二进制日志</span></span><br><span class="line">server-id = 1</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">master-info-repository = TABLE</span><br><span class="line">relay-log-info-repository = TABLE</span><br><span class="line"><span class="comment"># 设置binlog日志</span></span><br><span class="line">log-bin = /var/log/mysql/mysql-binlog</span><br><span class="line"><span class="comment"># 为每个session分配的内存，在事务过程中用来存储二进制日志的缓存</span></span><br><span class="line">binlog_cache_size=1M  </span><br><span class="line"><span class="comment"># 主从复制的格式（mixed,statement,row，默认格式是statement）官方推荐在使用GTID情况下，基于行复制</span></span><br><span class="line">binlog_format=row</span><br><span class="line"><span class="comment"># 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。</span></span><br><span class="line">expire_logs_days=7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不需要同步的数据库</span></span><br><span class="line">binlog-ignore-db = mysql</span><br><span class="line">binlog_ignore_db = information_schema</span><br><span class="line">binlog_ignore_db = performation_schema</span><br><span class="line">binlog_ignore_db = sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql_native_password</span></span><br><span class="line">default_authentication_plugin = <span class="string">&#x27;mysql_native_password&#x27;</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Master2 配置文件（server-id 为2，其他不变）</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># innodb_force_recovery = 6  # 数据恢复参数，在数据表结构异常时使用（缺省值为0）</span></span><br><span class="line">port = 3306</span><br><span class="line">datadir         = /var/lib/mysql</span><br><span class="line">log-error       = /var/log/mysql/error.log</span><br><span class="line">innodb-data-file-path = /var/lib/mysql/ibdata1:1G;/var/lib/mysql/ibdata2:1G;/var/lib/mysql/ibdata3:1G</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line">max_connections = 2000</span><br><span class="line">max_user_connections = 1900</span><br><span class="line">max_connect_errors = 100000</span><br><span class="line">max_allowed_packet = 50M</span><br><span class="line">lower_case_table_names = 1</span><br><span class="line">default-time_zone = <span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1055异常处理</span></span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line"><span class="comment"># GTID及二进制日志</span></span><br><span class="line">server-id = 2</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">master-info-repository = TABLE</span><br><span class="line">relay-log-info-repository = TABLE</span><br><span class="line"><span class="comment"># 设置binlog日志</span></span><br><span class="line">log-bin = /var/log/mysql/mysql-binlog</span><br><span class="line"><span class="comment"># 为每个session分配的内存，在事务过程中用来存储二进制日志的缓存</span></span><br><span class="line">binlog_cache_size=1M  </span><br><span class="line"><span class="comment"># 主从复制的格式（mixed,statement,row，默认格式是statement）官方推荐在使用GTID情况下，基于行复制</span></span><br><span class="line">binlog_format=row</span><br><span class="line"><span class="comment"># 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。</span></span><br><span class="line">expire_logs_days=7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不需要同步的数据库</span></span><br><span class="line">binlog-ignore-db = mysql</span><br><span class="line">binlog_ignore_db = information_schema</span><br><span class="line">binlog_ignore_db = performation_schema</span><br><span class="line">binlog_ignore_db = sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql_native_password</span></span><br><span class="line">default_authentication_plugin = <span class="string">&#x27;mysql_native_password&#x27;</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Slave1 配置文件（server-id 为3，其他不变）</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># innodb_force_recovery = 6  # 数据恢复参数，在数据表结构异常时使用（缺省值为0）</span></span><br><span class="line">port = 3306</span><br><span class="line">datadir         = /var/lib/mysql</span><br><span class="line">log-error       = /var/log/mysql/error.log</span><br><span class="line">innodb-data-file-path = /var/lib/mysql/ibdata1:1G;/var/lib/mysql/ibdata2:1G;/var/lib/mysql/ibdata3:1G</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line">max_connections = 2000</span><br><span class="line">max_user_connections = 1900</span><br><span class="line">max_connect_errors = 100000</span><br><span class="line">max_allowed_packet = 50M</span><br><span class="line">lower_case_table_names = 1</span><br><span class="line">default-time_zone = <span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1055异常处理</span></span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line"><span class="comment"># GTID及二进制日志</span></span><br><span class="line">server-id = 3</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">master-info-repository = TABLE</span><br><span class="line">relay-log-info-repository = TABLE</span><br><span class="line"><span class="comment"># 设置binlog日志</span></span><br><span class="line">log-bin = /var/log/mysql/mysql-binlog</span><br><span class="line"><span class="comment"># 为每个session分配的内存，在事务过程中用来存储二进制日志的缓存</span></span><br><span class="line">binlog_cache_size=1M  </span><br><span class="line"><span class="comment"># 主从复制的格式（mixed,statement,row，默认格式是statement）官方推荐在使用GTID情况下，基于行复制</span></span><br><span class="line">binlog_format=row</span><br><span class="line"><span class="comment"># 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。</span></span><br><span class="line">expire_logs_days=7</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql_native_password</span></span><br><span class="line">default_authentication_plugin = <span class="string">&#x27;mysql_native_password&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># slave实例设置为只读</span></span><br><span class="line">read_only = on</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Slave2 配置文件（server-id 为4，其他不变）</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># innodb_force_recovery = 6  # 数据恢复参数，在数据表结构异常时使用（缺省值为0）</span></span><br><span class="line">port = 3306</span><br><span class="line">datadir         = /var/lib/mysql</span><br><span class="line">log-error       = /var/log/mysql/error.log</span><br><span class="line">innodb-data-file-path = /var/lib/mysql/ibdata1:1G;/var/lib/mysql/ibdata2:1G;/var/lib/mysql/ibdata3:1G</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links = 0</span><br><span class="line">max_connections = 2000</span><br><span class="line">max_user_connections = 1900</span><br><span class="line">max_connect_errors = 100000</span><br><span class="line">max_allowed_packet = 50M</span><br><span class="line">lower_case_table_names = 1</span><br><span class="line">default-time_zone = <span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1055异常处理</span></span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line"><span class="comment"># GTID及二进制日志</span></span><br><span class="line">server-id = 3</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">master-info-repository = TABLE</span><br><span class="line">relay-log-info-repository = TABLE</span><br><span class="line"><span class="comment"># 设置binlog日志</span></span><br><span class="line">log-bin = /var/log/mysql/mysql-binlog</span><br><span class="line"><span class="comment"># 为每个session分配的内存，在事务过程中用来存储二进制日志的缓存</span></span><br><span class="line">binlog_cache_size=1M  </span><br><span class="line"><span class="comment"># 主从复制的格式（mixed,statement,row，默认格式是statement）官方推荐在使用GTID情况下，基于行复制</span></span><br><span class="line">binlog_format=row</span><br><span class="line"><span class="comment"># 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。</span></span><br><span class="line">expire_logs_days=7</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql_native_password</span></span><br><span class="line">default_authentication_plugin = <span class="string">&#x27;mysql_native_password&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># slave实例设置为只读</span></span><br><span class="line">read_only = on</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 docker-compose 文件</p>
<blockquote>
<p>指定 IP 时，注意不要与原网段重复，否则将创建失败！</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  master1:</span><br><span class="line">    image: mysql:8.0.33</span><br><span class="line">    container_name: master1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 33061:3306</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=Zhurs@123!</span><br><span class="line">    volumes:</span><br><span class="line">      - /root/mysql_install/master1/conf:/etc/mysql/conf.d</span><br><span class="line">      - /root/mysql_install/master1/logs:/var/log/mysql</span><br><span class="line">      - /root/mysql_install/master1/data:/var/lib/mysql</span><br><span class="line">    networks:</span><br><span class="line">      mysql-network:</span><br><span class="line">        ipv4_address: 172.31.1.11</span><br><span class="line">  master2:</span><br><span class="line">    image: mysql:8.0.33</span><br><span class="line">    container_name: master2</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 33062:3306</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=Zhurs@123!</span><br><span class="line">    volumes:</span><br><span class="line">      - /root/mysql_install/master2/conf:/etc/mysql/conf.d</span><br><span class="line">      - /root/mysql_install/master2/logs:/var/log/mysql</span><br><span class="line">      - /root/mysql_install/master2/data:/var/lib/mysql</span><br><span class="line">    networks:</span><br><span class="line">      mysql-network:</span><br><span class="line">        ipv4_address: 172.31.1.12</span><br><span class="line">  slave1:</span><br><span class="line">    image: mysql:8.0.33</span><br><span class="line">    container_name: slave1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 33063:3306</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=Zhurs@123!</span><br><span class="line">    volumes:</span><br><span class="line">      - /root/mysql_install/slave1/conf:/etc/mysql/conf.d</span><br><span class="line">      - /root/mysql_install/slave1/logs:/var/log/mysql</span><br><span class="line">      - /root/mysql_install/slave1/data:/var/lib/mysql</span><br><span class="line">    networks:</span><br><span class="line">      mysql-network:</span><br><span class="line">        ipv4_address: 172.31.1.13</span><br><span class="line">  slave2:</span><br><span class="line">    image: mysql:8.0.33</span><br><span class="line">    container_name: slave2</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 33064:3306</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=Zhurs@123!</span><br><span class="line">    volumes:</span><br><span class="line">      - /root/mysql_install/slave2/conf:/etc/mysql/conf.d</span><br><span class="line">      - /root/mysql_install/slave2/logs:/var/log/mysql</span><br><span class="line">      - /root/mysql_install/slave2/data:/var/lib/mysql</span><br><span class="line">    networks:</span><br><span class="line">      mysql-network:</span><br><span class="line">        ipv4_address: 172.31.1.14</span><br><span class="line">      </span><br><span class="line">networks:</span><br><span class="line">  mysql-network:</span><br><span class="line">    driver: bridge</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 172.31.1.0/24</span><br><span class="line">          gateway: 172.31.1.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行 MySQL 服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看容器是否正常运行。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230502225451248.png" alt="image-20230502225451248"></p>
</li>
</ul>
<h3 id="2-2-主从配置"><a href="#2-2-主从配置" class="headerlink" title="2.2 主从配置"></a>2.2 主从配置</h3><h4 id="2-2-1-主从同步配置"><a href="#2-2-1-主从同步配置" class="headerlink" title="2.2.1 主从同步配置"></a>2.2.1 主从同步配置</h4><p>1、配置 <code>master1 - - &gt; slave1</code> 主从</p>
<ul>
<li><p>master1 实例创建主从同步账号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入master1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it master1 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line"><span class="comment"># 注意：MySql8有新的安全要求，不能像之前的版本那样一次性创建用户并授权需要先创建用户，再进行授权操作</span></span><br><span class="line">create user <span class="string">&#x27;repl_master1&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;zhurs@123.com&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权（主从同步权限即可）</span></span><br><span class="line"><span class="comment"># replication slave权限：拥有此权限可以查看从服务器，从主服务器读取二进制日志。</span></span><br><span class="line"><span class="comment"># super权限：允许用户使用修改全局变量的SET语句以及CHANGE（属于MASTER语句）</span></span><br><span class="line"><span class="comment"># reload权限：必须拥有reload权限，才可以执行flush  [tables | logs | privileges]</span></span><br><span class="line">grant replication  slave,reload,super on *.* to <span class="string">&#x27;repl_master1&#x27;</span>@<span class="string">&#x27;%&#x27;</span> with grant option;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新授权</span></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
</li>
<li><p>slave1 实例进行同步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入slave1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it slave1 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接master1主库</span></span><br><span class="line">CHANGE MASTER TO master_host=<span class="string">&#x27;172.31.1.11&#x27;</span>, master_port=3306, master_user=<span class="string">&#x27;repl_master1&#x27;</span>, master_password=<span class="string">&#x27;zhurs@123.com&#x27;</span>, master_auto_position=1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动slave连接</span></span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看同步状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503000000879.png" alt="image-20230503000000879"></p>
</li>
</ul>
<p>2、配置 <code>master2 - - &gt; slave2</code> 主从</p>
<ul>
<li><p>master2 实例创建主从同步账号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入master2容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it master2 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line"><span class="comment"># 注意：MySql8有新的安全要求，不能像之前的版本那样一次性创建用户并授权需要先创建用户，再进行授权操作</span></span><br><span class="line">create user <span class="string">&#x27;repl_master2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;zhurs@123.com&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权（主从同步权限即可）</span></span><br><span class="line"><span class="comment"># replication slave权限：拥有此权限可以查看从服务器，从主服务器读取二进制日志。</span></span><br><span class="line"><span class="comment"># super权限：允许用户使用修改全局变量的SET语句以及CHANGE（属于MASTER语句）</span></span><br><span class="line"><span class="comment"># reload权限：必须拥有reload权限，才可以执行flush  [tables | logs | privileges]</span></span><br><span class="line">grant replication  slave,reload,super on *.* to <span class="string">&#x27;repl_master2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> with grant option;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新授权</span></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
</li>
<li><p>slave2 实例进行同步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入slave2容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it slave2 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接master2主库</span></span><br><span class="line">CHANGE MASTER TO master_host=<span class="string">&#x27;172.31.1.12&#x27;</span>, master_port=3306, master_user=<span class="string">&#x27;repl_master2&#x27;</span>, master_password=<span class="string">&#x27;zhurs@123.com&#x27;</span>, master_auto_position=1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动slave连接</span></span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看同步状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503001352692.png" alt="image-20230503001352692"></p>
</li>
</ul>
<p><mark>至此，MySQL 的主从复制完成！接下来配置主主复制过程！</mark></p>
<h4 id="2-2-2-主主同步配置"><a href="#2-2-2-主主同步配置" class="headerlink" title="2.2.2 主主同步配置"></a>2.2.2 主主同步配置</h4><p>1、配置 <code>master1 - - &gt; master2</code> 主从</p>
<blockquote>
<p>master1 为主，master2 为从</p>
</blockquote>
<ul>
<li><p>master1 实例创建主从同步账号</p>
<blockquote>
<p>已经创建。</p>
</blockquote>
</li>
<li><p>master2 实例进行同步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入slave1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it master2 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接master1主库</span></span><br><span class="line">CHANGE MASTER TO master_host=<span class="string">&#x27;172.31.1.11&#x27;</span>, master_port=3306, master_user=<span class="string">&#x27;repl_master1&#x27;</span>, master_password=<span class="string">&#x27;zhurs@123.com&#x27;</span>, master_auto_position=1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动slave连接</span></span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看同步状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503001450209.png" alt="image-20230503001450209"></p>
</li>
</ul>
<p>2、配置 <code>master2 - - &gt; master1</code> 主从</p>
<blockquote>
<p>master2 为主，master1 为从</p>
</blockquote>
<ul>
<li><p>master2 实例创建主从同步账号</p>
<blockquote>
<p>已经创建。</p>
</blockquote>
</li>
<li><p>master1 实例进行同步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入slave1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it master1 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接master1主库</span></span><br><span class="line">CHANGE MASTER TO master_host=<span class="string">&#x27;172.31.1.12&#x27;</span>, master_port=3306, master_user=<span class="string">&#x27;repl_master2&#x27;</span>, master_password=<span class="string">&#x27;zhurs@123.com&#x27;</span>, master_auto_position=1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动slave连接</span></span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看同步状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503001757491.png" alt="image-20230503001757491"></p>
</li>
</ul>
<p><mark>至此，主从复制、主主复制结束！</mark></p>
<blockquote>
<p><strong>注</strong>：在配置 SLAVE 同步时</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先停止数据同步相关的线程： slave I/O 线程和 slave SQL 线程</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了避免可能发生的错误，直接重置客户端</span></span><br><span class="line">RESET  SLAVE;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-主从验证"><a href="#2-3-主从验证" class="headerlink" title="2.3 主从验证"></a>2.3 主从验证</h3><h4 id="2-3-1-主从同步验证"><a href="#2-3-1-主从同步验证" class="headerlink" title="2.3.1 主从同步验证"></a>2.3.1 主从同步验证</h4><p>1、master1 创建测试数据库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database <span class="keyword">if</span> not exists master1 default charset utf8 collate utf8_general_ci;</span><br></pre></td></tr></table></figure>

<p>2、slave1 验证是否同步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show databases;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如下图，已经同步</span></span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503002355116.png" alt="image-20230503002355116"></p>
<h4 id="2-3-2-主主同步验证"><a href="#2-3-2-主主同步验证" class="headerlink" title="2.3.2 主主同步验证"></a>2.3.2 主主同步验证</h4><p>此时，master2、slave2 也都有名为 <code>master1</code> 的测试数据库，因为 master2 与 master1 互为主从，而 slave2 又是 master2 的从库。</p>
<p>因此得出结论，这种数据库架构下，只要你在任意一 master 节点上创建数据库，每个 MySQL 实例都会实现数据同步。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503002458446.png" alt="image-20230503002458446"></p>
<h3 id="2-4-客户端连接"><a href="#2-4-客户端连接" class="headerlink" title="2.4 客户端连接"></a>2.4 客户端连接</h3><h4 id="2-4-1-控制台"><a href="#2-4-1-控制台" class="headerlink" title="2.4.1 控制台"></a>2.4.1 控制台</h4><blockquote>
<p>需安装MySQL客户端命令（mysql）。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pZhurs@123! -h 192.168.56.120 -P 33061</span><br></pre></td></tr></table></figure>

<h4 id="2-4-2-图形化"><a href="#2-4-2-图形化" class="headerlink" title="2.4.2 图形化"></a>2.4.2 图形化</h4><blockquote>
<p>如 client 通过 navicat 客户端软件连接 master 节点（只需要连接其中之一即可），或以 VIP 的方式连接（配置 keepalived 实现 master 节点高可用），由于在单台 Host 虚拟机下运行的多 MySQL 实例，就无法做高可用演示，生产中至少两台 master 的 Host 节点来实现高可用。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503003905267.png" alt="image-20230503003905267"></p>
<p><strong>查看数据库：</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503003945019.png" alt="image-20230503003945019"></p>
<p><mark>至此，主从复制 + 主主复制 + 客户端连接已经配置完毕！</mark></p>
<h2 id="三、压测"><a href="#三、压测" class="headerlink" title="三、压测"></a>三、压测</h2><blockquote>
<p>测试：主从读写性能。</p>
<p>工具：<code>sysbench</code></p>
</blockquote>
<h3 id="3-1-安装-sysbench"><a href="#3-1-安装-sysbench" class="headerlink" title="3.1 安装 sysbench"></a>3.1 安装 sysbench</h3><p>1、执行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh | sudo bash</span><br></pre></td></tr></table></figure>

<p>2、开始安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install sysbench</span><br></pre></td></tr></table></figure>

<p>3、验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --version</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503213303900.png" alt="image-20230503213303900"></p>
<h3 id="3-2-sysbench-压测"><a href="#3-2-sysbench-压测" class="headerlink" title="3.2 sysbench 压测"></a>3.2 sysbench 压测</h3><blockquote>
<p>由于我的系统主机资源有限，因此就简单的 10 张表、每张表 1千条数据进行 5 分钟压测</p>
<p>参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://help.aliyun.com/document_detail/146103.html">https://help.aliyun.com/document_detail/146103.html</a></p>
</blockquote>
<h4 id="3-2-1-读性能"><a href="#3-2-1-读性能" class="headerlink" title="3.2.1  读性能"></a>3.2.1  读性能</h4><p>1、准备数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300  oltp_read_only prepare</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 说明：</span></span><br><span class="line"><span class="comment"># --table_size：表记录数</span></span><br><span class="line"><span class="comment"># --tables：表数量</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>执行完毕后，来查看数据库。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503223241087.png" alt="image-20230503223241087"></p>
<p>2、运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300 \</span><br><span class="line">  --threads=5 \</span><br><span class="line">  --percentile=95 \</span><br><span class="line">  --range_selects=0 \</span><br><span class="line">  --skip-trx=1 \</span><br><span class="line">  --report-interval=1 oltp_read_only run</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 说明：</span></span><br><span class="line"><span class="comment"># --threads：并发线程数，可以理解为模拟的客户端并发连接数</span></span><br><span class="line"><span class="comment"># --skip-trx：省略begin/commit语句。默认是off</span></span><br></pre></td></tr></table></figure>

<p>**执行结果：**从中可看出每秒查询，每秒事务等执行结果。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503224520488.png" alt="image-20230503224520488"></p>
<p>除此之外，Host 系统的平均负载也在升高：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503225222279.png" alt="image-20230503225222279"></p>
<p>3、清理</p>
<blockquote>
<p>测试完成后清理数据，释放空间</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300   \</span><br><span class="line">  --threads=5 \</span><br><span class="line">  --percentile=95 \</span><br><span class="line">  --range_selects=0 oltp_read_only cleanup</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-写性能"><a href="#3-2-2-写性能" class="headerlink" title="3.2.2 写性能"></a>3.2.2 写性能</h4><p>1、准备数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300  oltp_write_only prepare</span><br></pre></td></tr></table></figure>

<p>2、运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300 \</span><br><span class="line">  --threads=5 \</span><br><span class="line">  --percentile=95 \</span><br><span class="line">  --report-interval=1 oltp_write_only run</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503225733818.png" alt="image-20230503225733818"></p>
<p>3、清理</p>
<blockquote>
<p>测试完成后清理数据，释放空间</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300 \</span><br><span class="line">  --threads=5 \</span><br><span class="line">  --percentile=95 oltp_write_only cleanup</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-读写性能"><a href="#3-2-3-读写性能" class="headerlink" title="3.2.3 读写性能"></a>3.2.3 读写性能</h4><p>1、准备数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300 oltp_read_write prepare</span><br></pre></td></tr></table></figure>

<p>2、运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql  \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300 \</span><br><span class="line">  --threads=5 \</span><br><span class="line">  --percentile=95 \</span><br><span class="line">  --report-interval=1 oltp_read_write run</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503231502157.png" alt="image-20230503231502157"></p>
<p>3、清理</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sysbench \</span><br><span class="line">  --db-driver=mysql \</span><br><span class="line">  --mysql-host=192.168.56.120 \</span><br><span class="line">  --mysql-port=33061 \</span><br><span class="line">  --mysql-user=root \</span><br><span class="line">  --mysql-password=Zhurs@123! \</span><br><span class="line">  --mysql-db=master1 \</span><br><span class="line">  --table_size=1000 \</span><br><span class="line">  --tables=10 \</span><br><span class="line">  --events=0 \</span><br><span class="line">  --time=300 \</span><br><span class="line">  --threads=5 \</span><br><span class="line">  --percentile=95 oltp_read_write cleanup</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-主从复制延迟"><a href="#3-2-4-主从复制延迟" class="headerlink" title="3.2.4 主从复制延迟"></a>3.2.4 主从复制延迟</h4><p>以 10 张表，每张表 1000 条记录，读写压测 5 分钟的数据来看，主从复制的延迟在为 1s，不超过 2s（本次测试结果），如下图所示。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503225703898.png" alt="image-20230503225703898"></p>
<h2 id="四、扩展"><a href="#四、扩展" class="headerlink" title="四、扩展"></a>四、扩展</h2><h3 id="4-1-主从复制方式"><a href="#4-1-主从复制方式" class="headerlink" title="4.1 主从复制方式"></a>4.1 主从复制方式</h3><h4 id="4-1-1-异步复制（Asynchronous-replication）"><a href="#4-1-1-异步复制（Asynchronous-replication）" class="headerlink" title="4.1.1 异步复制（Asynchronous replication）"></a>4.1.1 异步复制（Asynchronous replication）</h4><p>MySQL 默认使用的是异步复制，官方解释如下：</p>
<p><code>the master writes events to its binary log and slaves request them when they are ready. There is no guarantee that any event will ever reach any slave.</code></p>
<p>即 master 服务器将事件写入其二进制日志，slave 服务器在事件准备好时请求事件。不能保证任何事件都会影响到任何一个 slave。</p>
<p><strong>说白了就是</strong>：主库只管把 events 写入 binlog 中，不管从库有没有收到。</p>
<h4 id="4-1-2-全同步复制（Fully-synchronous-replication）"><a href="#4-1-2-全同步复制（Fully-synchronous-replication）" class="headerlink" title="4.1.2 全同步复制（Fully synchronous replication）"></a>4.1.2 全同步复制（Fully synchronous replication）</h4><p>官方解释如下：</p>
<p><code>when a master commits a transaction, all slaves also will have committed the transaction before the master returns to the session that performed the transaction. The drawback of this is that there might be a lot of delay to complete a transaction.</code></p>
<p>即 master 服务器提交事务时，在 master 服务器返回到执行该事务的会话之前，所有 slave 服务器也将提交该事务。这样做的缺点是完成事务可能会有很多延迟。</p>
<p><strong>说白了就是</strong>：主库提交一个事物，需要等待所有从库先提交才能返回结果，执行这个事物。这样会造成一个事物延时。</p>
<h4 id="4-1-3-半同步复制（Semisynchronous-replication）"><a href="#4-1-3-半同步复制（Semisynchronous-replication）" class="headerlink" title="4.1.3 半同步复制（Semisynchronous replication）"></a>4.1.3 半同步复制（Semisynchronous replication）</h4><p>官方解释如下：</p>
<p><code>falls between asynchronous and fully synchronous replication. The master waits only until at least one slave has received and logged the events. It does not wait for all slaves to acknowledge receipt, and it requires only receipt, not that the events have been fully executed and committed on the slave side.</code></p>
<p>即介于异步复制和全同步复制之间。master 服务器只等待至少一个 slave 服务器接收并记录事件。它不等待所有从服务器确认接收，它只需要接收，而不需要在从服务器端完全执行和提交事件。</p>
<p><strong>说白了就是</strong>：介于异步复制和全复制之间，主库仅仅只要等待至少一个从库收到和记录 events。它不需要等待所有的从库告诉它收到events，也不需要从库执行和提交事物，从库只是收到 events 就会告诉主库，这样主库就可以提前提交事物了。</p>
<h3 id="4-2-GTID-与-Binary-Log"><a href="#4-2-GTID-与-Binary-Log" class="headerlink" title="4.2 GTID 与 Binary Log"></a>4.2 GTID 与 Binary Log</h3><p>1、GTID</p>
<p><code>MySQL GTID（Global Transaction ID）</code>是一种用于在复制环境中唯一标识事务的机制。GTID 能够在复制拓扑中帮助识别和跟踪每个事务的状态，从而更方便的进行数据同步和故障恢复。在 MySQL 5.6 版本及以上，可以使用 GTID 进行复制。</p>
<p>2、Binary Log</p>
<p><code>binlog（Binary Log）</code>是 MySQL 中的一种日志文件，用于记录对 MySQL 数据库进行的更改操作。它记录了所有的数据更改操作，包括对表的插入、更新和删除等操作。binlog 日志可以用于数据恢复、复制和备份等操作。</p>
<p>3、两者区别</p>
<ul>
<li>功能不同：GTID 用于唯一标识复制环境中的事务，而 binlog 用于记录数据库的更改操作。</li>
<li>数据结构不同：GTID 是由服务器生成的唯一标识符，用于标识每个事务。而 binlog 是一种二进制格式的日志文件，记录了每个事务的更改操作。</li>
<li>使用方式不同：GTID 用于在复制拓扑中标识和跟踪每个事务的状态，从而更方便地进行数据同步和故障恢复。而 binlog 可以用于数据恢复、复制和备份等操作。</li>
</ul>
<p><mark>需要注意的是</mark>：使用 GTID 进行复制需要 MySQL 5.6 及以上版本的支持。在 MySQL 5.5 及以下版本中，只能使用 binlog 进行数据复制和备份。本次使用的是基于 GTID 的主从复制。</p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>MySQL 5.1.7 + 已经不支持 <code>“master-host”</code> 类似的参数。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503195146922.png" alt="image-20230503195146922"></p>
<p>因此 <code>docker-compose</code> 中就无法实现启动时主从同步（如下图 command 部分）：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230503195256475.png" alt="image-20230503195256475"></p>
<p>所以，通过 docker-compose 运行主从时，需进入从库进行配置！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.rabcnops.cn">Rab</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.rabcnops.cn/posts/articles/96e13b9f.html">https://blog.rabcnops.cn/posts/articles/96e13b9f.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.rabcnops.cn" target="_blank">Rabcnops</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post_share"><div class="social-share" data-image="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/wechat.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/alipay.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/articles/f4b248ff.html" title="MySQL 主从复制涉及到了几个线程？"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL 主从复制涉及到了几个线程？</div></div></a></div><div class="next-post pull-right"><a href="/posts/articles/e42dd192.html" title="Redis 的 Protected Mode 解读"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/redis-social-1200x628-1.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis 的 Protected Mode 解读</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/articles/f4b248ff.html" title="MySQL 主从复制涉及到了几个线程？"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-09</div><div class="title">MySQL 主从复制涉及到了几个线程？</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Livere</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81ODIzNS8zNDY5OA=="></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Rab</div><div class="author-info__description">专注于云计算/云原生/开发。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/rabcnops/"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhurse@163.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="iconfont icon-minutemailer"></i></a><a class="social-icon" href="https://blog.csdn.net/IT_ZRS" rel="external nofollow noreferrer" target="_blank" title="CSDN"><i class="iconfont icon-csdn1"></i></a><a class="social-icon" href="tencent://Message/?Uin=2564395767&amp;websiteName=www.oicqzone.com&amp;Menu=yes" rel="external nofollow noreferrer" target="_blank" title="QQ"><i class="iconfont icon-QQ"></i></a><a class="social-icon" href="https://blog.rabcnops.cn/atom.xml" target="_blank" title="RSS"><i class="iconfont icon-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">2023/03/24 开通个人博客系统，会同步 CSDN 内容。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Docker-%E7%9A%84-MySQL-GTID-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="toc-text">基于 Docker 的 MySQL GTID 主从复制与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%A7%84%E5%88%92"><span class="toc-text">一、规划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83"><span class="toc-text">1.1 基础环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-text">1.2 应用架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92"><span class="toc-text">1.3 路径规划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2"><span class="toc-text">二、部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="toc-text">2.1 服务部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2 主从配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2.1 主从同步配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E4%B8%BB%E4%B8%BB%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2.2 主主同步配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E4%B8%BB%E4%BB%8E%E9%AA%8C%E8%AF%81"><span class="toc-text">2.3 主从验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E9%AA%8C%E8%AF%81"><span class="toc-text">2.3.1 主从同步验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E4%B8%BB%E4%B8%BB%E5%90%8C%E6%AD%A5%E9%AA%8C%E8%AF%81"><span class="toc-text">2.3.2 主主同步验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5"><span class="toc-text">2.4 客户端连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-text">2.4.1 控制台</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E5%9B%BE%E5%BD%A2%E5%8C%96"><span class="toc-text">2.4.2 图形化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%8E%8B%E6%B5%8B"><span class="toc-text">三、压测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AE%89%E8%A3%85-sysbench"><span class="toc-text">3.1 安装 sysbench</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-sysbench-%E5%8E%8B%E6%B5%8B"><span class="toc-text">3.2 sysbench 压测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E8%AF%BB%E6%80%A7%E8%83%BD"><span class="toc-text">3.2.1  读性能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E5%86%99%E6%80%A7%E8%83%BD"><span class="toc-text">3.2.2 写性能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-%E8%AF%BB%E5%86%99%E6%80%A7%E8%83%BD"><span class="toc-text">3.2.3 读写性能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%BB%B6%E8%BF%9F"><span class="toc-text">3.2.4 主从复制延迟</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%89%A9%E5%B1%95"><span class="toc-text">四、扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%96%B9%E5%BC%8F"><span class="toc-text">4.1 主从复制方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6%EF%BC%88Asynchronous-replication%EF%BC%89"><span class="toc-text">4.1.1 异步复制（Asynchronous replication）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-%E5%85%A8%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%EF%BC%88Fully-synchronous-replication%EF%BC%89"><span class="toc-text">4.1.2 全同步复制（Fully synchronous replication）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%EF%BC%88Semisynchronous-replication%EF%BC%89"><span class="toc-text">4.1.3 半同步复制（Semisynchronous replication）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-GTID-%E4%B8%8E-Binary-Log"><span class="toc-text">4.2 GTID 与 Binary Log</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FAQ"><span class="toc-text">FAQ</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/f4b248ff.html" title="MySQL 主从复制涉及到了几个线程？"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL 主从复制涉及到了几个线程？"/></a><div class="content"><a class="title" href="/posts/articles/f4b248ff.html" title="MySQL 主从复制涉及到了几个线程？">MySQL 主从复制涉及到了几个线程？</a><time datetime="2023-05-09T01:38:00.000Z" title="发表于 2023-05-09 09:38:00">2023-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/96e13b9f.html" title="基于 Docker 的 MySQL GTID 主从复制与测试"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/ms-mysql.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基于 Docker 的 MySQL GTID 主从复制与测试"/></a><div class="content"><a class="title" href="/posts/articles/96e13b9f.html" title="基于 Docker 的 MySQL GTID 主从复制与测试">基于 Docker 的 MySQL GTID 主从复制与测试</a><time datetime="2023-05-03T15:20:00.000Z" title="发表于 2023-05-03 23:20:00">2023-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/e42dd192.html" title="Redis 的 Protected Mode 解读"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/redis-social-1200x628-1.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis 的 Protected Mode 解读"/></a><div class="content"><a class="title" href="/posts/articles/e42dd192.html" title="Redis 的 Protected Mode 解读">Redis 的 Protected Mode 解读</a><time datetime="2023-04-25T09:38:00.000Z" title="发表于 2023-04-25 17:38:00">2023-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/b4beeb2a.html" title="Redis 6.0+ 的 ACL 常用操作指令"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/Screenshot-2022-09-28-135602.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis 6.0+ 的 ACL 常用操作指令"/></a><div class="content"><a class="title" href="/posts/articles/b4beeb2a.html" title="Redis 6.0+ 的 ACL 常用操作指令">Redis 6.0+ 的 ACL 常用操作指令</a><time datetime="2023-04-25T07:00:00.000Z" title="发表于 2023-04-25 15:00:00">2023-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/fe7524c5.html" title="如何理解 Linux 的 CPU 上下文切换？（连载）"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/linux-protection-rings.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="如何理解 Linux 的 CPU 上下文切换？（连载）"/></a><div class="content"><a class="title" href="/posts/articles/fe7524c5.html" title="如何理解 Linux 的 CPU 上下文切换？（连载）">如何理解 Linux 的 CPU 上下文切换？（连载）</a><time datetime="2023-04-24T10:20:00.000Z" title="发表于 2023-04-24 18:20:00">2023-04-24</time></div></div></div></div></div></div></main><footer id="footer" style="background: #14161a"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Rab</div><div class="footer_custom_text">Hi, welcome to my <a href="https://blog.rabcnops.cn/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://blog.rabcnops.cn/posts/articles/96e13b9f.html'
    this.page.identifier = '/posts/articles/96e13b9f.html'
    this.page.title = '基于 Docker 的 MySQL GTID 主从复制与测试'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Livere' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>