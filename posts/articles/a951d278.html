<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Pipeline 核心技术 | Rabcnops</title><meta name="author" content="Rab"><meta name="copyright" content="Rab"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Pipeline 有两种语法格式，分别是脚本式和声明式，通常我们是两种语法格式结合使用。">
<meta property="og:type" content="article">
<meta property="og:title" content="Pipeline 核心技术">
<meta property="og:url" content="https://blog.rabcnops.cn/posts/articles/a951d278.html">
<meta property="og:site_name" content="Rabcnops">
<meta property="og:description" content="Pipeline 有两种语法格式，分别是脚本式和声明式，通常我们是两种语法格式结合使用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/%E6%B5%81%E6%B0%B4%E7%BA%BF.webp">
<meta property="article:published_time" content="2022-07-22T03:33:14.000Z">
<meta property="article:modified_time" content="2023-03-27T09:24:05.937Z">
<meta property="article:author" content="Rab">
<meta property="article:tag" content="CICD">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Jenkins_Pipeline">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/%E6%B5%81%E6%B0%B4%E7%BA%BF.webp"><link rel="shortcut icon" href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg"><link rel="canonical" href="https://blog.rabcnops.cn/posts/articles/a951d278.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="ChZGTmJgK6Cd-KcODCRca2hnXQkjF16b5ykmjM1Anl8"/><meta name="baidu-site-verification" content="codeva-VkkS25uSFS"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Rab","link":"链接: ","source":"来源: Rabcnops","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Pipeline 核心技术',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-27 17:24:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/iconfont.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-mingpian2"></i><span> 关于作者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/%E6%B5%81%E6%B0%B4%E7%BA%BF.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="Rabcnops"><span class="site-name">Rabcnops</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-mingpian2"></i><span> 关于作者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Pipeline 核心技术</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-22T03:33:14.000Z" title="发表于 2022-07-22 11:33:14">2022-07-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-27T09:24:05.937Z" title="更新于 2023-03-27 17:24:05">2023-03-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DevOps/">DevOps</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DevOps/Jenkins/">Jenkins</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>53分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Pipeline 核心技术"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/%E6%B5%81%E6%B0%B4%E7%BA%BF.webp" alt="流水线"></p>
<p><font color=Brown><strong>Author</strong>：rab</font><br><font color=Brown><strong>Date</strong>：2022&#x2F;07&#x2F;24</font><br><font color=Brown><strong>Blog</strong>：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/IT_ZRS?type=blog"><font color=Brown>https://blog.csdn.net/IT_ZRS?type&#x3D;blog</font></a></font></p>
<hr>
<h2 id="一、整体结构"><a href="#一、整体结构" class="headerlink" title="一、整体结构"></a>一、整体结构</h2><p>Pipeline 有两种语法格式，分别是脚本式和声明式，通常我们是两种语法格式结合使用。先来看看整体结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">	agent any</span><br><span class="line">	stages &#123;</span><br><span class="line">		stage(&#x27;git&#x27;) &#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				// 拉取项目</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		stage(&#x27;build&#x27;) &#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				// 构建项目</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		stage(&#x27;deproment&#x27;) &#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				script &#123;</span><br><span class="line">					// 发布项目</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	post &#123;</span><br><span class="line">		always &#123;</span><br><span class="line">			// 不管构建成功、失败还是取消都执行该部分操作</span><br><span class="line">		&#125;</span><br><span class="line">		success &#123;</span><br><span class="line">			// 只有构建成功后才执行该部分操作</span><br><span class="line">		&#125;</span><br><span class="line">		failure &#123;</span><br><span class="line">			// 只有构建失败后才执行该部分操作</span><br><span class="line">		&#125;</span><br><span class="line">		aborted &#123;</span><br><span class="line">			// 只有构建中途取消构建后才执行该部分</span><br><span class="line">		&#125;</span><br><span class="line">		unstable &#123;</span><br><span class="line">			// 构建不稳定时执行该部分</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、基本语法"><a href="#二、基本语法" class="headerlink" title="二、基本语法"></a>二、基本语法</h2><h3 id="2-1-agent"><a href="#2-1-agent" class="headerlink" title="2.1 agent"></a>2.1 agent</h3><h4 id="2-1-1-说明"><a href="#2-1-1-说明" class="headerlink" title="2.1.1 说明"></a>2.1.1 说明</h4><p><code>agent</code>  的作用是：你本次的构建在哪个 Jenkins 服务器实例上执行。因此 <code>agent</code> 部分有以下参数可选择。</p>
<ul>
<li><p><strong>any</strong>：该参数表示当前构建任务可在任意可用 Jenkins 节点上运行；</p>
</li>
<li><p><strong>none</strong>：当为 none 时，在 stage 阶段中时必须指定  Jenkins 服务器实例，否则报错；</p>
</li>
<li><p><strong>label</strong>：在指定的 Jenkins 标签节点运行（前提是你已经为你的 Jenkins 实例设置了标签）；</p>
</li>
<li><p><strong>node</strong>：该参数支持自定义流水线工作目录（<code>即 workspace 目录</code>）；</p>
</li>
<li><p><strong>docker</strong>：可使用 docker 在指定的 <code>pipeline &#123;&#125;</code> 或 <code>stage() &#123;&#125;</code> 中执行；</p>
</li>
<li><p><strong>dockerfile</strong>：可使用 dockerfile 在指定的 <code>pipeline &#123;&#125;</code> 或 <code>stage() &#123;&#125;</code> 中执行；</p>
</li>
<li><p><strong>kubernetes</strong>：应用于 K8s 中</p>
</li>
</ul>
<h4 id="2-1-2-案例"><a href="#2-1-2-案例" class="headerlink" title="2.1.2 案例"></a>2.1.2 案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例1</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">	agent any</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例2</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">	agent none</span><br><span class="line">	stages &#123;</span><br><span class="line">		stage(&#x27;build&#x27;) &#123;</span><br><span class="line">			agent your_Jenkins_labelname</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例3</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">	agent &#123; label &quot;your_Jenkins_labelname&quot; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例4</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123; </span><br><span class="line">     node &#123;</span><br><span class="line">        label &quot;your_Jenkins_labelname&quot;,</span><br><span class="line">        customWorkspace &quot;/data/jenkins_agent/workspace&quot;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例5</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">	agent &#123;</span><br><span class="line">		docker &#123;</span><br><span class="line">			image &#x27;maven:3.8.1-adoptopenjdk-11&#x27;</span><br><span class="line">			label &#x27;your_Jenkins_labelname&#x27;</span><br><span class="line">			args  &#x27;-v /tmp:/tmp&#x27;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例6</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        // Equivalent to &quot;docker build -f Dockerfile.build --build-arg version=1.0.2 ./build/</span><br><span class="line">        dockerfile &#123;</span><br><span class="line">            filename &#x27;Dockerfile.build&#x27;</span><br><span class="line">            dir &#x27;build&#x27;</span><br><span class="line">            label &#x27;your_Jenkins_labelname&#x27;</span><br><span class="line">            additionalBuildArgs  &#x27;--build-arg version=1.0.2&#x27;</span><br><span class="line">            args &#x27;-v /tmp:/tmp&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例7</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        kubernetes &#123;</span><br><span class="line">            defaultContainer &#x27;kaniko&#x27;</span><br><span class="line">            yaml &#x27;&#x27;&#x27;</span><br><span class="line">    kind: Pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kaniko</span><br><span class="line">        image: gcr.io/kaniko-project/executor:debug</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        command:</span><br><span class="line">        - sleep</span><br><span class="line">        args:</span><br><span class="line">        - 99d</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: aws-secret</span><br><span class="line">            mountPath: /root/.aws/</span><br><span class="line">          - name: docker-registry-config</span><br><span class="line">            mountPath: /kaniko/.docker</span><br><span class="line">      volumes:</span><br><span class="line">        - name: aws-secret</span><br><span class="line">          secret:</span><br><span class="line">            secretName: aws-secret</span><br><span class="line">        - name: docker-registry-config</span><br><span class="line">          configMap:</span><br><span class="line">            name: docker-registry-config</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单看一下 node 形式的：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724140903917.png" alt="image-20220724140903917"></p>
<h3 id="2-2-stages"><a href="#2-2-stages" class="headerlink" title="2.2 stages"></a>2.2 stages</h3><h4 id="2-2-1-说明"><a href="#2-2-1-说明" class="headerlink" title="2.2.1 说明"></a>2.2.1 说明</h4><p>stages （阶段）包含多个 stage（且至少包含一个 stage），一个 stage 中包含一个 steps（步骤-且只包含一个 steps）</p>
<h4 id="2-2-2-案例"><a href="#2-2-2-案例" class="headerlink" title="2.2.2 案例"></a>2.2.2 案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">	agent any</span><br><span class="line">	stages &#123;</span><br><span class="line">		stage(&#x27;build&#x27;) &#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				script &#123;</span><br><span class="line">					println(&#x27;build your project !&#x27;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如何嵌套脚本式语法？</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当我们引用 script &#123;&#125; 时，就可以在该部分中引入脚本时语法（比如<span class="keyword">for</span>循环、<span class="keyword">if</span>判断等等）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">script &#123;&#125; 紧跟 steps，然后所有的脚本式语法就在 script &#123;...&#125; 中执行</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">错误书写方式如下：</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">	agent any</span><br><span class="line">	stages &#123;</span><br><span class="line">		stage(&#x27;build&#x27;) &#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				echo &#x27;hello world&#x27;</span><br><span class="line">				script &#123;</span><br><span class="line">					println(&#x27;build your project !&#x27;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正确书写方式如下：</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">	agent any</span><br><span class="line">	stages &#123;</span><br><span class="line">		stage(&#x27;build&#x27;) &#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				script &#123;</span><br><span class="line">					echo &#x27;hello world&#x27;</span><br><span class="line">					println(&#x27;build your project !&#x27;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724141744321.png" alt="image-20220724141744321"></p>
<h3 id="2-3-post"><a href="#2-3-post" class="headerlink" title="2.3 post"></a>2.3 post</h3><h4 id="2-3-1-说明"><a href="#2-3-1-说明" class="headerlink" title="2.3.1 说明"></a>2.3.1 说明</h4><p><code>post</code> 部分是流水线构建后的相关操作步骤，其包含五个状态参数。</p>
<ul>
<li><strong>always</strong>：不管构建成功、失败还是取消都执行该部分操作；</li>
<li><strong>success</strong>：只有构建成功后才执行该部分操作；</li>
<li><strong>failure</strong>：只有构建失败后才执行该部分操作；</li>
<li><strong>aborted</strong>：只有构建中途取消构建后才执行该部分；</li>
<li><strong>unstable</strong>：构建不稳定时执行该部分。</li>
</ul>
<p>⚠注意：<code>post</code> 部分与 <code>stages</code>  处于同级。</p>
<h4 id="2-3-2-案例"><a href="#2-3-2-案例" class="headerlink" title="2.3.2 案例"></a>2.3.2 案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">	agent any</span><br><span class="line">	stages &#123;</span><br><span class="line">		stage(&#x27;build&#x27;) &#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				script &#123;</span><br><span class="line">					println(&#x27;build your project !&#x27;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	post &#123;</span><br><span class="line">		success &#123;</span><br><span class="line">			echo &#x27;build success&#x27;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724143856442.png" alt="image-20220724143856442"></p>
<h3 id="2-4-环境变量"><a href="#2-4-环境变量" class="headerlink" title="2.4 环境变量"></a>2.4 环境变量</h3><p>我们可以通过 <code>environment</code> 来设置环境变量。</p>
<h4 id="2-4-1-预定义变量"><a href="#2-4-1-预定义变量" class="headerlink" title="2.4.1 预定义变量"></a>2.4.1 预定义变量</h4><p>1、说明</p>
<p>预定义变量也就是我们 Jenkins 内部默认存在且可用的变量，属于全局 变量，即该类型的变量<code>可在 Pipeline 中全局或局部引用</code>。如何查看 Jenkins 的预定义变量？可在 <code>Jenkins 流水线语法</code> 部分中查看，如下图，每一个变量都有相应的解释。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724144355604.png" alt="image-20220724144355604"></p>
<p>2、如何引用预定义变量</p>
<p>对于预定义变量或全局变量，引用方式为：<code>$&#123;env.变量名&#125;</code></p>
<h4 id="2-4-2-自定义变量"><a href="#2-4-2-自定义变量" class="headerlink" title="2.4.2 自定义变量"></a>2.4.2 自定义变量</h4><p>自定义变量也可以定义全局变量与局部变量。</p>
<p>1、自定义全局变量</p>
<blockquote>
<p>与 <code>stages &#123;&#125;</code> 同级的自定义变量属于全局变量，在流水线脚本中各阶段中可全局或局部引用。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123;</span><br><span class="line">        PROJECT = &quot;cms&quot;</span><br><span class="line">        VERSION = &quot;v1.0.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;$&#123;env.PROJECT&#125;&quot;</span><br><span class="line">                // 或 echo &quot;$&#123;PROJECT&#125;&quot; 都是可以的</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo &#x27;build success&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724145832755.png" alt="image-20220724145832755"></p>
<p>2、自定义局部变量</p>
<blockquote>
<p>定义于 <code>stage(&#39;...&#39;) &#123;&#125;</code> 下的变量我们称之为局部变量，该变量只能在其所处的阶段步骤中引用。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;build&#x27;) &#123;</span><br><span class="line">            environment &#123;</span><br><span class="line">                PROJECT = &quot;cms&quot;</span><br><span class="line">                VERSION = &quot;v1.0.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;$&#123;VERSION&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo &#x27;build success&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724154749312.png" alt="image-20220724154749312"></p>
<p>如果你在其他 stage 阶段引用时，是获取不到该变量值的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;build&#x27;) &#123;</span><br><span class="line">            environment &#123;</span><br><span class="line">                PROJECT = &quot;cms&quot;</span><br><span class="line">                VERSION = &quot;v1.0.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;$&#123;VERSION&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;depro&#x27;) &#123;</span><br><span class="line">        	steps &#123;</span><br><span class="line">        		echo &quot;$&#123;VERSION&#125;&quot;</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo &#x27;build success&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724155044976.png" alt="image-20220724155044976"></p>
<p>除非你定义了全局变量，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123;</span><br><span class="line">    NAME = &quot;rab&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;build&#x27;) &#123;</span><br><span class="line">            environment &#123;</span><br><span class="line">                PROJECT = &quot;cms&quot;</span><br><span class="line">                VERSION = &quot;v1.0.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;$&#123;VERSION&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;depro&#x27;) &#123;</span><br><span class="line">        	steps &#123;</span><br><span class="line">        		echo &quot;$&#123;NAME&#125;&quot;</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo &#x27;build success&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724155259349.png" alt="image-20220724155259349"></p>
<p>&#x3D;&#x3D;再次来看看定义变量的方法：&#x3D;&#x3D;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def PROJECT = cms</span><br><span class="line">String NAME = rab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以上这两种写法是一样，def可以自动推导出变量类型，而String这种写法是精确这个变量是一个字符串类型的。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">全局变量的定义方式</span></span><br><span class="line">env.NAME = rab</span><br></pre></td></tr></table></figure>

<h3 id="2-5-credentials"><a href="#2-5-credentials" class="headerlink" title="2.5 credentials"></a>2.5 credentials</h3><h4 id="2-5-1-说明"><a href="#2-5-1-说明" class="headerlink" title="2.5.1 说明"></a>2.5.1 说明</h4><p><code>credentials</code> 可用于在 Jenkins 环境中通过标识符访问预定义的凭证。在 <code>environment</code> 中，我们经常使用 <code>credentials</code> 方法来对敏感密钥&#x2F;密码进行加密。</p>
<ul>
<li><p><strong>Secret Text 类型的凭证</strong></p>
<p><code>credentials()</code> 将确保指定的环境变量包含秘密文本内容。</p>
</li>
<li><p><strong>SStandard username and password 类型的凭证</strong></p>
<p>指定的环境变量指定为 <code>username:password</code> ，并且两个额外的环境变量将被自动定义：分别为 <code>MYVARNAME_USR</code> 和 <code>MYVARNAME_PSW</code> 。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123; </span><br><span class="line">        CC = &#x27;clang&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Example&#x27;) &#123;</span><br><span class="line">            environment &#123; </span><br><span class="line">                REMOTE_HOST = credentials(&#x27;remote-host&#x27;) </span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;printenv&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">credentials 填的是凭证的唯一ID标识值</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此时你就可以在 stage(<span class="string">&#x27;Example&#x27;</span>) &#123;&#125; 阶段中引用相关变量参数了（REMOTE_HOST_PSW和REMOTE_HOST_USR）</span></span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724171024606.png" alt="image-20220724171024606"></p>
<h4 id="2-5-2-案例"><a href="#2-5-2-案例" class="headerlink" title="2.5.2 案例"></a>2.5.2 案例</h4><p>1、<code>Secret Text</code> 类型的凭证</p>
<p>这个比较简单，一般用于以文本形式加密密码、Token 等敏感信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123; </span><br><span class="line">        CC = &#x27;clang&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Example&#x27;) &#123;</span><br><span class="line">            environment &#123; </span><br><span class="line">                REMOTE_HOST_TOKEN = credentials(&#x27;test-secret-text&#x27;) </span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;printenv&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724184105358.png" alt="image-20220724184105358"></p>
<p>2、<code>SStandard username and password</code> 类型的凭证</p>
<blockquote>
<p>如果想以密钥形式登录远程服务器，可采用 <code>withCredentials() &#123;&#125;</code> 函数（方法）</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123; </span><br><span class="line">        CC = &#x27;clang&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;remote_host&#x27;) &#123;</span><br><span class="line">            environment &#123; </span><br><span class="line">                REMOTE_HOST = credentials(&#x27;remote-host&#x27;) </span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    sh &#x27;printenv&#x27;</span><br><span class="line">                    def remote = [:]</span><br><span class="line">                    remote.name = &quot;192.168.56.133&quot;</span><br><span class="line">                    remote.host = &quot;192.168.56.133&quot;</span><br><span class="line">                    remote.user = &quot;$&#123;REMOTE_HOST_USR&#125;&quot;</span><br><span class="line">                    remote.port = 22</span><br><span class="line">                    remote.password = &quot;$&#123;REMOTE_HOST_PSW&#125;&quot;</span><br><span class="line">                    remote.allowAnyHosts = true</span><br><span class="line">                    sshCommand remote: remote, command: &quot;ls -a&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724180206647.png" alt="image-20220724180206647"></p>
<p>来到 133 这台服务器上验证看看，是不是有这几个文件：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724180407114.png" alt="image-20220724180407114"></p>
<h3 id="2-6-options"><a href="#2-6-options" class="headerlink" title="2.6 options"></a>2.6 options</h3><h4 id="2-6-1-说明"><a href="#2-6-1-说明" class="headerlink" title="2.6.1 说明"></a>2.6.1 说明</h4><p>该选项参数可控制 Jenkins 构建超时时间、构建重试次数、禁止并行构建等。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">	// 保存最近的记录（保留1份）</span><br><span class="line">	buildDiscarder(logRotator(numToKeepStr: &#x27;1&#x27;))</span><br><span class="line">	// 禁止并行构建</span><br><span class="line">	disableConcurrentBuilds()</span><br><span class="line">	// 跳过默认的代码检出</span><br><span class="line">	skipDefaultCheckout()</span><br><span class="line">	// 设定流水线的超时时间(可用于阶段级别)</span><br><span class="line">	timeout(time: 1, unit: &#x27;HOURS&#x27;)</span><br><span class="line">	// 设定流水线的重试次数(可用于阶段级别)</span><br><span class="line">	retry(3)</span><br><span class="line">	// 设置日志时间输出(可用于阶段级别)</span><br><span class="line">	timestamps()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-6-2-案例"><a href="#2-6-2-案例" class="headerlink" title="2.6.2 案例"></a>2.6.2 案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;build&#x27;) &#123;</span><br><span class="line">            environment &#123;</span><br><span class="line">                PROJECT = &quot;cms&quot;</span><br><span class="line">                VERSION = &quot;v1.0.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            options &#123;</span><br><span class="line">            	timestamps()</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;$&#123;VERSION&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo &#x27;build success&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724163227712.png" alt="image-20220724163227712"></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724163409911.png" alt="image-20220724163409911"></p>
<h3 id="2-7-parameters"><a href="#2-7-parameters" class="headerlink" title="2.7 parameters"></a>2.7 parameters</h3><h4 id="2-7-1-说明"><a href="#2-7-1-说明" class="headerlink" title="2.7.1 说明"></a>2.7.1 说明</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串类型</span></span><br><span class="line">string(name: &#x27;&#x27;, defaultvalue: &#x27;&#x27;, description: &#x27;&#x27;)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文本类型</span></span><br><span class="line">text(name: &#x27;&#x27;, defaultvalue: &#x27;&#x27;, description: &#x27;&#x27;)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">布尔类型</span></span><br><span class="line">booleanParam(name: &#x27;&#x27;, defaultvalue: &#x27;&#x27;, description: &#x27;&#x27;)  --&gt; true/false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选项类型（只可选择一项）</span></span><br><span class="line">choice(name: &#x27;&#x27;, choices: [&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;], description: &#x27;&#x27;)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">扩展选项类型（可选择多项，需安装扩展插件）</span></span><br><span class="line">extendedChoice(name: &#x27;&#x27;, description: &#x27;&#x27;, multiSelectDelimiter: &#x27;,&#x27;, quoteValue: false, saveJSONParameterToFile: false, type: &#x27;PT_CHECKBOX&#x27;, value: &#x27;a,b,c,...&#x27;, visibleItemCount: 10)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码类型</span></span><br><span class="line">password(name:&#x27;&#x27;, defaultvalue:&#x27;&#x27;, description:&#x27;&#x27;)</span><br></pre></td></tr></table></figure>

<p>注意：extendedChoice 类型参数需要安装下面插件：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724173732718.png" alt="image-20220724173732718"></p>
<h4 id="2-7-2-案例"><a href="#2-7-2-案例" class="headerlink" title="2.7.2 案例"></a>2.7.2 案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    parameters &#123;</span><br><span class="line">        string(name: &#x27;A&#x27;, defaultValue: &#x27;A-string&#x27;, description: &#x27;this is string&#x27;)</span><br><span class="line">        text(name: &#x27;B&#x27;, defaultValue: &#x27;B-text&#x27;, description: &#x27;this is text&#x27;)</span><br><span class="line">        booleanParam(name: &#x27;C&#x27;, defaultValue: &#x27;true&#x27;, description: &#x27;this is booleanParam&#x27;)</span><br><span class="line">        choice(name:&#x27;D&#x27;, choices:[&#x27;dev&#x27;,&#x27;ops&#x27;,&#x27;master&#x27;], description: &#x27;this is choice&#x27;)</span><br><span class="line">        extendedChoice(name: &#x27;&#x27;, description: &#x27;this is extendedChoice&#x27;, multiSelectDelimiter: &#x27;,&#x27;, quoteValue: false, saveJSONParameterToFile: false, type: &#x27;PT_CHECKBOX&#x27;, value: &#x27;a,b,c,...&#x27;, visibleItemCount: 10)</span><br><span class="line">        password(name: &#x27;E&#x27;, defaultValue: &#x27;E-password&#x27;, description: &#x27;this is password&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Hello&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Hello World&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;myparamters&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;hello $&#123;params.A&#125;&quot;</span><br><span class="line">                echo &quot;hello $&#123;params.B&#125;&quot;</span><br><span class="line">                echo &quot;hello $&#123;params.C&#125;&quot;</span><br><span class="line">                echo &quot;hello $&#123;params.D&#125;&quot;</span><br><span class="line">                echo &quot;hello $&#123;params.E&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数化界面：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724174328712.png" alt="image-20220724174328712"></p>
<p>构建结果：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724174537039.png" alt="image-20220724174537039"></p>
<h3 id="2-8-triggers"><a href="#2-8-triggers" class="headerlink" title="2.8 triggers"></a>2.8 triggers</h3><h4 id="2-8-1-说明"><a href="#2-8-1-说明" class="headerlink" title="2.8.1 说明"></a>2.8.1 说明</h4><p><code>triggers</code> 为流水线触发方式，一般用于 webhook 集成：</p>
<ul>
<li>cron 定时触发：<code>triggers &#123; cron(&#39;H */4 * * 1-5&#39;) &#125;</code></li>
<li>pollSCM：<code>triggers &#123; pollSCM(&#39;H */4 * * 1-5&#39;) &#125;</code></li>
</ul>
<p>⚠注意：<code>pollSCM</code> 触发器仅在 <code>Jenkins 2.22</code> 或更高版本中可用。</p>
<h4 id="2-8-2-案例"><a href="#2-8-2-案例" class="headerlink" title="2.8.2 案例"></a>2.8.2 案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    triggers &#123;</span><br><span class="line">        cron(&#x27;H/1 * * * 1-5&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">    environment &#123;</span><br><span class="line">        PROJECT = &quot;cms&quot;</span><br><span class="line">        VERSION = &quot;v1.0.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;$&#123;PROJECT&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo &#x27;build success&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于计划任务具体详细解释，可以看官方文档——<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jenkins.io/doc/book/pipeline/syntax/">计划任务</a></p>
</blockquote>
<h3 id="2-9-input"><a href="#2-9-input" class="headerlink" title="2.9 input"></a>2.9 input</h3><h4 id="2-9-1-说明"><a href="#2-9-1-说明" class="headerlink" title="2.9.1 说明"></a>2.9.1 说明</h4><p><code>input</code> 在流水线中作为交互式应用，应用于 <code>steps &#123;&#125;</code> 前，并在<code>steps &#123;&#125;</code> 执行前暂停。如果 <code>input</code> 为同意继续执行，那将会继续执行 <code>steps &#123;&#125;</code> 部分，否则取消。</p>
<p>配置选项：</p>
<ul>
<li>message：自定义信息（该选项是必须存在的）；</li>
<li>id：可选 input 标识符（默认为 stage 名称）;</li>
<li>ok：表单上“确定”按钮（继续&#x2F;取消）；</li>
<li>submitter：提交者；</li>
<li>parameters：提示提交者提供的可选参数列表。</li>
</ul>
<h4 id="2-9-2-案例"><a href="#2-9-2-案例" class="headerlink" title="2.9.2 案例"></a>2.9.2 案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Example&#x27;) &#123;</span><br><span class="line">            input &#123;</span><br><span class="line">                message &quot;Should we continue?&quot;</span><br><span class="line">                id &quot;deploy&quot;</span><br><span class="line">                ok &quot;Yes, we should.&quot;</span><br><span class="line">                submitter &quot;alice&quot;</span><br><span class="line">                parameters &#123;</span><br><span class="line">                    string(name: &#x27;PERSON&#x27;, defaultValue: &#x27;Mr Jenkins&#x27;, description: &#x27;my test&#x27;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;Hello, $&#123;PERSON&#125;, nice to meet you.&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220725163538813.png" alt="image-20220725163538813"></p>
<blockquote>
<p>点击【Yes, we should.】则继续执行 <code>steps &#123;&#125;</code> 部分；</p>
<p>点击【Abort】则取消执行该阶段的 <code>steps &#123;&#125;</code> 部分，如下图：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220725163754347.png" alt="image-20220725163754347"></p>
</blockquote>
<h3 id="2-10-when"><a href="#2-10-when" class="headerlink" title="2.10 when"></a>2.10 when</h3><h4 id="2-10-1-说明"><a href="#2-10-1-说明" class="headerlink" title="2.10.1 说明"></a>2.10.1 说明</h4><p>这是声明式语法中的条件判断语句，而在脚本式语法中使用的是 <code>if</code> 判断。该指令主要是根据给定的条件来选择是否继续执行 <code>stage 阶段</code>  部分，只有所有条件都返回 <code>true</code> 才能执行阶段，否则跳过该阶段。</p>
<p>常用选项参数：</p>
<ul>
<li>branch：仅适用于多分支管道。<code>when &#123; branch &#39;master&#39; &#125;</code></li>
<li>environment：当指定环境变量设置为给定值时执行该阶段。<code>when &#123; environment name: &#39;DEPLOY_TO&#39;, value: &#39;production&#39; &#125;</code></li>
<li>expression：表达式返回结果为 true 时执行该阶段。<code>when &#123; expression &#123; return params.DEBUG_BUILD &#125; &#125;</code> 返回结果必须为布尔型（true&#x2F;null），简单地返回“0”或“false”仍将评估为“true”。</li>
</ul>
<p>常用判断参数：</p>
<ul>
<li>not：<code>when &#123; not &#123; branch &#39;master&#39; &#125; &#125;</code>，表示：当分支不是 master 的时候，执行 steps。</li>
<li>allOf：<code>when &#123; allOf &#123; branch &#39;master&#39;; environment name: &#39;DEPLOY_TO&#39;, value: &#39;production&#39; &#125; &#125;</code> 当所有都满足条件时才执行 steps。</li>
<li>anyOf：<code>when &#123; anyOf &#123; branch &#39;master&#39;; branch &#39;staging&#39; &#125; &#125;</code>，只要有一个条件成立了才会执行 steps。</li>
</ul>
<h4 id="2-10-2-案例"><a href="#2-10-2-案例" class="headerlink" title="2.10.2 案例"></a>2.10.2 案例</h4><ul>
<li><p>单一条件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Example Build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Hello World&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Example Deploy&#x27;) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                branch &#x27;main&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Deploying&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>多条件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Example Build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Hello World&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Example Deploy&#x27;) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                branch &#x27;production&#x27;</span><br><span class="line">                environment name: &#x27;DEPLOY_TO&#x27;, value: &#x27;production&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Deploying&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>嵌套条件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Example Build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Hello World&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Example Deploy&#x27;) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                allOf &#123;</span><br><span class="line">                    branch &#x27;production&#x27;</span><br><span class="line">                    environment name: &#x27;DEPLOY_TO&#x27;, value: &#x27;production&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Deploying&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>多重条件和嵌套条件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Example Build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Hello World&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Example Deploy&#x27;) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                branch &#x27;production&#x27;</span><br><span class="line">                anyOf &#123;</span><br><span class="line">                    environment name: &#x27;DEPLOY_TO&#x27;, value: &#x27;production&#x27;</span><br><span class="line">                    environment name: &#x27;DEPLOY_TO&#x27;, value: &#x27;staging&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Deploying&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>表达式条件和嵌套条件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Example Build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Hello World&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Example Deploy&#x27;) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                expression &#123; BRANCH_NAME ==~ /(production|staging)/ &#125;</span><br><span class="line">                anyOf &#123;</span><br><span class="line">                    environment name: &#x27;DEPLOY_TO&#x27;, value: &#x27;production&#x27;</span><br><span class="line">                    environment name: &#x27;DEPLOY_TO&#x27;, value: &#x27;staging&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Deploying&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-11-parallel"><a href="#2-11-parallel" class="headerlink" title="2.11 parallel"></a>2.11 parallel</h3><h4 id="2-11-1-说明"><a href="#2-11-1-说明" class="headerlink" title="2.11.1 说明"></a>2.11.1 说明</h4><p>一个阶段必须有且只有一个 <code>steps</code>、<code>stages</code>、<code>parallel</code>或<code>matrix</code>。该部分可应用于自动化测试及多主机并行发布。</p>
<h4 id="2-11-2-案例"><a href="#2-11-2-案例" class="headerlink" title="2.11.2 案例"></a>2.11.2 案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">	agent any</span><br><span class="line">	stages &#123;</span><br><span class="line">		// 这个stage只能有一个parallel</span><br><span class="line">		stage( &#x27;Parallel stage&#x27;) &#123;</span><br><span class="line">			failFast true</span><br><span class="line">			parallel &#123;</span><br><span class="line">				stage( &#x27;windows&#x27; ) &#123;</span><br><span class="line">					steps &#123;</span><br><span class="line">						echo &quot;windows&quot;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				stage( &#x27;linux&#x27; ) &#123;</span><br><span class="line">					steps &#123;</span><br><span class="line">						echo &quot;linux&quot;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		// 这个stage同样也只能有一个parallel</span><br><span class="line">		stage( &#x27;Parallel stage 1&#x27;) &#123;</span><br><span class="line">			failFast true</span><br><span class="line">			parallel &#123;</span><br><span class="line">				stage( &#x27;windows-1&#x27; ) &#123;</span><br><span class="line">					steps &#123;</span><br><span class="line">						echo &quot;windows-1&quot;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				stage( &#x27;linux-1&#x27; ) &#123;</span><br><span class="line">					steps &#123;</span><br><span class="line">						echo &quot;linux-1&quot;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220725172122718.png" alt="image-20220725172122718"></p>
<h3 id="2-12-DSL"><a href="#2-12-DSL" class="headerlink" title="2.12 DSL"></a>2.12 DSL</h3><h4 id="2-12-1-JSON-数据格式解析"><a href="#2-12-1-JSON-数据格式解析" class="headerlink" title="2.12.1 JSON 数据格式解析"></a>2.12.1 JSON 数据格式解析</h4><p>1、所需插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pipeline Utils Steps</span><br></pre></td></tr></table></figure>

<p>2、流水线配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 插件方式配置</span><br><span class="line">def response = readJSON text: &quot;$&#123;scanResult&#125;&quot;</span><br><span class="line">println(scanResult)</span><br><span class="line"></span><br><span class="line">// 原生方法配置</span><br><span class="line">import groovy .json.*</span><br><span class="line">@NonCPs</span><br><span class="line">def Getson(text)&#123;</span><br><span class="line">	def prettyJson = sonoutput.prettyPrint(text)</span><br><span class="line">	new sonslurperClassic( ).parseText(prettyson)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-2-使用凭据"><a href="#2-12-2-使用凭据" class="headerlink" title="2.12.2 使用凭据"></a>2.12.2 使用凭据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">withcredentials([string(credentialsId: &quot;xxxxx&quot;， variable: &quot;sonarToken&quot;)])&#123;</span><br><span class="line">	println(sonarToken)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体如何生产，可以参考 Jenkins 自带的<code>片段生成器</code></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220725174748559.png" alt="image-20220725174748559"></p>
<h4 id="2-12-3-代码管理"><a href="#2-12-3-代码管理" class="headerlink" title="2.12.3 代码管理"></a>2.12.3 代码管理</h4><p>1、git</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">checkout([$</span><span class="language-bash">class: <span class="string">&#x27;GitsCM&#x27;</span>, branches: [[name: <span class="string">&quot;brnachName&quot;</span>]],</span></span><br><span class="line">			doGenerateSubmoduleconfigurations: false,</span><br><span class="line">			extensions: [], submoduleCfg: [],</span><br><span class="line">			userRemoteConfigs: [[credentialsId: &quot;$&#123;credentialsId&#125;&quot;,</span><br><span class="line">			url: &quot;$&#123;srcUrl&#125;&quot;]]])</span><br></pre></td></tr></table></figure>

<p>2、svn</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">checkout([$</span><span class="language-bash">class: <span class="string">&#x27;subversionscM&#x27;</span> , additionalCredentials: [],</span></span><br><span class="line">			filterChangelog: false，ignoreDirPropChanges: false,</span><br><span class="line">			locations: [[credentialsId: &quot;$&#123;credentialsId&#125;&quot;,</span><br><span class="line">			depthoption: &#x27;infinity&#x27;, ignoreExternalsoption: true,</span><br><span class="line">			remote: &quot;$&#123;svnurl]&quot;]]，</span><br><span class="line">			workspaceUpdater: [$class: &#x27;checkoutUpdater&#x27;]]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="2-12-4-HTML-报告展示"><a href="#2-12-4-HTML-报告展示" class="headerlink" title="2.12.4 HTML 报告展示"></a>2.12.4 HTML 报告展示</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">publishHTML([allowMissing: false,</span><br><span class="line">		alwaysLinkToLastBuild: false,keepAll: true,</span><br><span class="line">		reportDir: &#x27;./report/&#x27;,</span><br><span class="line">		reportFiles: &quot;a.htm1, b.html&quot;,</span><br><span class="line">		reportName: &#x27;TnterfaceTestReport&#x27;,</span><br><span class="line">		reportTitles: &#x27;HTML&#x27;])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-12-5-获取管道构建用户"><a href="#2-12-5-获取管道构建用户" class="headerlink" title="2.12.5 获取管道构建用户"></a>2.12.5 获取管道构建用户</h4><p>1、所需插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build user vars</span><br></pre></td></tr></table></figure>

<p>2、流水线配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">wrap([$</span><span class="language-bash">class: <span class="string">&#x27;BuildUser&#x27;</span>])&#123;</span></span><br><span class="line">		echo &quot;full name is $BUILD_USER&quot;</span><br><span class="line">		echo &quot;user id is $BUTLD_USER_ID&quot;</span><br><span class="line">		echo &quot;user email is $BUILD_USER_EMAIL&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-6-使用-HttpRequest-发起请求"><a href="#2-12-6-使用-HttpRequest-发起请求" class="headerlink" title="2.12.6 使用 HttpRequest 发起请求"></a>2.12.6 使用 HttpRequest 发起请求</h4><p>1、所需插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP Request</span><br></pre></td></tr></table></figure>

<p>2、流水线配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ApiUrl = &quot;http://xxxxxx/api/project_branches/list?project=$&#123;projectName&#125;&quot;</span><br><span class="line">Result = httpRequest authentication : &#x27;xxxxxxxxx &#x27;,</span><br><span class="line">					quiet : true,</span><br><span class="line">					contentType:&#x27;APPLICATION_JSON&#x27;,</span><br><span class="line">					url: &quot;$&#123;ApiUrl&#125;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="2-12-7-获取-Shell-返回值"><a href="#2-12-7-获取-Shell-返回值" class="headerlink" title="2.12.7 获取 Shell 返回值"></a>2.12.7 获取 Shell 返回值</h4><p>1、无需获取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pipeline&#123;</span><br><span class="line">  // 主要阶段以及子阶段流程</span><br><span class="line">  stages &#123;</span><br><span class="line">    // [ 阶段.shell命令执行测试 ]</span><br><span class="line">    stage (&#x27;代码拉取&#x27;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        // 最简单的方式</span><br><span class="line">        sh &#x27;whoami &amp;&amp; uname -a&#x27;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728182527543.png" alt="image-20220728182527543"></p>
<p>2、获取标准输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//第一种</span><br><span class="line">result = sh returnStdout: true ,script: &quot;&lt;shell command&gt;&quot;</span><br><span class="line">result = result.trim()</span><br><span class="line"></span><br><span class="line">//第二种</span><br><span class="line">result = sh(script: &quot;&lt;shell command&gt;&quot;, returnStdout: true).trim()</span><br><span class="line"></span><br><span class="line">//第三种</span><br><span class="line">sh &quot;&lt;shell command&gt; &gt; commandResult&quot;</span><br><span class="line">result = readFile(&#x27;commandResult&#x27;).trim()</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728182611577.png" alt="image-20220728182611577"></p>
<p>3、获取执行状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//第一种</span><br><span class="line">result = sh returnStatus: true ,script: &quot;&lt;shell command&gt;&quot;</span><br><span class="line">result = result.trim()</span><br><span class="line"></span><br><span class="line">//第二种</span><br><span class="line">result = sh(script: &quot;&lt;shell command&gt;&quot;, returnStatus: true).trim()</span><br><span class="line"></span><br><span class="line">//第三种</span><br><span class="line">sh &#x27;&lt;shell command&gt;; echo $? &gt; status&#x27;</span><br><span class="line">def r = readFile(&#x27;status&#x27;).trim()</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728182645235.png" alt="image-20220728182645235"></p>
<p>&#x3D;&#x3D;trim() 方法说明：&#x3D;&#x3D;</p>
<p>该方法用于删除字符串的头尾空白符。空白符包括：空格、制表符 tab、换行符等其他空白符等, 在 Jenkins 流水线中非常重要，因为命令执行后总是会在其末尾添加一个换行符。</p>
<h2 id="三、共享库"><a href="#三、共享库" class="headerlink" title="三、共享库"></a>三、共享库</h2><h3 id="3-1-创建共享库"><a href="#3-1-创建共享库" class="headerlink" title="3.1 创建共享库"></a>3.1 创建共享库</h3><p>1、创建项目仓库</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723150155668.png" alt="image-20220723150155668"></p>
<p>2、添加目录&#x2F;文件</p>
<ul>
<li>点击 <code>Web IDE</code></li>
</ul>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723151049250.png" alt="image-20220723151049250"></p>
<ul>
<li><p>创建目录</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723150944708.png" alt="image-20220723150944708"></p>
</li>
<li><p>添加文件</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723152123651.png"></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723152250816.png" alt="image-20220723152250816"></p>
</li>
</ul>
<p>3、将定义好的方法提交到代码仓库</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723152849499.png" alt="image-20220723152849499"></p>
<h3 id="3-2-加载共享库"><a href="#3-2-加载共享库" class="headerlink" title="3.2 加载共享库"></a>3.2 加载共享库</h3><p>1、流水线脚本加载共享库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 加载共享库，其中jenkinslib要与Jenkins系统配置中保持一致（jenkinslib可自定义），@amin表示共享库所在分支</span><br><span class="line">@Library(&quot;jenkinslib@main&quot;) _</span><br><span class="line">// 导入jenkinsfile.groovy。这里要注意：下面的jenkinsfile()名字必须与你共享库中jenkinsfile.groovy名一致，否则报错</span><br><span class="line">def myjenkinsfile = new org.devops.jenkinsfile()</span><br><span class="line"></span><br><span class="line">// 流水线（主）</span><br><span class="line">pipeline &#123;</span><br><span class="line">	agent any</span><br><span class="line">	tools &#123;</span><br><span class="line">		git &#x27;git&#x27;</span><br><span class="line">	&#125;</span><br><span class="line">	stages &#123;</span><br><span class="line">		stage(&quot;Create Branch&quot;) &#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				script &#123;</span><br><span class="line">					// 然后就可以调用共享库中的方法了 myjenkinsfile 即为我上面引用的方法（可在上面自定义）</span><br><span class="line">					ProjectID = myjenkinsfile.GetProjectID(&quot;$&#123;env.ProjectName&#125;&quot;)</span><br><span class="line">					myjenkinsfile.CreateBranch(ProjectID, &quot;$&#123;env.NewBranchName&#125;&quot;, &quot;$&#123;env.BaseBranchName&#125;&quot;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、同样将流水线脚本也进行 Git 版本管理</p>
<blockquote>
<p>这样的话便于管理 Jenkinfile 及共享库</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723153913871.png" alt="image-20220723153913871"></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723162121271.png" alt="image-20220723162121271"></p>
<h3 id="3-3-Jenkins-配置"><a href="#3-3-Jenkins-配置" class="headerlink" title="3.3 Jenkins 配置"></a>3.3 Jenkins 配置</h3><p>1、Jenkins 流水线配置</p>
<p>因为我们的流水线脚本进行了 Git 版本管理，所以你可以在 Jenkins 流水线配置中配置 URL 即可。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723155806926.png" alt="image-20220723155806926"></p>
<p>2、Jenkins 系统配置</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723161609360.png" alt="image-20220723161609360"></p>
<h3 id="3-4-Jenkins-构建"><a href="#3-4-Jenkins-构建" class="headerlink" title="3.4 Jenkins 构建"></a>3.4 Jenkins 构建</h3><p>以上都配置好之后，接下来就开始构建了。</p>
<p>1、Jenkins 构建</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723190934794.png" alt="image-20220723190934794"></p>
<p>2、Gitlab 查看是否构建成功</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220723190856525.png" alt="image-20220723190856525"></p>
<p>&#x3D;&#x3D;至此，已实现 Jenkins 如何调用 Gitlab API 及 Jenkins 共享库的最终应用。&#x3D;&#x3D;</p>
<h3 id="3-5-扩展"><a href="#3-5-扩展" class="headerlink" title="3.5 扩展"></a>3.5 扩展</h3><blockquote>
<p>共享库加载扩展。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载testlib共享库</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享库名可自定义，但必须和Jenkins系统配置中配置的共享库名保持一致</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为Jenkins配置了共享库的git地址，如果不一致的话，在加载共享库时就会找不到共享库</span></span><br><span class="line">@Library(&#x27;testlib&#x27;) _</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载testlib共享库的1.0版本</span></span><br><span class="line">@Library(&#x27;testlib@1.0&#x27;) _</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载多个共享库</span></span><br><span class="line">@Library([&#x27;testlib&#x27;, &#x27;testlib@1.0&#x27;]) _</span><br></pre></td></tr></table></figure>

<h2 id="四、邮件配置"><a href="#四、邮件配置" class="headerlink" title="四、邮件配置"></a>四、邮件配置</h2><h3 id="4-1-Jenkins-配置"><a href="#4-1-Jenkins-配置" class="headerlink" title="4.1 Jenkins 配置"></a>4.1 Jenkins 配置</h3><p>1、安装邮件插件</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220726101813745.png" alt="image-20220726101813745"></p>
<p>2、服务器地址及相关端口</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220726103143647.png" alt="image-20220726103143647"></p>
<p>3、系统配置ZRSanqy@123</p>
<blockquote>
<p>此处我使用163邮箱来演示。</p>
</blockquote>
<ul>
<li><p>先查看163邮箱的服务器地址</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220726102038591.png" alt="image-20220726102038591"></p>
</li>
<li><p>系统配置–&gt;E-mail Notification</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220726104650219.png" alt="image-20220726104650219"></p>
</li>
<li><p>注意：上图中的 <code>Use SMTP Authentication</code> 邮件地址必须与下列地址保持一致。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220726105057878.png" alt="image-20220726105057878"></p>
</li>
</ul>
<h3 id="4-2-Jenkinsfile-配置"><a href="#4-2-Jenkinsfile-配置" class="headerlink" title="4.2 Jenkinsfile 配置"></a>4.2 Jenkinsfile 配置</h3><p>保留…后续补充</p>
<h3 id="4-3-邮件内容参考模板"><a href="#4-3-邮件内容参考模板" class="headerlink" title="4.3 邮件内容参考模板"></a>4.3 邮件内容参考模板</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>$&#123;ENV, var=&quot;JOB_NAME&quot;&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">leftmargin</span>=<span class="string">&quot;8&quot;</span> <span class="attr">marginwidth</span>=<span class="string">&quot;0&quot;</span> <span class="attr">topmargin</span>=<span class="string">&quot;8&quot;</span> <span class="attr">marginheight</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">offset</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">&quot;95%&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span>  <span class="attr">style</span>=<span class="string">&quot;font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            本邮件由系统自动发出，无需回复！<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">            各位同事，大家好，以下为$&#123;PROJECT_NAME &#125;项目构建信息<span class="tag">&lt;/<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#CC0000&quot;</span>&gt;</span>构建结果 - $&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>构建信息<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目名称 ： $&#123;PROJECT_NAME&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建编号 ： 第$&#123;BUILD_NUMBER&#125;次构建<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>触发原因： $&#123;CAUSE&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建状态： $&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建日志： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_URL&#125;console&quot;</span>&gt;</span>$&#123;BUILD_URL&#125;console<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建  Url ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_URL&#125;&quot;</span>&gt;</span>$&#123;BUILD_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>工作目录 ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;ws&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;ws<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目  Url ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>报告  Url ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;allure<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>失败用例<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> /&gt;</span></span><br><span class="line">$FAILED_TESTS<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>最近提交(#$SVN_REVISION)<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">$&#123;CHANGES_SINCE_LAST_SUCCESS, reverse=true, format=&quot;%c&quot;, changesFormat=&quot;<span class="tag">&lt;<span class="name">li</span>&gt;</span>%d [%a] %m<span class="tag">&lt;/<span class="name">li</span>&gt;</span>&quot;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">详细提交: <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;changes&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;changes<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="五、项目构建"><a href="#五、项目构建" class="headerlink" title="五、项目构建"></a>五、项目构建</h2><h3 id="5-1-前端项目"><a href="#5-1-前端项目" class="headerlink" title="5.1 前端项目"></a>5.1 前端项目</h3><h4 id="5-1-1-npm"><a href="#5-1-1-npm" class="headerlink" title="5.1.1 npm"></a>5.1.1 npm</h4><p>1、工具下载地址</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://nodejs.org/en/download/">官方下载地址</a></p>
<p>2、常用命令</p>
<ul>
<li>npm install &lt;模块名&gt; -g     包安装到全局；</li>
<li>npm list   查看当前已经安装的包；</li>
<li>npm config set registry <a target="_blank" rel="noopener external nofollow noreferrer" href="https://registry.npm.taobao.org/">https://registry.npm.taobao.org</a>   设置淘宝源；</li>
<li>npm config set cache “&#x2F;opt&#x2F;npmcache&#x2F;“   设置缓存路径。</li>
</ul>
<h4 id="5-1-2-yarn"><a href="#5-1-2-yarn" class="headerlink" title="5.1.2 yarn"></a>5.1.2 yarn</h4><p>facebook 取代了 npm 的包管理工具，速度快、yarn 缓存包无需重复下载，安装速度快。</p>
<p>1、安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yarn</span><br><span class="line">yarn info</span><br></pre></td></tr></table></figure>

<p>2、常用命令</p>
<ul>
<li>yarn</li>
<li>yarn install</li>
<li>yarn config set cache-folder “&#x2F;opt&#x2F;yarncache”</li>
</ul>
<h3 id="5-2-后端项目"><a href="#5-2-后端项目" class="headerlink" title="5.2 后端项目"></a>5.2 后端项目</h3><h4 id="5-2-1-mavn"><a href="#5-2-1-mavn" class="headerlink" title="5.2.1 mavn"></a>5.2.1 mavn</h4><p>1、工具下载地址</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://maven.apache.org/download.cgi">官方下载地址</a></p>
<p>2、常用命令</p>
<ul>
<li>mvn clean  清理构建目录；</li>
<li>mvn clean package  打包；</li>
<li>mvn clean install  打包部署；</li>
<li>mvn clean test  单元测试；</li>
<li>mvn clean package -f ..&#x2F;pom.xml   -f 指定 pom 文件位置；</li>
<li>mvn clean package -DskipTests   跳过单元测试；</li>
<li>mvn clean package -Dmaven.test.skip&#x3D;true   跳过单元测试；</li>
<li>mvn deploy  发布包到制品库。</li>
</ul>
<h4 id="5-2-2-gradle"><a href="#5-2-2-gradle" class="headerlink" title="5.2.2 gradle"></a>5.2.2 gradle</h4><p>gradle 基于 groovy，具有灵活强大的构建系统，能帮我们构建更复杂的项目。</p>
<p>1、工具下载地址</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://gradle.org/releases/">官方下载地址</a></p>
<p>2、常用命令</p>
<ul>
<li>gradle build  构建项目；</li>
<li>gradle build -x test  跳过单元测试；</li>
<li>gradle clean  清空构建目录。</li>
</ul>
<h4 id="5-2-3-ant"><a href="#5-2-3-ant" class="headerlink" title="5.2.3 ant"></a>5.2.3 ant</h4><p>1、工具下载地址</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://ant.apache.org/bindownload.cgi">官方下载地址</a></p>
<p>2、常用命令</p>
<ul>
<li>ant   构建；</li>
<li>ant -f ..&#x2F;build.xml   -f 指定 xml 文件。</li>
</ul>
<h3 id="5-3-Go-项目"><a href="#5-3-Go-项目" class="headerlink" title="5.3 Go 项目"></a>5.3 Go 项目</h3><p>1、工具下载地址</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://studygolang.com/dl">官方下载地址</a></p>
<p>2、常用命令</p>
<ul>
<li>go build   构建源文件；</li>
<li>go clean  清空构建目录；</li>
<li>go doc   生成 godoc 文档；</li>
<li>go install   编译并安装指定的代码包；</li>
<li>go fmt   代码格式化；</li>
<li>go get   获取一个包；</li>
<li>go run   运行一个 go 文件；</li>
<li>go test   运行测试。</li>
</ul>
<h3 id="5-4-综合案例"><a href="#5-4-综合案例" class="headerlink" title="5.4 综合案例"></a>5.4 综合案例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">// git拉取代码</span><br><span class="line">def GetCode(SrcType, BranchName, GitHttpURL) &#123;</span><br><span class="line">    if (SrcType == &quot;git&quot;) &#123;</span><br><span class="line">        println(&quot;下载代码 --&gt; 分支： $&#123;BranchName&#125;&quot;)</span><br><span class="line">        checkout([$class: &#x27;GitSCM&#x27;,</span><br><span class="line">            branches: [[name: &quot;$&#123;BranchName&#125;&quot;]],</span><br><span class="line">            extensions: [],</span><br><span class="line">            userRemoteConfigs: [[url: &quot;$&#123;GitHttpURL&#125;&quot;, credentialsId: &#x27;git-pull&#x27;,]]</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 构建类型</span><br><span class="line">def Build(BuildTools, BuildType) &#123;</span><br><span class="line">    switch(BuildType) &#123;</span><br><span class="line">        case &quot;maven&quot;:</span><br><span class="line">            sh &quot;$&#123;BuildTools[&quot;maven&quot;]&#125;/bin/mvn clean install -pl game-hall -am -Dmaven.test.skip=true -P test&quot;</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">        case &quot;gradle&quot;:</span><br><span class="line">            sh &quot;$&#123;BuildTools[&quot;gradle&quot;]&#125;/bin/gradle build -x test&quot;</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">        case &quot;npm&quot;:</span><br><span class="line">            sh &quot;&quot;&quot;$&#123;BuildTools[&quot;web&quot;]&#125;/bin/npm install &amp;&amp; $&#123;BuildTools[&quot;web&quot;]&#125;/bin/npm run build&quot;&quot;&quot;</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">        case &quot;golang&quot;:</span><br><span class="line">            sh &quot;$&#123;BuildTools[&quot;golang&quot;]&#125;/bin/go build demo.go&quot;    </span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">        default :</span><br><span class="line">            println(&quot;BuildType ==&gt; [maven|gradle|web|golang]&quot;)</span><br><span class="line">        break</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 变量定义</span><br><span class="line">// 构建工具变量（数组）</span><br><span class="line">def BuildTools = [&quot;maven&quot;: &quot;/opt/work/apache-maven-3.8.5&quot;, </span><br><span class="line">                &quot;gradle&quot;: &quot;/opt/work/gradle-6.8.3&quot;,</span><br><span class="line">                &quot;npm&quot;: &quot;/opt/work/node-v16.15.1-linux-x64&quot;,</span><br><span class="line">                &quot;yarn&quot;: &quot;/opt/work/yarn-xxx&quot;,</span><br><span class="line">                &quot;golang&quot;: &quot;/opt/work/go&quot;]</span><br><span class="line">// 构建相关变量（字符串）</span><br><span class="line">String BranchName = &quot;$&#123;env.BranchName&#125;&quot;</span><br><span class="line">String GitHttpURL = &quot;$&#123;env.GitHttpURL&#125;&quot;</span><br><span class="line">String BuildType = &quot;$&#123;env.BuildType&#125;&quot;</span><br><span class="line">String SrcType = &quot;$&#123;env.SrcType&#125;&quot;</span><br><span class="line"></span><br><span class="line">// 流水线</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    options &#123;</span><br><span class="line">        skipDefaultCheckout true</span><br><span class="line">    &#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(name: &#x27;GitHttpURL&#x27;,</span><br><span class="line">                            choices: [&#x27;ssh://git@192.168.56.133:2022/root/tq.git&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择项目URL&#x27;,)</span><br><span class="line">        gitParameter (name: &#x27;BranchName&#x27;,</span><br><span class="line">                        type: &#x27;PT_BRANCH&#x27;,</span><br><span class="line">                        branchFilter: &#x27;origin/(.*)&#x27;,</span><br><span class="line">                        defaultValue: &#x27;main&#x27;,</span><br><span class="line">                        selectedValue: &#x27;DEFAULT&#x27;,</span><br><span class="line">                        sortMode: &#x27;DESCENDING_SMART&#x27;,</span><br><span class="line">                        description: &#x27;⚠ 选择构建分支或标签&#x27;)</span><br><span class="line">        choice(name: &#x27;SrcType&#x27;,</span><br><span class="line">                            choices: [&#x27;git&#x27;, &#x27;svn&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择代码版本控制工具&#x27;,)</span><br><span class="line">        choice(name: &#x27;BuildType&#x27;,</span><br><span class="line">                            choices: [&#x27;maven&#x27;, &#x27;gradle&#x27;, &#x27;npm&#x27;, &#x27;yarn&#x27;, &#x27;goloang&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择对应构建工具&#x27;,)</span><br><span class="line">        choice(name: &#x27;SEV&#x27;,</span><br><span class="line">                            choices: [&#x27;192.168.56.133&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择测试环境内网服务器&#x27;,)</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&quot;GetCode&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    GetCode(SrcType, BranchName, GitHttpURL)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&quot;Build&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    Build(BuildTools, BuildType)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，上面的案例也可写入共享库类，具体方法查看文档<code>第三节</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// 加载共享库</span><br><span class="line">@Library([&#x27;gitscmlib@main&#x27;, &#x27;mytoolslib@main&#x27;]) _</span><br><span class="line">def Mygit = new org.devops.gitscm()</span><br><span class="line">def Mytool = new org.devops.mytools()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 变量定义</span><br><span class="line">// 构建工具变量（数组）</span><br><span class="line">def BuildTools = [&quot;maven&quot;: &quot;/opt/work/apache-maven-3.8.5&quot;, </span><br><span class="line">                &quot;gradle&quot;: &quot;/opt/work/gradle-6.8.3&quot;,</span><br><span class="line">                &quot;npm&quot;: &quot;/opt/work/node-v16.15.1-linux-x64&quot;,</span><br><span class="line">                &quot;yarn&quot;: &quot;/opt/work/yarn-xxx&quot;,</span><br><span class="line">                &quot;golang&quot;: &quot;/opt/work/go&quot;]</span><br><span class="line">// 构建相关变量（字符串）</span><br><span class="line">String BranchName = &quot;$&#123;env.BranchName&#125;&quot;</span><br><span class="line">String GitHttpURL = &quot;$&#123;env.GitHttpURL&#125;&quot;</span><br><span class="line">String BuildType = &quot;$&#123;env.BuildType&#125;&quot;</span><br><span class="line">String SrcType = &quot;$&#123;env.SrcType&#125;&quot;</span><br><span class="line"></span><br><span class="line">// 流水线</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    options &#123;</span><br><span class="line">        skipDefaultCheckout true</span><br><span class="line">    &#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(name: &#x27;GitHttpURL&#x27;,</span><br><span class="line">                            choices: [&#x27;ssh://git@192.168.56.133:2022/root/tq.git&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择项目URL&#x27;,)</span><br><span class="line">        gitParameter (name: &#x27;BranchName&#x27;,</span><br><span class="line">                        type: &#x27;PT_BRANCH&#x27;,</span><br><span class="line">                        branchFilter: &#x27;origin/(.*)&#x27;,</span><br><span class="line">                        defaultValue: &#x27;main&#x27;,</span><br><span class="line">                        selectedValue: &#x27;DEFAULT&#x27;,</span><br><span class="line">                        sortMode: &#x27;DESCENDING_SMART&#x27;,</span><br><span class="line">                        description: &#x27;⚠ 选择构建分支或标签&#x27;)</span><br><span class="line">        choice(name: &#x27;SrcType&#x27;,</span><br><span class="line">                            choices: [&#x27;git&#x27;, &#x27;svn&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择代码版本控制工具&#x27;,)</span><br><span class="line">        choice(name: &#x27;BuildType&#x27;,</span><br><span class="line">                            choices: [&#x27;maven&#x27;, &#x27;gradle&#x27;, &#x27;npm&#x27;, &#x27;yarn&#x27;, &#x27;goloang&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择对应构建工具&#x27;,)</span><br><span class="line">        choice(name: &#x27;SEV&#x27;,</span><br><span class="line">                            choices: [&#x27;192.168.56.133&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择测试环境内网服务器&#x27;,)</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&quot;GetCode&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    Mygit.GetCode(SrcType, BranchName, GitHttpURL)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&quot;Build&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    Mytool.Build(BuildTools, BuildType)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面构建时，项目名称是写死的，如何获取项目名称呢？两种方法：调用 Gitlab API、参数化选项手写。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">// git拉取代码</span><br><span class="line">def GetCode(SrcType, BranchName, GitHttpURL) &#123;</span><br><span class="line">    if (SrcType == &quot;git&quot;) &#123;</span><br><span class="line">        println(&quot;下载代码 --&gt; 分支： $&#123;BranchName&#125;&quot;)</span><br><span class="line">        checkout([$class: &#x27;GitSCM&#x27;,</span><br><span class="line">            branches: [[name: &quot;$&#123;BranchName&#125;&quot;]],</span><br><span class="line">            extensions: [],</span><br><span class="line">            userRemoteConfigs: [[url: &quot;$&#123;GitHttpURL&#125;&quot;, credentialsId: &#x27;git-pull&#x27;,]]</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 构建类型</span><br><span class="line">def Build(BuildTools, BuildType, BuildProject) &#123;</span><br><span class="line">    switch(BuildType) &#123;</span><br><span class="line">        case &quot;maven&quot;:</span><br><span class="line">        	// 这里可以加个if判断语句，来选择是构建所有包还是独立包</span><br><span class="line">            sh &quot;$&#123;BuildTools[&quot;maven&quot;]&#125;/bin/mvn clean install -pl $&#123;BuildProject&#125; -am -Dmaven.test.skip=true -P test&quot;</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">        case &quot;gradle&quot;:</span><br><span class="line">            sh &quot;$&#123;BuildTools[&quot;gradle&quot;]&#125;/bin/gradle build -x test&quot;</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">        case &quot;npm&quot;:</span><br><span class="line">            sh &quot;&quot;&quot;$&#123;BuildTools[&quot;web&quot;]&#125;/bin/npm install &amp;&amp; $&#123;BuildTools[&quot;web&quot;]&#125;/bin/npm run build&quot;&quot;&quot;</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">        case &quot;golang&quot;:</span><br><span class="line">            sh &quot;$&#123;BuildTools[&quot;golang&quot;]&#125;/bin/go build demo.go&quot;    </span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">        default :</span><br><span class="line">            println(&quot;BuildType ==&gt; [maven|gradle|web|golang]&quot;)</span><br><span class="line">        break</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 请求地址</span><br><span class="line">def HttpReq(ApiUrl, Method) &#123;</span><br><span class="line">    GitlabAPI = &quot;http://192.168.56.133/api/v4&quot;</span><br><span class="line">    withCredentials([string(credentialsId: &#x27;gitlab-create-branch&#x27;, variable: &#x27;Gitlab_Token&#x27;)]) &#123;</span><br><span class="line">        response = sh returnStdout: true, script: &quot;&quot;&quot;</span><br><span class="line">            curl --location --request $&#123;Method&#125; \</span><br><span class="line">                &quot;$&#123;GitlabAPI&#125;/$&#123;ApiUrl&#125;&quot; \</span><br><span class="line">                --header &quot;PRIVATE-TOKEN: $&#123;Gitlab_Token&#125;&quot;</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    return response</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取项目名</span><br><span class="line">def AllListRepositoryTree() &#123;</span><br><span class="line">    ApiUrl = &quot;projects/3/repository/tree&quot;</span><br><span class="line">    Method = &quot;GET&quot;</span><br><span class="line">    result = HttpReq(ApiUrl, Method)</span><br><span class="line">    result = readJSON text: result</span><br><span class="line">    return result[9][&quot;name&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 变量定义</span><br><span class="line">// 构建工具变量（数组）</span><br><span class="line">def BuildTools = [&quot;maven&quot;: &quot;/opt/work/apache-maven-3.8.5&quot;, </span><br><span class="line">                &quot;gradle&quot;: &quot;/opt/work/gradle-6.8.3&quot;,</span><br><span class="line">                &quot;npm&quot;: &quot;/opt/work/node-v16.15.1-linux-x64&quot;,</span><br><span class="line">                &quot;yarn&quot;: &quot;/opt/work/yarn-xxx&quot;,</span><br><span class="line">                &quot;golang&quot;: &quot;/opt/work/go&quot;]</span><br><span class="line">// 构建相关变量（字符串）</span><br><span class="line">String BranchName = &quot;$&#123;env.BranchName&#125;&quot;</span><br><span class="line">String GitHttpURL = &quot;$&#123;env.GitHttpURL&#125;&quot;</span><br><span class="line">String BuildType = &quot;$&#123;env.BuildType&#125;&quot;</span><br><span class="line">String SrcType = &quot;$&#123;env.SrcType&#125;&quot;</span><br><span class="line"></span><br><span class="line">// 流水线</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    options &#123;</span><br><span class="line">        skipDefaultCheckout true</span><br><span class="line">    &#125;</span><br><span class="line">    parameters &#123;</span><br><span class="line">        choice(name: &#x27;GitHttpURL&#x27;,</span><br><span class="line">                            choices: [&#x27;ssh://git@192.168.56.133:2022/root/tq.git&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择项目URL&#x27;,)</span><br><span class="line">        gitParameter (name: &#x27;BranchName&#x27;,</span><br><span class="line">                        type: &#x27;PT_BRANCH&#x27;,</span><br><span class="line">                        branchFilter: &#x27;origin/(.*)&#x27;,</span><br><span class="line">                        defaultValue: &#x27;main&#x27;,</span><br><span class="line">                        selectedValue: &#x27;DEFAULT&#x27;,</span><br><span class="line">                        sortMode: &#x27;DESCENDING_SMART&#x27;,</span><br><span class="line">                        description: &#x27;⚠ 选择构建分支或标签&#x27;)</span><br><span class="line">        choice(name: &#x27;SrcType&#x27;,</span><br><span class="line">                            choices: [&#x27;git&#x27;, &#x27;svn&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择代码版本控制工具&#x27;,)</span><br><span class="line">        choice(name: &#x27;BuildType&#x27;,</span><br><span class="line">                            choices: [&#x27;maven&#x27;, &#x27;gradle&#x27;, &#x27;npm&#x27;, &#x27;yarn&#x27;, &#x27;goloang&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择对应构建工具&#x27;,)</span><br><span class="line">        choice(name: &#x27;SEV&#x27;,</span><br><span class="line">                            choices: [&#x27;192.168.56.133&#x27;],</span><br><span class="line">                            description: &#x27;⚠ 选择测试环境内网服务器&#x27;,)</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&quot;GetCode&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    GetCode(SrcType, BranchName, GitHttpURL)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&quot;Build&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    BuildProject = AllListRepositoryTree()</span><br><span class="line">                    Build(BuildTools, BuildType, &quot;$&#123;BuildProject&#125;&quot;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，上面的流水线只有获取项目和构建项目的步骤，实际生产中还有发布、发布后操作环节，这里不再演示。</p>
<h3 id="5-5-WebHook"><a href="#5-5-WebHook" class="headerlink" title="5.5 WebHook"></a>5.5 WebHook</h3><blockquote>
<p>整体流程：</p>
</blockquote>
<ul>
<li>用户提交代码到 Git；</li>
<li>当代码提交到 Git 时根据你定义的规则自动触发构建。</li>
</ul>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728142557050.png" alt="image-20220728142557050"></p>
<p>1、Jenkins 创建工程</p>
<blockquote>
<p>创建名为 <code>webhook-test</code> 的流水线工程。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728103637104.png" alt="image-20220728103637104"></p>
<p>2、安装 WebHook 插件</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728104314245.png" alt="image-20220728104314245"></p>
<p>3、生成触发 WebHook URL</p>
<blockquote>
<p>在 Jenkins 对应的工程项目配置中生成：</p>
<p>jenkins-webhook-test</p>
</blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://192.168.56.131:8080/generic-webhook-trigger/invoke?token=jenkins-webhook-test">http://192.168.56.131:8080/generic-webhook-trigger/invoke?token=jenkins-webhook-test</a></p>
<p>正则匹配：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">只有满足匹配master或production分支的情况下，且git项目名满足匹配字母或-大于1，且触发者（代码提交者）不能是rab，才能触发构建。</span></span><br><span class="line">表达式：refs/heads/(master|production)_[a-zA-Z0-9-]&#123;1&#125;_(?|rab)</span><br><span class="line">针对哪些变量：$ref_$project_$username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">feiji：http://39.97.189.19:3031/</span><br><span class="line">paopaolong：http://39.97.189.19:3032/</span><br><span class="line">xiaoxiaole：http://39.97.189.19:3033/</span><br><span class="line">zuma：http://39.97.189.19:3034/</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4、Gitlab 配置</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728111656807.png" alt="image-20220728111656807"></p>
<blockquote>
<p>JENKINS_URL 换成你的 Jenkins IP 地址</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728113442233.png" alt="image-20220728113442233"></p>
<blockquote>
<p>测试这个 URL 是否可用</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728120755915.png" alt="image-20220728120755915"></p>
<blockquote>
<p>看输出结果</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728120654191.png" alt="image-20220728120654191"></p>
<blockquote>
<p>如果报 <code>Url is blocked: Requests to the local network are not allowed</code></p>
<p>配置一下 Gitlab 即可。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220728121033555.png" alt="image-20220728121033555"></p>
<h2 id="六、SonarQube"><a href="#六、SonarQube" class="headerlink" title="六、SonarQube"></a>六、SonarQube</h2><blockquote>
<p>该工具一般部署于 Jenkins 服务上。</p>
</blockquote>
<h3 id="6-1-工作原理"><a href="#6-1-工作原理" class="headerlink" title="6.1 工作原理"></a>6.1 工作原理</h3><p><code>SonarQube</code> 是一种自动代码审查工具，可检测代码中的错误、漏洞等，其可与现有 CICD 工具实现集成，从而实现跨项目分支和拉取请求的持续代码检测，其工作流程如下图所示。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/dev-cycle.png" alt="SonarQube Instance Components"></p>
<h3 id="6-2-安装部署"><a href="#6-2-安装部署" class="headerlink" title="6.2 安装部署"></a>6.2 安装部署</h3><p>1、创建数据目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/sonarqube/&#123;conf,extensions,logs,data&#125;</span><br></pre></td></tr></table></figure>

<p>2、启动临时容器</p>
<blockquote>
<p>copy lib 文件</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动临时容器</span></span><br><span class="line">docker run -itd \</span><br><span class="line">       --user root \</span><br><span class="line">       --privileged=true  \</span><br><span class="line">       --name=temp \</span><br><span class="line">       --restart=always \</span><br><span class="line">       sonarqube:8.9.0-community</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">copy lib</span></span><br><span class="line">cd /data/sonarqube/</span><br><span class="line">docker cp temp:/opt/sonarqube/lib ./</span><br></pre></td></tr></table></figure>

<p>3、启动最终容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除临时容器</span></span><br><span class="line">docker stop temp</span><br><span class="line">docker rm temp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行新容器</span></span><br><span class="line">docker run -itd \</span><br><span class="line">       --user root \</span><br><span class="line">       --privileged=true  \</span><br><span class="line">       --name=sonarqube \</span><br><span class="line">       --restart=always \</span><br><span class="line">       -p 9000:9000 \</span><br><span class="line">       -v /data/sonarqube/conf:/opt/sonarqube/conf \</span><br><span class="line">       -v /data/sonarqube/extensions:/opt/sonarqube/extensions \</span><br><span class="line">       -v /data/sonarqube/logs:/opt/sonarqube/logs \</span><br><span class="line">       -v /data/sonarqube/data:/opt/sonarqube/data \</span><br><span class="line">       -v /data/sonarqube/lib:/opt/sonarqube/lib \</span><br><span class="line">       -v /etc/localtime:/etc/localtime \</span><br><span class="line">       sonarqube:8.9.0-community</span><br></pre></td></tr></table></figure>

<p>4、登录验证</p>
<blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://ip:9000/">http://ip:9000/</a></p>
<p>初始用户：admin</p>
<p>初始密码：admin</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727111525551.png" alt="image-20220727111525551"></p>
<blockquote>
<p>修改初始密码</p>
<p>新密码为：zhurs@123</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727111641308.png" alt="image-20220727111641308"></p>
<blockquote>
<p>系统界面</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727111754461.png" alt="image-20220727111754461"></p>
<h3 id="6-3-基础配置"><a href="#6-3-基础配置" class="headerlink" title="6.3 基础配置"></a>6.3 基础配置</h3><h4 id="6-3-1-安装插件"><a href="#6-3-1-安装插件" class="headerlink" title="6.3.1 安装插件"></a>6.3.1 安装插件</h4><p>1、在线安装</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727112240587.png" alt="image-20220727112240587"></p>
<blockquote>
<p>此时你发现并没有 <code>Install</code> 安装按钮，此时你需要点击 <code>I understand the risk</code>（即我接收安装风险），此时你就会看到 <code>Install</code> 安装按钮了。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727112709859.png" alt="image-20220727112709859"></p>
<blockquote>
<p>这是一个中文插件，安装完成后重启 SonarQube 生效。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart sonarqube</span><br></pre></td></tr></table></figure>

<blockquote>
<p>再次验证插件是否被安装（web端是否正常显示中文）</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727112954126.png" alt="image-20220727112954126"></p>
<p>&#x3D;&#x3D;如何卸载插件？&#x3D;&#x3D;</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727113304523.png" alt="image-20220727113304523"></p>
<p>2、离线安装</p>
<ul>
<li><p>插件下载地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://update.sonarsource.org/">传送门</a></p>
</li>
<li><p>插件版本与 <code>sonarqube</code> 版本兼容对照表：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.sonarqube.org/latest/instance-administration/plugin-version-matrix/">传送门</a></p>
</li>
<li><p>上传插件至 <code>sonarqube</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">插件上传至该目录下</span></span><br><span class="line">cd /data/sonarqube/extensions/downloads</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget或本地下载后上传</span></span><br><span class="line">wget https://github.com/xuhuisheng/sonar-l10n-zh/releases/download/sonar-l10n-zh-plugin-9.5/sonar-l10n-zh-plugin-9.5.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">赋予可执行权限</span></span><br><span class="line">chmod +x sonar-l10n-zh-plugin-9.5.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启 sonarqube 生效</span></span><br><span class="line">doker restart sonarqube</span><br></pre></td></tr></table></figure></li>
</ul>
<p>&#x3D;&#x3D;常用语言插件安装&#x3D;&#x3D;</p>
<ul>
<li>Java</li>
</ul>
<h4 id="6-3-2-设置强制登录"><a href="#6-3-2-设置强制登录" class="headerlink" title="6.3.2 设置强制登录"></a>6.3.2 设置强制登录</h4><p>默认所有项目都是可以查看的，但在实际生产中是不被允许的，需要设置为私有的。并且我们需要设置用户强制，只有登录后才能查看。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727114945573.png" alt="image-20220727114945573"></p>
<h3 id="6-4-Scanner-扫描"><a href="#6-4-Scanner-扫描" class="headerlink" title="6.4 Scanner 扫描"></a>6.4 Scanner 扫描</h3><blockquote>
<p>部署于要扫描项目的服务器上。</p>
</blockquote>
<h4 id="6-4-1-安装部署"><a href="#6-4-1-安装部署" class="headerlink" title="6.4.1 安装部署"></a>6.4.1 安装部署</h4><p>1、下载二进制包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.0.2311-linux.zip</span><br></pre></td></tr></table></figure>

<p>2、配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">unzip sonar-scanner-cli-4.6.0.2311-linux.zip</span><br><span class="line">mv sonar-scanner-4.6.0.2311-linux/ /opt/ &amp;&amp; mv /opt/sonar-scanner-4.6.0.2311-linux/ /opt/scanner</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">环境变量</span></span><br><span class="line">vim /etc/profile.d/scanner.sh</span><br><span class="line">export PATH=/opt/scanner/bin:$PATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重载变量</span></span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看版本（scanner的JDK版本为11）</span></span><br><span class="line">[root@jenkins-master opt]# sonar-scanner -v</span><br><span class="line">INFO: Scanner configuration file: /opt/scanner/conf/sonar-scanner.properties</span><br><span class="line">INFO: Project root configuration file: NONE</span><br><span class="line">INFO: SonarScanner 4.6.0.2311</span><br><span class="line">INFO: Java 11.0.3 AdoptOpenJDK (64-bit)</span><br><span class="line">INFO: Linux 3.10.0-1160.el7.x86_64 amd64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">而我的服务器安装的是1.8版本的（两者需统一下）为什么与本地不一致呢？因为sonar-scanner中默认集成了jre环境</span></span><br><span class="line">[root@jenkins-master opt]# java -version</span><br><span class="line">java version &quot;1.8.0_202&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_202-b08)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.202-b08, mixed mode)</span><br></pre></td></tr></table></figure>

<p>3、修改 scanner 的JDK版本</p>
<blockquote>
<p>一般默认即可</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/scanner/bin/sonar-scanner</span><br></pre></td></tr></table></figure>

<ul>
<li><p>修改前</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727121534997.png" alt="image-20220727121534997"></p>
</li>
<li><p>修改后</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727121616196.png" alt="image-20220727121616196"></p>
</li>
<li><p>再次查看 JDK 版本</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727121802813.png" alt="image-20220727121802813"></p>
</li>
</ul>
<h4 id="6-4-2-基本使用"><a href="#6-4-2-基本使用" class="headerlink" title="6.4.2 基本使用"></a>6.4.2 基本使用</h4><p>1、配置文件方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认配置文件</span></span><br><span class="line">ll /opt/scanner/conf/sonar-scanner.properties</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义唯一的关键字</span></span><br><span class="line">sonar.projectKey=devops-hello-service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义项目名称</span></span><br><span class="line">sonar.projectName=My project</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义项目的版本信息</span></span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定扫描代码的目录位置（多个逗号分隔）</span></span><br><span class="line">sonar.sources=.</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行项目编码</span></span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line"></span><br><span class="line">sonar.host.url=http://xxxx:9000</span><br><span class="line">sonar.login=xxx</span><br><span class="line">sonar.password=xxx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当配置文件配置好后，就可以指定配置文件启动扫描程序了。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动扫描（指定配置文件）</span></span><br><span class="line">sonar-scanner -Dproject.settings=sonar-scanner.properties</span><br></pre></td></tr></table></figure>

<p>2、命令行方式</p>
<blockquote>
<p>如果你没有在配置文件（sonar-scanner.properties）中配置，也可使用命令行方式来传递参数</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令行传参</span></span><br><span class="line">sonar-scanner -Dsonar.projectKey=myproject \</span><br><span class="line">              -Dsonar.sources=src1 \</span><br><span class="line">              -Dsonar.sourceEncoding=UTF-8</span><br><span class="line">              ... \</span><br><span class="line">              ...</span><br></pre></td></tr></table></figure>

<h4 id="6-4-3-项目扫描"><a href="#6-4-3-项目扫描" class="headerlink" title="6.4.3 项目扫描"></a>6.4.3 项目扫描</h4><p>1、Java</p>
<blockquote>
<p>初始化一个 Java demo</p>
</blockquote>
<p>快速生成：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://start.spring.io/">https://start.spring.io/</a></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727153337942.png" alt="image-20220727153337942"></p>
<blockquote>
<p>上传至 Gitlab</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727155100698.png" alt="image-20220727155100698"></p>
<blockquote>
<p>本地手动构建一下</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone http://192.168.56.133/root/demo.git</span><br><span class="line">cd demo</span><br><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SonarQube 安装 Java 语言插件（该版本默认已经安装了）</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727161259149.png" alt="image-20220727161259149"></p>
<blockquote>
<p>开始扫描</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方式一：命令行  执行后会在sonarqube上自动创建你指定的相关项目信息及分析结果（在拉取gitlab项目的家目录执行）</span></span><br><span class="line">sonar-scanner -Dsonar.host.url=http://192.168.56.131:9000 \</span><br><span class="line">-Dsonar.projectKey=rab_test_1 \</span><br><span class="line">-Dsonar.projectName=rab_test-1 \</span><br><span class="line">-Dsonar.projectVersion=1.0 \</span><br><span class="line">-Dsonar.login=admin \</span><br><span class="line">-Dsonar.password=zhurs@123 \</span><br><span class="line">-Dsonar.ws.timeout=30 \</span><br><span class="line">-Dsonar.projectDescription=&quot;my first project!&quot; \</span><br><span class="line">-Dsonar.links.homepage=http://192.168.56.131/devops/devops-maven-service \</span><br><span class="line">-Dsonar.links.ci=http://192.168.56.131:8080/job/其他/job/test/ \</span><br><span class="line">-Dsonar.sources=src \</span><br><span class="line">-Dsonar.sourceEncoding=UTF-8 \</span><br><span class="line">-Dsonar.java.binaries=target/classes \</span><br><span class="line">-Dsonar.java.test.binaries=target/test-classes \</span><br><span class="line">-Dsonar.java.surefire.report=target/surefire-reports</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方式二：命令行  提前在sonarqube上创建了项目，并生成了以下语句（在拉取gitlab项目的家目录执行）</span></span><br><span class="line">mvn sonar:sonar \</span><br><span class="line">  -Dsonar.projectKey=demo \</span><br><span class="line">  -Dsonar.host.url=http://192.168.56.131:9000 \</span><br><span class="line">  -Dsonar.login=f58b2783878a817320b834b57ba3323e17b2b325</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727170318256.png" alt="image-20220727170318256"></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727170106848.png" alt="image-20220727170106848"></p>
<p>2、前端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sonar.projectKey=devops-web-service</span><br><span class="line">sonar.projectName=devops-web-service</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=src</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sonar.sources=dist/static/js</span></span><br><span class="line">sonar.host.url=http://192.168.56.131:9000</span><br><span class="line">sonar.login=admin</span><br><span class="line">sonar.password=zhurs@123</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<p>3、golang</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sonar-scanner -Dsonar.projectKey=devops-golang-service \</span><br><span class="line">-Dsonar.projectName=devops-golang-service \</span><br><span class="line">-Dsonar.sources=src \</span><br><span class="line">-Dsonar.login=admin \</span><br><span class="line">-Dsonar.password=zhurs@123 \</span><br><span class="line">-Dsonar.host.url=http://192.168.56.131:9000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 有测试用例的情况</span></span></span><br><span class="line">sonar.exclusions=**/*_test.go</span><br><span class="line">sonar.tests=.</span><br><span class="line">sonar.test.inclusions=**/*_test.go</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;Pipeline 流水线配置&#x3D;&#x3D;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">def buildTools = [  &quot;maven&quot; : &quot;/usr/local/apache-maven-3.8.1&quot;,</span><br><span class="line">                    &quot;gradle&quot;: &quot;/usr/local/gradle-6.8.3/&quot;,</span><br><span class="line">                    &quot;golang&quot;: &quot;/usr/local/go&quot;,</span><br><span class="line">                    &quot;web&quot;   : &quot;/usr/local/node-v14.16.1-linux-x64/&quot;,</span><br><span class="line">                    &quot;sonar&quot; : &quot;/usr/local/sonar-scanner-4.6.0.2311-linux&quot;]</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">	// xxx</span><br><span class="line">	stages&#123;</span><br><span class="line">		stage(&quot;SonarScan&quot;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    sh &quot;&quot;&quot;</span><br><span class="line">                        $&#123;buildTools[&quot;sonar&quot;]&#125;/bin/sonar-scanner -Dproject.settings=sonar.properties \</span><br><span class="line">                        -Dsonar.login=admin \</span><br><span class="line">                        -Dsonar.password=admin \</span><br><span class="line">                        -Dsonar.host.url=http://192.168.56.131:9000</span><br><span class="line">                       &quot;&quot;&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&quot;...&quot;) &#123;</span><br><span class="line">        	// xxx</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line"> 	&#125; </span><br><span class="line"> 	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;官方参数详解及各语言扫描示例&#x3D;&#x3D;</p>
<p>关于项目参数可以参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.sonarqube.org/latest/analysis/analysis-parameters/">https://docs.sonarqube.org/latest/analysis/analysis-parameters/</a></p>
<p>各种语言的扫描示例：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.sonarqube.org/latest/analysis/languages/">https://docs.sonarqube.org/latest/analysis/languages/</a></p>
<h4 id="6-3-4-Jenkins-插件"><a href="#6-3-4-Jenkins-插件" class="headerlink" title="6.3.4 Jenkins 插件"></a>6.3.4 Jenkins 插件</h4><blockquote>
<p>除了以上在配置文件、命令行、jenkinsfile（命令行的一种体现方式）进行质量检测外，也可以使用 Jenkins 插件来实现。</p>
</blockquote>
<p>1、Jenkins 安装 <code>SonarQube Scanner</code> 插件</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727175147391.png" alt="image-20220727175147391"></p>
<p>2、SonarQube 生成 Token</p>
<blockquote>
<p>将 Token 复制下来：6124c774af3b8c0263c4a1d03d790b1f308dd2fd</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727175627910.png" alt="image-20220727175627910"></p>
<p>3、将 Token 保存到 Jenkins 凭据中</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727180205084.png" alt="image-20220727180205084"></p>
<p>4、Jenkins 系统配置</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727180555462.png" alt="image-20220727180555462"></p>
<p>5、利用 Jenkins 片段生成器生成代码片段</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220727180816942.png" alt="image-20220727180816942"></p>
<p>6、流水线配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//使用sonar服务器</span><br><span class="line">	stage(&quot;SonarScanForPlugin&quot;)&#123;</span><br><span class="line">		steps&#123;</span><br><span class="line">			script&#123;</span><br><span class="line">				withSonarQubeEnv(credentialsId: &#x27;SonarQube_Token&#x27;) &#123;</span><br><span class="line">					def sonarDate = sh  returnStdout: true, script: &#x27;date  +%Y%m%d%H%M%S&#x27;</span><br><span class="line">					sonarDate = sonarDate - &quot;\n&quot;</span><br><span class="line">					</span><br><span class="line">					sh &quot;&quot;&quot;</span><br><span class="line">						$&#123;buildTools[&quot;sonar&quot;]&#125;/bin/sonar-scanner \</span><br><span class="line">						-Dsonar.projectKey=$&#123;JOB_NAME&#125; \</span><br><span class="line">						-Dsonar.projectName=$&#123;JOB_NAME&#125; \</span><br><span class="line">						-Dsonar.projectVersion=$&#123;sonarDate&#125; \</span><br><span class="line">						-Dsonar.ws.timeout=30 \</span><br><span class="line">						-Dsonar.projectDescription=&quot;my test project&quot; \</span><br><span class="line">						-Dsonar.links.homepage=http://www.baidu.com \</span><br><span class="line">						-Dsonar.sources=src \</span><br><span class="line">						-Dsonar.sourceEncoding=UTF-8 \</span><br><span class="line">						-Dsonar.java.binaries=target/classes \</span><br><span class="line">						-Dsonar.java.test.binaries=target/test-classes \</span><br><span class="line">						-Dsonar.java.surefire.report=target/surefire-reports \</span><br><span class="line">					&quot;&quot;&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-检测流程"><a href="#6-4-检测流程" class="headerlink" title="6.4 检测流程"></a>6.4 检测流程</h3><p>1、整体流程</p>
<ul>
<li>Scanner 扫描；</li>
<li>将扫描结果上传 SonarQube；</li>
<li>SonarQube 以 Web UI 形式进行展示。</li>
</ul>
<p>&#x3D;&#x3D;2、如何查看 SonarQube API 详情？&#x3D;&#x3D;</p>
<ul>
<li><p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://192.168.56.131:9000/web_api">http://192.168.56.131:9000/web_api</a></p>
</li>
<li><p>基本接口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 查找项目</span><br><span class="line">api/projects/search?projects=$&#123;projectName&#125;&quot;</span><br><span class="line"></span><br><span class="line">// 创建项目</span><br><span class="line">api/projects/create?name=$&#123;projectName&#125;&amp;project=$&#123;projectName&#125;&quot;</span><br><span class="line">   </span><br><span class="line">// 更新语言规则集</span><br><span class="line">api/qualityprofiles/add_project?language=$&#123;language&#125;&amp;qualityProfile=$&#123;qualityProfile&#125;&amp;project=$&#123;projectName&#125;&quot;</span><br><span class="line"></span><br><span class="line">// 项目授权</span><br><span class="line">api/permissions/apply_template?projectKey=$&#123;projectKey&#125;&amp;templateName=$&#123;templateName&#125;&quot;</span><br><span class="line"></span><br><span class="line">// 更新质量阈</span><br><span class="line">api/qualitygates/select?projectKey=$&#123;projectKey&#125;&amp;gateId=$&#123;gateId&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>具体案例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">// 封装HTTP</span><br><span class="line"></span><br><span class="line">def HttpReq(reqType,reqUrl,reqBody)&#123;</span><br><span class="line">    def sonarServer = &quot;http://192.168.1.200:9000/api&quot;</span><br><span class="line">   </span><br><span class="line">    response = httpRequest authentication: &#x27;4675830a-4330-4dd6-9185-cf62161967f0&#x27;,</span><br><span class="line">            httpMode: reqType, </span><br><span class="line">            contentType: &quot;APPLICATION_JSON&quot;,</span><br><span class="line">            consoleLogResponseBody: true,</span><br><span class="line">            ignoreSslErrors: true, </span><br><span class="line">            requestBody: reqBody,</span><br><span class="line">            url: &quot;$&#123;sonarServer&#125;/$&#123;reqUrl&#125;&quot;</span><br><span class="line">            //quiet: true</span><br><span class="line">    </span><br><span class="line">    return response</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 搜索Sonar项目</span><br><span class="line">def SerarchProject(projectName)&#123;</span><br><span class="line">    apiUrl = &quot;projects/search?projects=$&#123;projectName&#125;&quot;</span><br><span class="line">    response = HttpReq(&quot;GET&quot;,apiUrl,&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">    response = readJSON text: &quot;&quot;&quot;$&#123;response.content&#125;&quot;&quot;&quot;</span><br><span class="line">    result = response[&quot;paging&quot;][&quot;total&quot;]</span><br><span class="line"></span><br><span class="line">    if(result.toString() == &quot;0&quot;)&#123;</span><br><span class="line">       return &quot;false&quot;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">       return &quot;true&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取Sonar质量阈状态</span><br><span class="line">def GetProjectStatus(projectName)&#123;</span><br><span class="line">    apiUrl = &quot;project_branches/list?project=$&#123;projectName&#125;&quot;</span><br><span class="line">    response = HttpReq(&quot;GET&quot;,apiUrl,&#x27;&#x27;)</span><br><span class="line">    </span><br><span class="line">    response = readJSON text: &quot;&quot;&quot;$&#123;response.content&#125;&quot;&quot;&quot;</span><br><span class="line">    result = response[&quot;branches&quot;][0][&quot;status&quot;][&quot;qualityGateStatus&quot;]</span><br><span class="line">    </span><br><span class="line">    //println(response)</span><br><span class="line">    </span><br><span class="line">   return result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 创建Sonar项目</span><br><span class="line">def CreateProject(projectName)&#123;</span><br><span class="line">    apiUrl =  &quot;projects/create?name=$&#123;projectName&#125;&amp;project=$&#123;projectName&#125;&quot;</span><br><span class="line">    response = HttpReq(&quot;POST&quot;,apiUrl,&#x27;&#x27;)</span><br><span class="line">    println(response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 配置项目质量规则</span><br><span class="line">def ConfigQualityProfiles(projectName,lang,qpname)&#123;</span><br><span class="line">    apiUrl = &quot;qualityprofiles/add_project?language=$&#123;lang&#125;&amp;project=$&#123;projectName&#125;&amp;qualityProfile=$&#123;qpname&#125;&quot;</span><br><span class="line">    response = HttpReq(&quot;POST&quot;,apiUrl,&#x27;&#x27;)</span><br><span class="line">    println(response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取质量阈ID</span><br><span class="line">def GetQualtyGateId(gateName)&#123;</span><br><span class="line">    apiUrl= &quot;qualitygates/show?name=$&#123;gateName&#125;&quot;</span><br><span class="line">    response = HttpReq(&quot;GET&quot;,apiUrl,&#x27;&#x27;)</span><br><span class="line">    response = readJSON text: &quot;&quot;&quot;$&#123;response.content&#125;&quot;&quot;&quot;</span><br><span class="line">    result = response[&quot;id&quot;]</span><br><span class="line">    </span><br><span class="line">    return result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 配置项目质量阈</span><br><span class="line">def ConfigQualityGates(projectName,gateName)&#123;</span><br><span class="line">    gateId = GetQualtyGateId(gateName)</span><br><span class="line">    apiUrl = &quot;qualitygates/select?gateId=$&#123;gateId&#125;&amp;projectKey=$&#123;projectName&#125;&quot;</span><br><span class="line">    response = HttpReq(&quot;POST&quot;,apiUrl,&#x27;&#x27;)</span><br><span class="line">    println(response)println(response)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="七、制品库管理"><a href="#七、制品库管理" class="headerlink" title="七、制品库管理"></a>七、制品库管理</h2><p>Jenkins 通过与 <code>Nexus</code> 集成，实现制品上传下载。<a target="_blank" rel="noopener external nofollow noreferrer" href="https://nexusjs.org/">Nexus 官网</a></p>
<h3 id="7-1-基本概念"><a href="#7-1-基本概念" class="headerlink" title="7.1 基本概念"></a>7.1 基本概念</h3><p>通常，我们开发项目并没有使用到虚线标识的那两部分，基本都是通过本机的 Maven 直接访问中央仓库，下载jar包到本地仓库，现在我们需要搭建中间虚线部分。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018101731235.png" alt="image-20221018101731235"></p>
<h3 id="7-2-服务部署"><a href="#7-2-服务部署" class="headerlink" title="7.2 服务部署"></a>7.2 服务部署</h3><p>1、创建持久化目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/data/nexus</span><br><span class="line">chmod 777 /home/data/nexus</span><br></pre></td></tr></table></figure>

<p>2、运行容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --restart=always \</span><br><span class="line">  --name=nexus \</span><br><span class="line">  -p 8081:8081 \</span><br><span class="line">  -v /data/docker/nexus:/nexus-data sonatype/nexus3:3.42.0</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018102440469.png" alt="image-20221018102440469"></p>
<p>3、查询 Nexus 初始密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it nexus /bin/bash</span><br><span class="line">cat /opt/sonatype/sonatype-work/nexus3/admin.password</span><br><span class="line">169cee29-ae5f-481b-b153-206371d93f29</span><br></pre></td></tr></table></figure>

<blockquote>
<p>用户名：admin</p>
<p>密码：169cee29-ae5f-481b-b153-206371d93f29</p>
<p>之后再按要求重新设置新密码即可（本次新密码：zhurs@123）。</p>
</blockquote>
<p>4、验证</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220609174626174.png" alt="image-20220609174626174"></p>
<p>右上角这里告警了，提示 CPU 至少 4C 及以上：由于我这是测试环境，先不用理会。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018103554065.png" alt="image-20221018103554065"></p>
<h3 id="7-3-基本使用"><a href="#7-3-基本使用" class="headerlink" title="7.3 基本使用"></a>7.3 基本使用</h3><p>具体使用方法看我有道云笔记<code>基础服务部署</code>部分的《Docker 部署 Nexus》，这里不再重复演示。</p>
<h3 id="7-4-Jenkins-集成"><a href="#7-4-Jenkins-集成" class="headerlink" title="7.4 Jenkins 集成"></a>7.4 Jenkins 集成</h3><p>1、Pipeline 脚本</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    tools &#123;</span><br><span class="line">        maven <span class="string">&quot;M3&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    environment &#123;</span><br><span class="line">        NEXUS_VERSION = <span class="string">&quot;nexus3&quot;</span></span><br><span class="line">        NEXUS_PROTOCOL = <span class="string">&quot;http&quot;</span></span><br><span class="line">        NEXUS_URL = <span class="string">&quot;192.168.56.142:8081&quot;</span></span><br><span class="line">        NEXUS_REPOSITORY = <span class="string">&quot;cicd_hosted&quot;</span></span><br><span class="line">        NEXUS_CREDENTIAL_ID = <span class="string">&quot;nexus_kps&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;初始化&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>, <span class="attr">branches:</span> [[<span class="attr">name:</span> <span class="string">&quot;v1.0.1&quot;</span>]], <span class="attr">extensions:</span> [], <span class="attr">userRemoteConfigs:</span> [[<span class="attr">credentialsId:</span> <span class="string">&#x27;aliyun-devops&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;git@codeup.aliyun.com:6277bcbc11fc0f0c9e2990ab/RAB-ZH/java_code.git&#x27;</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Git代码拉取&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>, <span class="attr">branches:</span> [[<span class="attr">name:</span> <span class="string">&quot;v1.0.1&quot;</span>]], <span class="attr">extensions:</span> [], <span class="attr">userRemoteConfigs:</span> [[<span class="attr">credentialsId:</span> <span class="string">&#x27;aliyun-devops&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;git@codeup.aliyun.com:6277bcbc11fc0f0c9e2990ab/RAB-ZH/java_code.git&#x27;</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;Maven打包&quot;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    sh <span class="string">&quot;/var/jenkins_home/maven/bin/mvn clean package -Dmaven.test.skip=true&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;推送至Nexus制品库&quot;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    pom = readMavenPom <span class="attr">file:</span> <span class="string">&quot;pom.xml&quot;</span>;</span><br><span class="line">                    filesByGlob = findFiles(<span class="attr">glob:</span> <span class="string">&quot;target/*.$&#123;pom.packaging&#125;&quot;</span>);</span><br><span class="line">                    echo <span class="string">&quot;$&#123;filesByGlob[0].name&#125; $&#123;filesByGlob[0].path&#125; $&#123;filesByGlob[0].directory&#125; $&#123;filesByGlob[0].length&#125; $&#123;filesByGlob[0].lastModified&#125;&quot;</span></span><br><span class="line">                    artifactPath = filesByGlob[<span class="number">0</span>].path;</span><br><span class="line">                    artifactExists = fileExists artifactPath;</span><br><span class="line">                    <span class="keyword">if</span>(artifactExists) &#123;</span><br><span class="line">                        echo <span class="string">&quot;*** File: $&#123;artifactPath&#125;, group: $&#123;pom.groupId&#125;, packaging: $&#123;pom.packaging&#125;, version $&#123;pom.version&#125;&quot;</span>;</span><br><span class="line">                        nexusArtifactUploader(</span><br><span class="line">                            <span class="symbol">nexusVersion:</span> NEXUS_VERSION,</span><br><span class="line">                            <span class="symbol">protocol:</span> NEXUS_PROTOCOL,</span><br><span class="line">                            <span class="symbol">nexusUrl:</span> NEXUS_URL,</span><br><span class="line">                            <span class="symbol">groupId:</span> pom.groupId,</span><br><span class="line">                            <span class="symbol">version:</span> pom.version,</span><br><span class="line">                            <span class="symbol">repository:</span> NEXUS_REPOSITORY,</span><br><span class="line">                            <span class="symbol">credentialsId:</span> NEXUS_CREDENTIAL_ID,</span><br><span class="line">                            <span class="symbol">artifacts:</span> [</span><br><span class="line">                                [<span class="attr">artifactId:</span> pom.artifactId,</span><br><span class="line">                                <span class="symbol">classifier:</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                                <span class="symbol">file:</span> artifactPath,</span><br><span class="line">                                <span class="symbol">type:</span> pom.packaging],</span><br><span class="line">                                [<span class="attr">artifactId:</span> pom.artifactId,</span><br><span class="line">                                <span class="symbol">classifier:</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                                <span class="symbol">file:</span> <span class="string">&quot;pom.xml&quot;</span>,</span><br><span class="line">                                <span class="symbol">type:</span> <span class="string">&quot;pom&quot;</span>]</span><br><span class="line">                            ]</span><br><span class="line">                        );</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        error <span class="string">&quot;*** File: $&#123;artifactPath&#125;, could not be found&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、构建验证</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018123030679.png" alt="image-20221018123030679"></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018120302885.png" alt="image-20221018120302885"></p>
<p>3、去 Nexus 查看一下</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018120845661.png" alt="image-20221018120845661"></p>
<h2 id="八、FAQ"><a href="#八、FAQ" class="headerlink" title="八、FAQ"></a>八、FAQ</h2><h3 id="8-1-缺少-Docker-插件"><a href="#8-1-缺少-Docker-插件" class="headerlink" title="8.1 缺少 Docker 插件"></a>8.1 缺少 Docker 插件</h3><p>1、报错类型</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220610145809263.png" alt="image-20220610145809263"></p>
<p>2、解决方案</p>
<p>这是 Jenkins 缺少插件问题。Jenkins 安装 Docker 相关插件即可。</p>
<h3 id="8-2-docker-作为-agent-时报错"><a href="#8-2-docker-作为-agent-时报错" class="headerlink" title="8.2 docker 作为 agent 时报错"></a>8.2 docker 作为 agent 时报错</h3><p>1、报错类型</p>
<p>使用 docker 作为 agent 时报错，流水线脚本如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        docker &#123;</span><br><span class="line">            image &#x27;maven:3-alpine&#x27;</span><br><span class="line">            args &#x27;-v /root/maven:/root/.m2&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;mvn -v&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构建后报错：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220610145407929.png" alt="image-20220610145407929"></p>
<p>2、解决方案</p>
<p>这是权限问题。将 Jenkins 用户加入 root 用户组即可。</p>
<ul>
<li><p>创建 docker 用户组</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>追加 jenkins 用户到 docker 用户组</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -a -G docker jenkins</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看是否添加成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/group</span><br><span class="line">...</span><br><span class="line">docker:x:994:jenkins</span><br></pre></td></tr></table></figure>
</li>
<li><p>赋予 666 权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ll /var/run/docker.sock</span><br><span class="line">srw-rw---- 1 root docker 0 Jun 10 12:54 /var/run/docker.sock</span><br><span class="line"></span><br><span class="line">chmod 666 /var/run/docker.sock</span><br><span class="line"></span><br><span class="line">ll /var/run/docker.sock</span><br><span class="line">srw-rw-rw- 1 root docker 0 Jun 10 12:54 /var/run/docker.sock</span><br></pre></td></tr></table></figure></li>
</ul>
<p>再次构建即可。</p>
<h3 id="8-3-options-timestamps"><a href="#8-3-options-timestamps" class="headerlink" title="8.3 options timestamps()"></a>8.3 options timestamps()</h3><p>1、报错类型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WorkflowScript: 21: Invalid option type &quot;timestamps&quot;. Valid option types: [authorizationMatrix, buildDiscarder, catchError, checkoutToSubdirectory, disableConcurrentBuilds, disableResume, durabilityHint, lock, overrideIndexTriggers, parallelsAlwaysFailFast, preserveStashes, quietPeriod, rateLimitBuilds, retry, script, skipDefaultCheckout, skipStagesAfterUnstable, timeout, waitUntil, warnError, withChecks, withContext, withCredentials, withEnv, wrap, ws] @ line 21, column 3.</span><br><span class="line">   		timestamps()</span><br><span class="line">     ^</span><br></pre></td></tr></table></figure>

<p>2、解决方案</p>
<p>使用时间戳方式显示日志输出时间时，Jenkins 需要安装 <code>Timestamper</code> 插件，如下图，我已经安装过了，如果你还没安装，就点击 <code>Available</code> 选项进行搜索安装即可。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220724163819555.png" alt="image-20220724163819555"></p>
<h3 id="8-4-jar-推送至制品库"><a href="#8-4-jar-推送至制品库" class="headerlink" title="8.4 jar 推送至制品库"></a>8.4 jar 推送至制品库</h3><h4 id="8-4-1-报错一"><a href="#8-4-1-报错一" class="headerlink" title="8.4.1 报错一"></a>8.4.1 报错一</h4><p>1、报错现象</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018113733372.png" alt="image-20221018113733372"></p>
<p>2、解决方案</p>
<blockquote>
<p>Jenkins 服务安装 <code>pipeline-utility-steps</code> 插件</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018113953087.png" alt="image-20221018113953087"> </p>
<h4 id="8-4-2-报错二"><a href="#8-4-2-报错二" class="headerlink" title="8.4.2 报错二"></a>8.4.2 报错二</h4><p>1、报错现象</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018114245902.png" alt="image-20221018114245902"></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018114333710.png" alt="image-20221018114333710"></p>
<p>2、解决方案</p>
<p>该问题是因为 <code>jenkins</code> 的安全沙箱机制导致的，只要批准不安全的脚本运行即可，对 Jenkins 服务进行配置即可：</p>
<ul>
<li><p>系统配置 ——&gt; 安全（看下图）</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018114604278.png" alt="image-20221018114604278"></p>
</li>
<li><p>点击允许使用模板</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018115218685.png" alt="image-20221018115218685"></p>
</li>
<li><p>完成（这时候就可以了）</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20221018115136967.png" alt="image-20221018115136967"></p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.rabcnops.cn">Rab</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.rabcnops.cn/posts/articles/a951d278.html">https://blog.rabcnops.cn/posts/articles/a951d278.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.rabcnops.cn" target="_blank">Rabcnops</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CICD/">CICD</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Jenkins-Pipeline/">Jenkins_Pipeline</a></div><div class="post_share"><div class="social-share" data-image="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/%E6%B5%81%E6%B0%B4%E7%BA%BF.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/wechat.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/alipay.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/articles/bc241c84.html" title="Jenkins 用户权限管理"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/2d697c8b26a7d91dc044f623e7f80f4a.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Jenkins 用户权限管理</div></div></a></div><div class="next-post pull-right"><a href="/posts/articles/ad1bd1bd.html" title="Gitlab 基础操作快速入门"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/R-C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Gitlab 基础操作快速入门</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/articles/c2464361.html" title="Jenkins 实现 Gitlab API 调用及共享库应用"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/2d697c8b26a7d91dc044f623e7f80f4a.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-22</div><div class="title">Jenkins 实现 Gitlab API 调用及共享库应用</div></div></a></div><div><a href="/posts/articles/7e46479a.html" title="Jenkins Pipeline 密钥远程部署"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/pipeline.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-22</div><div class="title">Jenkins Pipeline 密钥远程部署</div></div></a></div><div><a href="/posts/articles/7ede8fbb.html" title="Jenkins Pipeline 配置钉钉消息通知"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/2d697c8b26a7d91dc044f623e7f80f4a.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-22</div><div class="title">Jenkins Pipeline 配置钉钉消息通知</div></div></a></div><div><a href="/posts/articles/1be7f41.html" title="Active Choice Parameter 在 Jenkinsfile 中的应用"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/js.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-22</div><div class="title">Active Choice Parameter 在 Jenkinsfile 中的应用</div></div></a></div><div><a href="/posts/articles/fcc16254.html" title="Jenkins Pipeline 方法定义及调用"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/%E6%B5%81%E6%B0%B4%E7%BA%BF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-22</div><div class="title">Jenkins Pipeline 方法定义及调用</div></div></a></div><div><a href="/posts/articles/ad1bd1bd.html" title="Gitlab 基础操作快速入门"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/R-C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-23</div><div class="title">Gitlab 基础操作快速入门</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Livere</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81ODIzNS8zNDY5OA=="></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Rab</div><div class="author-info__description">专注于云计算/云原生/开发。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/rabcnops/"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhurse@163.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="iconfont icon-minutemailer"></i></a><a class="social-icon" href="https://blog.csdn.net/IT_ZRS" rel="external nofollow noreferrer" target="_blank" title="CSDN"><i class="iconfont icon-csdn2"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">2023/03/24 开通个人博客系统，会同步 CSDN 内容。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="toc-text">一、整体结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-text">二、基本语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-agent"><span class="toc-text">2.1 agent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.1.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.1.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-stages"><span class="toc-text">2.2 stages</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.2.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.2.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-post"><span class="toc-text">2.3 post</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.3.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.3.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-text">2.4 环境变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E9%A2%84%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-text">2.4.1 预定义变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-text">2.4.2 自定义变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-credentials"><span class="toc-text">2.5 credentials</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.5.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.5.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-options"><span class="toc-text">2.6 options</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.6.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.6.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-parameters"><span class="toc-text">2.7 parameters</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.7.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.7.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-triggers"><span class="toc-text">2.8 triggers</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.8.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.8.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-input"><span class="toc-text">2.9 input</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.9.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.9.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-when"><span class="toc-text">2.10 when</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.10.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.10.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-parallel"><span class="toc-text">2.11 parallel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-11-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">2.11.1 说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-11-2-%E6%A1%88%E4%BE%8B"><span class="toc-text">2.11.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-12-DSL"><span class="toc-text">2.12 DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-12-1-JSON-%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90"><span class="toc-text">2.12.1 JSON 数据格式解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-12-2-%E4%BD%BF%E7%94%A8%E5%87%AD%E6%8D%AE"><span class="toc-text">2.12.2 使用凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-12-3-%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86"><span class="toc-text">2.12.3 代码管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-12-4-HTML-%E6%8A%A5%E5%91%8A%E5%B1%95%E7%A4%BA"><span class="toc-text">2.12.4 HTML 报告展示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-12-5-%E8%8E%B7%E5%8F%96%E7%AE%A1%E9%81%93%E6%9E%84%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="toc-text">2.12.5 获取管道构建用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-12-6-%E4%BD%BF%E7%94%A8-HttpRequest-%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82"><span class="toc-text">2.12.6 使用 HttpRequest 发起请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-12-7-%E8%8E%B7%E5%8F%96-Shell-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-text">2.12.7 获取 Shell 返回值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%85%B1%E4%BA%AB%E5%BA%93"><span class="toc-text">三、共享库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%88%9B%E5%BB%BA%E5%85%B1%E4%BA%AB%E5%BA%93"><span class="toc-text">3.1 创建共享库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%8A%A0%E8%BD%BD%E5%85%B1%E4%BA%AB%E5%BA%93"><span class="toc-text">3.2 加载共享库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Jenkins-%E9%85%8D%E7%BD%AE"><span class="toc-text">3.3 Jenkins 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Jenkins-%E6%9E%84%E5%BB%BA"><span class="toc-text">3.4 Jenkins 构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E6%89%A9%E5%B1%95"><span class="toc-text">3.5 扩展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-text">四、邮件配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Jenkins-%E9%85%8D%E7%BD%AE"><span class="toc-text">4.1 Jenkins 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Jenkinsfile-%E9%85%8D%E7%BD%AE"><span class="toc-text">4.2 Jenkinsfile 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E9%82%AE%E4%BB%B6%E5%86%85%E5%AE%B9%E5%8F%82%E8%80%83%E6%A8%A1%E6%9D%BF"><span class="toc-text">4.3 邮件内容参考模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA"><span class="toc-text">五、项目构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-text">5.1 前端项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-npm"><span class="toc-text">5.1.1 npm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-yarn"><span class="toc-text">5.1.2 yarn</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-text">5.2 后端项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-mavn"><span class="toc-text">5.2.1 mavn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-gradle"><span class="toc-text">5.2.2 gradle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-ant"><span class="toc-text">5.2.3 ant</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Go-%E9%A1%B9%E7%9B%AE"><span class="toc-text">5.3 Go 项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="toc-text">5.4 综合案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-WebHook"><span class="toc-text">5.5 WebHook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81SonarQube"><span class="toc-text">六、SonarQube</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">6.1 工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-text">6.2 安装部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-text">6.3 基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="toc-text">6.3.1 安装插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-2-%E8%AE%BE%E7%BD%AE%E5%BC%BA%E5%88%B6%E7%99%BB%E5%BD%95"><span class="toc-text">6.3.2 设置强制登录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-Scanner-%E6%89%AB%E6%8F%8F"><span class="toc-text">6.4 Scanner 扫描</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-1-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-text">6.4.1 安装部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-2-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">6.4.2 基本使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-3-%E9%A1%B9%E7%9B%AE%E6%89%AB%E6%8F%8F"><span class="toc-text">6.4.3 项目扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-4-Jenkins-%E6%8F%92%E4%BB%B6"><span class="toc-text">6.3.4 Jenkins 插件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E6%A3%80%E6%B5%8B%E6%B5%81%E7%A8%8B"><span class="toc-text">6.4 检测流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%88%B6%E5%93%81%E5%BA%93%E7%AE%A1%E7%90%86"><span class="toc-text">七、制品库管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">7.1 基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="toc-text">7.2 服务部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">7.3 基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-Jenkins-%E9%9B%86%E6%88%90"><span class="toc-text">7.4 Jenkins 集成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81FAQ"><span class="toc-text">八、FAQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E7%BC%BA%E5%B0%91-Docker-%E6%8F%92%E4%BB%B6"><span class="toc-text">8.1 缺少 Docker 插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-docker-%E4%BD%9C%E4%B8%BA-agent-%E6%97%B6%E6%8A%A5%E9%94%99"><span class="toc-text">8.2 docker 作为 agent 时报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-options-timestamps"><span class="toc-text">8.3 options timestamps()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-jar-%E6%8E%A8%E9%80%81%E8%87%B3%E5%88%B6%E5%93%81%E5%BA%93"><span class="toc-text">8.4 jar 推送至制品库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-1-%E6%8A%A5%E9%94%99%E4%B8%80"><span class="toc-text">8.4.1 报错一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-2-%E6%8A%A5%E9%94%99%E4%BA%8C"><span class="toc-text">8.4.2 报错二</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/1c8d3a9.html" title="Ansible 部署 Wordpress"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/timg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ansible 部署 Wordpress"/></a><div class="content"><a class="title" href="/posts/articles/1c8d3a9.html" title="Ansible 部署 Wordpress">Ansible 部署 Wordpress</a><time datetime="2023-03-29T02:51:14.000Z" title="发表于 2023-03-29 10:51:14">2023-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/e36de20c.html" title="基于 Docker 的 Prometheus 监控方案"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/prometheus.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基于 Docker 的 Prometheus 监控方案"/></a><div class="content"><a class="title" href="/posts/articles/e36de20c.html" title="基于 Docker 的 Prometheus 监控方案">基于 Docker 的 Prometheus 监控方案</a><time datetime="2023-03-28T07:51:14.000Z" title="发表于 2023-03-28 15:51:14">2023-03-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/2f967c8.html" title="Prometheus - SSL 证书过期监控"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230328101307841.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Prometheus - SSL 证书过期监控"/></a><div class="content"><a class="title" href="/posts/articles/2f967c8.html" title="Prometheus - SSL 证书过期监控">Prometheus - SSL 证书过期监控</a><time datetime="2023-03-28T02:56:54.000Z" title="发表于 2023-03-28 10:56:54">2023-03-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/7dd3df1e.html" title="Docker 容器文件（数据）共享"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220908134844265.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker 容器文件（数据）共享"/></a><div class="content"><a class="title" href="/posts/articles/7dd3df1e.html" title="Docker 容器文件（数据）共享">Docker 容器文件（数据）共享</a><time datetime="2023-03-23T04:18:21.000Z" title="发表于 2023-03-23 12:18:21">2023-03-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/ffa06faa.html" title="Docker 容器间通信"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/docker.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker 容器间通信"/></a><div class="content"><a class="title" href="/posts/articles/ffa06faa.html" title="Docker 容器间通信">Docker 容器间通信</a><time datetime="2023-03-23T04:18:21.000Z" title="发表于 2023-03-23 12:18:21">2023-03-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/%E6%B5%81%E6%B0%B4%E7%BA%BF.webp')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Rab</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://blog.rabcnops.cn/posts/articles/a951d278.html'
    this.page.identifier = '/posts/articles/a951d278.html'
    this.page.title = 'Pipeline 核心技术'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Livere' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>