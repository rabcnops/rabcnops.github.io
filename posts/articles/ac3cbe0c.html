<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>基于 Kafka 构建 EL(F)K 高并发分布式日志系统 | Rabcnops</title><meta name="author" content="Rab"><meta name="copyright" content="Rab"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基于 Kafka 构建 EL(F)K 高并发分布式日志系统">
<meta property="og:type" content="article">
<meta property="og:title" content="基于 Kafka 构建 EL(F)K 高并发分布式日志系统">
<meta property="og:url" content="https://blog.rabcnops.cn/posts/articles/ac3cbe0c.html">
<meta property="og:site_name" content="Rabcnops">
<meta property="og:description" content="基于 Kafka 构建 EL(F)K 高并发分布式日志系统">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626161553527.png">
<meta property="article:published_time" content="2023-06-07T08:13:00.000Z">
<meta property="article:modified_time" content="2023-06-07T08:21:10.107Z">
<meta property="article:author" content="Rab">
<meta property="article:tag" content="ELK">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626161553527.png"><link rel="shortcut icon" href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg"><link rel="canonical" href="https://blog.rabcnops.cn/posts/articles/ac3cbe0c.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="ChZGTmJgK6Cd-KcODCRca2hnXQkjF16b5ykmjM1Anl8"/><meta name="baidu-site-verification" content="codeva-VkkS25uSFS"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"文章发布于","messageNext":"天前，文章内容可能已经过期，请持续关注本博客最新文档！"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Rab","link":"链接: ","source":"来源: Rabcnops","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于 Kafka 构建 EL(F)K 高并发分布式日志系统',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-07 16:21:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/iconfont.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Rabcnops" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-ziyuan3"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-tag"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont icon-fenlei"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-lianjie_URL"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-mingpian2"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626161553527.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Rabcnops"><img class="site-icon" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rablogo.png"/></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-ziyuan3"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-tag"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont icon-fenlei"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-lianjie_URL"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-mingpian2"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">基于 Kafka 构建 EL(F)K 高并发分布式日志系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-07T08:13:00.000Z" title="发表于 2023-06-07 16:13:00">2023-06-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-07T08:21:10.107Z" title="更新于 2023-06-07 16:21:10">2023-06-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/">日志系统</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/ELK/">ELK</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">22.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>100分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="基于 Kafka 构建 EL(F)K 高并发分布式日志系统"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626161553527.png" alt="image-20220626161553527"></p>
<blockquote>
<p>主讲：rab</p>
<p>职位：DevOps工程师</p>
<p>Date：2022&#x2F;06&#x2F;07</p>
</blockquote>
<hr>
<h2 id="一、ELK-介绍"><a href="#一、ELK-介绍" class="headerlink" title="一、ELK 介绍"></a>一、ELK 介绍</h2><h3 id="1-1-什么是-ELK-？"><a href="#1-1-什么是-ELK-？" class="headerlink" title="1.1 什么是 ELK ？"></a>1.1 什么是 ELK ？</h3><p><strong>ELK</strong>（Elasticsearch、Logstash、Kibana），即三款开源软件首字母缩写，ELK 不是一个软件，而是一套开源的解决方案。</p>
<h3 id="1-2-为什么选择-ELK-？"><a href="#1-2-为什么选择-ELK-？" class="headerlink" title="1.2 为什么选择 ELK ？"></a>1.2 为什么选择 ELK ？</h3><p>通过日志排查，发现问题根源并解决问题：</p>
<p><strong>1、单台或几台服务器日志查看</strong></p>
<p>我们可以通过 linux命令，<code>tail、cat、grep、awk</code>等过滤去查询定位日志查问题。</p>
<p><strong>2、几十台或几百台服务器日志查看</strong></p>
<p>此时再通过<code>tail、cat、grep、awk</code>等过滤去查询定位日志查问题是不现实的，时间成本是非常高的，因此我们就会选择这一套开源的解决方案。</p>
<h3 id="1-3-ELK-具备哪些特点？"><a href="#1-3-ELK-具备哪些特点？" class="headerlink" title="1.3 ELK 具备哪些特点？"></a>1.3 ELK 具备哪些特点？</h3><ul>
<li>收集－能够采集多种来源的日志数据；</li>
<li>传输－能够稳定的把日志数据传输到中央系统；</li>
<li>存储－如何存储日志数据；</li>
<li>分析－可以支持 UI 分析；</li>
<li>警告－能够提供错误报告，监控机制。</li>
</ul>
<h3 id="1-4-ELK-组件介绍"><a href="#1-4-ELK-组件介绍" class="headerlink" title="1.4 ELK 组件介绍"></a>1.4 ELK 组件介绍</h3><h4 id="1-4-1-Elasticsearch"><a href="#1-4-1-Elasticsearch" class="headerlink" title="1.4.1 Elasticsearch"></a>1.4.1 Elasticsearch</h4><p><code>Elasticsearch</code>是一个实时的分布式搜索、分析引擎，使用 Java 语言开发，可进行全文检索、结构化检索及分析。</p>
<p><strong>主要特点：</strong></p>
<ul>
<li>面向文档的数据存储；</li>
<li>高可用、易扩展；</li>
<li>支持 Json 等各种文档格式；</li>
<li>支持集群、分片和复制。</li>
</ul>
<h4 id="1-4-2-Logstash"><a href="#1-4-2-Logstash" class="headerlink" title="1.4.2 Logstash"></a>1.4.2 Logstash</h4><p><code>Logstash</code>是一个实时的数据收集引擎，使用 JRuby 语言开发。</p>
<p><strong>主要特点：</strong></p>
<ul>
<li>几乎可以访问任何数据；</li>
<li>可以和多种外部应用结合;</li>
<li>支持弹性扩展。</li>
</ul>
<p><strong>主要组成：</strong></p>
<ul>
<li>Shipper－发送日志数据</li>
<li>Broker－收集数据，缺省内置 Redis</li>
<li>Indexer－数据写入</li>
</ul>
<h4 id="1-4-3-Kibana"><a href="#1-4-3-Kibana" class="headerlink" title="1.4.3 Kibana"></a>1.4.3 Kibana</h4><p><code>Kibana</code>是一款基于 <code>Apache</code>开源协议，使用 <code>JavaScript</code>语言编写，为 <code>Elasticsearch</code> 提供分析和可视化的 Web 平台。</p>
<p><strong>主要特点：</strong></p>
<ul>
<li>快速索引检索；</li>
<li>数据交互；</li>
<li>可生成各种维度数据图表。</li>
</ul>
<h2 id="二、架构及应用场景"><a href="#二、架构及应用场景" class="headerlink" title="二、架构及应用场景"></a>二、架构及应用场景</h2><h3 id="2-1-基础架构"><a href="#2-1-基础架构" class="headerlink" title="2.1 基础架构"></a>2.1 基础架构</h3><p>在这种架构中，只有一个 Logstash、Elasticsearch 和 Kibana 实例。</p>
<p><strong>基础架构1：</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623183334183.png" alt="image-20220623183334183"></p>
<p><strong>基础架构2：</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623183357191.png" alt="image-20220623183357191"></p>
<p><strong>流程：</strong></p>
<p>Logstash 收集日志并过滤加工数据 ——&gt; Elasticsearch 做数据持久化 ——&gt; Kibana 展示</p>
<p><strong>场景：</strong></p>
<ul>
<li>这种结构因为需要在各个服务器上部署 Logstash，而它比较消耗 CPU 和内存资源；</li>
<li>所以比较适合计算资源充足的服务器，否则容易造成服务器性能下降，甚至可能导致无法正常工作。</li>
</ul>
<h3 id="2-2-高可用架构"><a href="#2-2-高可用架构" class="headerlink" title="2.2 高可用架构"></a>2.2 高可用架构</h3><p>在这种架构中，将轻量级的 FileBeat 代替了 Logstash 来做日志收集，并引入了消息队列机制，且各部分都做了集群。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627141707143.png" alt="image-20220627141707143"></p>
<p><strong>流程：</strong></p>
<p>FileBeat 收集日志 ——&gt; 输出到消息队列 ——&gt; Logstash 获取消息队列数据 ——&gt; Elasticsearch 做数据持久化 ——&gt;  Kibana 展示</p>
<p><strong>场景：</strong></p>
<ul>
<li>这种架构适合于日志规模比较庞大的情况；</li>
<li>但由于 <code>Logstash</code> 日志解析节点和 <code>Elasticsearch</code> 的负荷比较重，可将他们配置为集群模式，以分担负荷；</li>
<li>引入消息队列是为了：均衡网络传输、降低网络闭塞。避免数据丢失。</li>
</ul>
<h2 id="三、VM-部署-ELK-集群"><a href="#三、VM-部署-ELK-集群" class="headerlink" title="三、VM 部署 ELK 集群"></a>三、VM 部署 ELK 集群</h2><blockquote>
<p>ELK 中文社区资源下载：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://elasticsearch.cn/download/#seg-3">https://elasticsearch.cn/download/#seg-3</a></p>
<p>ELK 官方资源下载：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/cn/downloads/">https://www.elastic.co/cn/downloads/</a></p>
</blockquote>
<h3 id="3-1-主机规划"><a href="#3-1-主机规划" class="headerlink" title="3.1 主机规划"></a>3.1 主机规划</h3><table>
<thead>
<tr>
<th>Service</th>
<th>Version</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.56.133 - 2C&#x2F;2G 30G - es-1</td>
<td>6.8.23</td>
<td>ES 分布式存储</td>
</tr>
<tr>
<td>192.168.56.134 - 2C&#x2F;2G 30G - es-2</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>192.168.56.135 - 2C&#x2F;2G 30G - es-3</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>192.168.56.137 - 2C&#x2F;2G 30G - kafka-1 zookeeper-1</td>
<td>ZK：3.7.1<br />Kafka：3.1.1</td>
<td>Kafka 消息队列</td>
</tr>
<tr>
<td>192.168.56.138 - 2C&#x2F;2G 30G - kafka-2 zookeeper-2</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>192.168.56.139 - 2C&#x2F;2G 30G - kafka-3 zookeeper-3</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>192.168.56.140 - 1C&#x2F;2G 30G - logstash-1</td>
<td>6.8.23</td>
<td>Logstash 分流</td>
</tr>
<tr>
<td>192.168.56.141 - 1C&#x2F;2G 30G - logstash-2</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>192.168.56.136 - 2C&#x2F;2G 30G - kabana - nginx</td>
<td>6.8.23</td>
<td>web 前端数据展示</td>
</tr>
<tr>
<td>192.168.56.136 - 2C&#x2F;2G 30G - kabana</td>
<td>-</td>
<td>-</td>
</tr>
</tbody></table>
<blockquote>
<p>采集插件（Filebeat）版本：6.8.23 </p>
<p>ELK 各插件版本最好保持一致，否则可能会导致一些采集异常。</p>
</blockquote>
<h3 id="3-2-应用部署"><a href="#3-2-应用部署" class="headerlink" title="3.2 应用部署"></a>3.2 应用部署</h3><blockquote>
<p>集群场景下的服务器，需对时间进行同步，服务器时间同步方法：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装ntp服务</span></span><br><span class="line">yum -y install ntp ntpdate</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同步网络时间服务器</span></span><br><span class="line">ntpdate 0.asia.pool.ntp.org</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将系统时间写入硬件时间（防止重启后时间被重置）</span></span><br><span class="line">hwclock --systohc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他网络时间服务器</span></span><br><span class="line">time.nist.gov</span><br><span class="line">time.nuri.net</span><br><span class="line">0.asia.pool.ntp.org</span><br><span class="line">1.asia.pool.ntp.org</span><br><span class="line">2.asia.pool.ntp.org</span><br><span class="line">3.asia.pool.ntp.org</span><br></pre></td></tr></table></figure>

<h3 id="3-3-ES-集群"><a href="#3-3-ES-集群" class="headerlink" title="3.3 ES 集群"></a>3.3 ES 集群</h3><blockquote>
<p>三台 ES 服务器同时操作</p>
</blockquote>
<p><strong>1、修改服务器主机名</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname es-1</span><br><span class="line">hostnamectl set-hostname es-2</span><br><span class="line">hostnamectl set-hostname es-3</span><br></pre></td></tr></table></figure>

<p><strong>2、互作本地解析</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.133 es-1</span><br><span class="line">192.168.56.134 es-2</span><br><span class="line">192.168.56.135 es-3</span><br></pre></td></tr></table></figure>

<p><strong>3、创建数据目录</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data</span><br></pre></td></tr></table></figure>

<p><strong>4、上传并解压ES二进制文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xzf elasticsearch-6.0.1.tar.gz -C /data/</span><br><span class="line">mv /data/elasticsearch-6.0.1 /data/elasticsearch</span><br></pre></td></tr></table></figure>

<p><strong>5、修改文件句柄数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/security/limits.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注：设置为 65535 不行，至少 65536</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果配置文件开启bootstrap.memory_lock，内存锁，则需要添加下列最后两行</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc  65536</span><br><span class="line">* hard nproc  65536</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">* soft memlock unlimited</span><br></pre></td></tr></table></figure>

<p><strong>6、修改虚拟内存最大限制</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;vm.max_map_count = 655360&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<p>系统级别：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system.conf</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">DefaultLimitNOFILE=65536</span><br><span class="line">DefaultLimitNPROC=32000</span><br><span class="line">DefaultLimitMEMLOCK=infinity</span><br></pre></td></tr></table></figure>

<p><strong>7、创建 ES 普通用户</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd es</span><br><span class="line">echo &quot;zhurs@123&quot; | passwd --stdin es</span><br></pre></td></tr></table></figure>

<p><strong>8、修改目录权限</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R es.es /data/elasticsearch</span><br></pre></td></tr></table></figure>

<p><strong>9、修改配置文件</strong></p>
<p><strong>es-1</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cd /data/elasticsearch/config</span><br><span class="line">cp elasticsearch.yml elasticsearch.yml.default</span><br><span class="line">vim elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cluster.name 三者需相同</span></span><br><span class="line">cluster.name: es-cluster</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.name 节点名，设置与主机名一致即可</span></span><br><span class="line">node.name: es-1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.master 符合成为主节点的条件</span></span><br><span class="line">node.master: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.data 符合成为数据节点的条件</span></span><br><span class="line">node.data: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.data 数据存储路径（下面会进行创建）</span></span><br><span class="line">path.data: /data/elasticsearch/data</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.logs 日志存储路径（下面会进行创建）</span></span><br><span class="line">path.logs: /data/elasticsearch/logs</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bootstrap.memory_lock 锁住内存，即只使用内存，不使用交换分区</span></span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network.host 允许所有IP访问</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http.port web访问端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping.unicast.hosts 关闭单播</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.56.133&quot;, &quot;192.168.56.134&quot;, &quot;192.168.56.135&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping_timeout 节点在发现过程中的等待超时时间</span></span><br><span class="line">discovery.zen.ping_timeout: 120s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.fd.ping_retries 节点发现重试次数</span></span><br><span class="line">discovery.zen.fd.ping_retries: 10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">client.transport.ping_timeout  ping命令的响应超时时间</span></span><br><span class="line">client.transport.ping_timeout: 60s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决跨域问题</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>es-2</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cd /data/elasticsearch/config</span><br><span class="line">cp elasticsearch.yml elasticsearch.yml.default</span><br><span class="line">vim elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cluster.name 三者需相同</span></span><br><span class="line">cluster.name: es-cluster</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.name 节点名，设置与主机名一致即可</span></span><br><span class="line">node.name: es-2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.master 符合成为主节点的条件</span></span><br><span class="line">node.master: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.data 符合成为数据节点的条件</span></span><br><span class="line">node.data: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.data 数据存储路径（下面会进行创建）</span></span><br><span class="line">path.data: /data/elasticsearch/data</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.logs 日志存储路径（下面会进行创建）</span></span><br><span class="line">path.logs: /data/elasticsearch/logs</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bootstrap.memory_lock 锁住内存，即只使用内存，不使用交换分区</span></span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network.host 允许所有IP访问</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http.port web访问端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping.unicast.hosts 关闭单播</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.56.133&quot;, &quot;192.168.56.134&quot;, &quot;192.168.56.135&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping_timeout 节点在发现过程中的等待超时时间</span></span><br><span class="line">discovery.zen.ping_timeout: 120s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.fd.ping_retries 节点发现重试次数</span></span><br><span class="line">discovery.zen.fd.ping_retries: 10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">client.transport.ping_timeout  ping命令的响应超时时间</span></span><br><span class="line">client.transport.ping_timeout: 60s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决跨域问题</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>es-3</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cd /data/elasticsearch/config</span><br><span class="line">cp elasticsearch.yml elasticsearch.yml.default</span><br><span class="line">vim elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cluster.name 三者需相同</span></span><br><span class="line">cluster.name: es-cluster</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.name 节点名，设置与主机名一致即可</span></span><br><span class="line">node.name: es-3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.master 符合成为主节点的条件</span></span><br><span class="line">node.master: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.data 符合成为数据节点的条件</span></span><br><span class="line">node.data: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.data 数据存储路径（下面会进行创建）</span></span><br><span class="line">path.data: /data/elasticsearch/data</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.logs 日志存储路径（下面会进行创建）</span></span><br><span class="line">path.logs: /data/elasticsearch/logs</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bootstrap.memory_lock 锁住内存，即只使用内存，不使用交换分区</span></span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network.host 允许所有IP访问</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http.port web访问端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping.unicast.hosts 关闭单播</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.56.133&quot;, &quot;192.168.56.134&quot;, &quot;192.168.56.135&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping_timeout 节点在发现过程中的等待超时时间</span></span><br><span class="line">discovery.zen.ping_timeout: 120s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.fd.ping_retries 节点发现重试次数</span></span><br><span class="line">discovery.zen.fd.ping_retries: 10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">client.transport.ping_timeout  ping命令的响应超时时间</span></span><br><span class="line">client.transport.ping_timeout: 60s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决跨域问题</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>10、创建数据、日志目录</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/elasticsearch/data</span><br><span class="line">mkdir -p /data/elasticsearch/logs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">授权</span></span><br><span class="line">chown es.es /data/elasticsearch/data</span><br><span class="line">chown es.es /data/elasticsearch/logs</span><br></pre></td></tr></table></figure>

<p><strong>11、安装 JDK</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传并解压安装包</span></span><br><span class="line">tar xzf jdk-8u202-linux-x64.tar.gz -C /data/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mv</span> 重命名</span></span><br><span class="line">mv /data/jdk1.8.0_202/ /data/jdk</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加环境变量</span></span><br><span class="line">cat /etc/profile.d/jdk.sh </span><br><span class="line">export PATH=/data/jdk/bin:$PATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证</span></span><br><span class="line">[root@es-1 data]# java -version</span><br><span class="line">java version &quot;1.8.0_202&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_202-b08)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.202-b08, mixed mode)</span><br></pre></td></tr></table></figure>

<p><strong>12、修改 JVM 参数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认1g</span></span><br><span class="line">cat /data/elasticsearch/config/jvm.options</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">-Xms512m</span><br><span class="line">-Xmx512m</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>13、启动 ES 集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - es -c &quot;nohup /data/elasticsearch/bin/elasticsearch &amp;&quot;</span><br></pre></td></tr></table></figure>

<p><strong>14、配置 systemd 管理</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=elasticsearch</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">User=es</span><br><span class="line">ExecStart=/data/elasticsearch/bin/elasticsearch -d</span><br><span class="line">PrivateTmp=true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定此进程可以打开的最大文件数</span></span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定此进程可以打开的最大进程数</span></span><br><span class="line">LimitNPROC=65536</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最大虚拟内存</span></span><br><span class="line">LimitAS=infinity</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最大文件大小</span></span><br><span class="line">LimitFSIZE=infinity</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">超时设置0-永不超时</span></span><br><span class="line">TimeoutStopSec=0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SIGTERM是停止java进程的信号</span></span><br><span class="line">KillSignal=SIGTERM</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">信号只发给JVM</span></span><br><span class="line">KillMode=process</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">java进程不会被杀掉</span></span><br><span class="line">SendSIGKILL=no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正常退出状态</span></span><br><span class="line">SuccessExitStatus=143</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务并做开机自启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start es.service</span><br><span class="line">systemctl enable es.service</span><br></pre></td></tr></table></figure>

<p>浏览器输入 URL 查看集群状态：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://192.168.56.134:9200/_cat/nodes?pretty">http://192.168.56.134:9200/_cat/nodes?pretty</a></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623161419031.png" alt="image-20220623161419031"></p>
<p>&#x3D;&#x3D;至此，ES 集群搭建完毕，可通过简单的 head 插件查看集群状态，head 插件可部署在 kibana 服务器上，具体看 6.2.4 部分。&#x3D;&#x3D;</p>
<p><strong>15、集群可用性测试</strong></p>
<p>具体测试看 6.2.2 小结</p>
<h3 id="3-4-Logstash-分流"><a href="#3-4-Logstash-分流" class="headerlink" title="3.4 Logstash 分流"></a>3.4 Logstash 分流</h3><blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/logstash/current/index.html">《官方文档》</a></p>
</blockquote>
<p><strong>1、安装 JAVA 环境</strong></p>
<blockquote>
<p>Logstash 依赖 JDK</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xzf jdk-8u202-linux-x64.tar.gz -C /data/</span><br><span class="line">mv /data/jdk1.8.0_202/ /data/jdk</span><br><span class="line">ln -s /data/jdk/bin/* /usr/bin/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可用性测试</span></span><br><span class="line">java -version</span><br><span class="line">java version &quot;1.8.0_202&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_202-b08)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.202-b08, mixed mode)</span><br></pre></td></tr></table></figure>

<p><strong>2、安装 Logstash</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xzf logstash-6.0.1.tar.gz -C /data/</span><br><span class="line">mv /data/logstash-6.0.1/ /data/logstash</span><br></pre></td></tr></table></figure>

<p><strong>3、命令行测试 ES 集群可用性</strong></p>
<blockquote>
<p>logstash 可用性测试</p>
<p>stdin{}：标准输入</p>
<p>stdout{}：标准输出</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/data/logstash/bin/logstash -e &#x27;input &#123; stdin &#123;&#125; &#125; output &#123; stdout &#123;&#125; &#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出结果：时间戳  主机名  内容</span></span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622121128625.png" alt="image-20220622121128625"></p>
<blockquote>
<p>将标准输入内容以指定语言格式输出至当前终端</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/logstash/bin/logstash -e &#x27;input &#123; stdin&#123;&#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug &#125; &#125;&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622121532407.png" alt="image-20220622121532407"></p>
<blockquote>
<p>将标准输入内容输出至 ES 集群</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/logstash/bin/logstash -e &#x27;input &#123; stdin &#123;&#125; &#125; output &#123; elasticsearch &#123; hosts =&gt; [&quot;192.168.56.133:9200&quot;] &#125; &#125;&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622122512629.png" alt="image-20220622122512629"></p>
<p>此时访问 head 插件看看 ES 集群情况，看是否收到刚刚我们输入的内容<code>hello xgxy</code></p>
<blockquote>
<p>es-head 安装看 6.2.3 部分</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622122928152.png" alt="image-20220622122928152"></p>
<p>数据会产生5个分片数和2个副本数，分片和副本数分别存储在不同节点上。</p>
<p><strong>4、ES 集群状态</strong></p>
<p>ES 集群有三个状态：green、yellow、red</p>
<ul>
<li><p>green：表示所有主分片和复制分片都可用（整个集群可用）</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622143341046.png" alt="image-20220622143341046"></p>
</li>
<li><p>yellow：表示所有主分片可用，部分复制分片不可以。比如我故意停掉 es-1，再次查看集群状态</p>
<blockquote>
<p>在停掉 es-1 的时候，集群状态处于部分副本数据不可用的情况</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622144602406.png" alt="image-20220622144602406"></p>
<blockquote>
<p>但是，过了一段时间后，es-1 的主分片和复制分片被转移到 es-2、es-3 节点，实现故障转移，保证数据完整性。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622144231764.png" alt="image-20220622144231764"></p>
<blockquote>
<p>此时，我再次启动 es-1 ，再次并入集群，这时 es-1 会被重新分片分配及副本，集群状态呈 green</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622144352162.png" alt="image-20220622144352162"></p>
</li>
<li><p>red：表示部分主分片不可用</p>
</li>
</ul>
<p>在 yellow 状态，我故意停掉了 es-1 节点，所以其呈现 yellow 状态，但你会发现，我停掉的是 data-node 节点（数据节点），那我把 master 节点 down 掉，会发生什么？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@es-3 0]# systemctl stop es.service</span><br></pre></td></tr></table></figure>

<p>此时会呈现 yellow 状态：<br><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622145723959.png" alt="image-20220622145723959"></p>
<p>此时，在指定时间内，进群会进行 master 选举，并为整个集群分配分片，实现故障转移：完成后呈 green 集群可用状态。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622145958425.png" alt="image-20220622145958425"></p>
<p>我有重新启动 es-3，看看集群情况：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622150434411.png" alt="image-20220622150434411"></p>
<p>此时，它会以数据节点并入集群，并分配分片。</p>
<p><strong>5、Logstash 收集日志测试</strong></p>
<p>由于我的 Kibana 安装了 nginx ，也是需要进行日志收集的，所以我把 Logstash 安装在 kibana 服务器上进行日志采集。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xzf logstash-6.0.1.tar.gz -C /data/</span><br><span class="line">mv /data/logstash-6.0.1/ /data/logstash</span><br></pre></td></tr></table></figure>

<p>将 nginx 日志格式定义为 json 格式，并引用 json 格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">log_format  json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class="line">                           &#x27;&quot;@version&quot;:&quot;1&quot;,&#x27;</span><br><span class="line">                           &#x27;&quot;client&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class="line">                           &#x27;&quot;url&quot;:&quot;$uri&quot;,&#x27;</span><br><span class="line">                           &#x27;&quot;status&quot;:&quot;$status&quot;,&#x27;</span><br><span class="line">                           &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                           &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class="line">                           &#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br><span class="line">                           &#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class="line">                           &#x27;&quot;referer&quot;: &quot;$http_referer&quot;,&#x27;</span><br><span class="line">                           &#x27;&quot;ua&quot;: &quot;$http_user_agent&quot;&#x27;</span><br><span class="line">               &#x27;&#125;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  json;</span><br></pre></td></tr></table></figure>

<p>创建 logstash 配置文件目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/logstash/config/conf.d</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 conf.d 目录下添加<code>shopweb.conf</code>文件</p>
<p>该目录可定义多个 .conf 文件</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat shopweb.conf</span><br><span class="line"></span><br><span class="line">input&#123;</span><br><span class="line">    file&#123;</span><br><span class="line">        path =&gt; [&quot;/data/nginx/logs/access.log&quot;]</span><br><span class="line">        type =&gt; &quot;shopweb&quot;</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]  </span><br><span class="line">        index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字段说明：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">input：输入插件，让logstash可以读取特定的事件源</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file：从文件中读取</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path：要输入的文件路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">type</span>：定义一个类型，通用选项（因此，每个项目需定义一个access.log）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个<span class="built_in">type</span>说明了你这个是什么样属性的日志，数据库日志我就定义：mysql,订单日志我就定义：order</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">start_position：开始采集日志的位置，beginning表示从头开始（即开始到当前的日志全部收集）</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">output：输出插件，将事件发送到特定目标</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">elasticsearch：输出到es</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts：指定es服务的 ip + 端口</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">index：引用input中的<span class="built_in">type</span>名称，定义输出的格式，并作为索引，然后在kibana上面可以添加该索引</span></span><br></pre></td></tr></table></figure>

<p>启动 logstash</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">前台启动</span></span><br><span class="line">/data/logstash/bin/logstash -f /data/logstash/config/conf.d/ --config.reload.automatic</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">后台启动</span></span><br><span class="line">nohup /data/logstash/bin/logstash -f /data/logstash/config/conf.d/ --config.reload.automatic &amp;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--config.reload.automatic：可以加载conf.d 目录下的所有.conf文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">想要单独加载的话，则去掉--config.reload.automatic参数，并指定具体的 .conf 文件</span></span><br></pre></td></tr></table></figure>

<p>浏览器刷一下 nginx 页面，然后取 head 插件看看是否成功存储，如下图，shopweb-2022.06.22 正好是我们 shopweb.conf 文件中 output 中 index 定义的格式：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622161423194.png" alt="image-20220622161423194"></p>
<p>数据浏览：这正是我 kibana 服务上的你 nginx 的日志数据：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622162146328.png" alt="image-20220622162146328"></p>
<p>&#x3D;&#x3D;注意：input 可以写多个，如下&#x3D;&#x3D;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim all.conf</span><br><span class="line"></span><br><span class="line">input&#123;</span><br><span class="line">    file&#123;</span><br><span class="line">        path =&gt; [&quot;/data/nginx/logs/access.log&quot;]</span><br><span class="line">        type =&gt; &quot;nginx_access&quot;</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">input&#123;</span><br><span class="line">    file&#123;</span><br><span class="line">        path =&gt; [&quot;/var/log/messages&quot;]</span><br><span class="line">        type =&gt; &quot;system_error&quot;</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output&#123;</span><br><span class="line">    if [type] ==  &quot;nginx_access&quot; &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;] </span><br><span class="line">            index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">    if [type] ==  &quot;system_error&quot; &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;] </span><br><span class="line">            index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只要 input 对应的文件产生新的日志，logstash 实时就会往 ES 集群发送。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622170153169.png" alt="image-20220622170153169"></p>
<h3 id="3-5-Kibana-前端展示"><a href="#3-5-Kibana-前端展示" class="headerlink" title="3.5 Kibana 前端展示"></a>3.5 Kibana 前端展示</h3><p><strong>1、安装 head 插件</strong></p>
<blockquote>
<p>由于安装需要各种编译，所以选择 docker 安装</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name=es-head \</span><br><span class="line">  --privileged=true \</span><br><span class="line">  --restart=always \</span><br><span class="line">  -v /etc/localtime:/etc/localtime \</span><br><span class="line">  -p 9100:9100 \</span><br><span class="line">  docker.io/mobz/elasticsearch-head:5-alpine</span><br></pre></td></tr></table></figure>

<blockquote>
<p>验证集群状态，此时无任何数据存储。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622103923524.png" alt="image-20220622103923524"></p>
<p><strong>2、安装 kibana</strong></p>
<p>尽管在 6.2.2 节看到已经 ES 集群已经成功接收到数据，但是 es-head 插件对数据的浏览是不友好的，因此我们需要安装部署 kibana 来做 ES 数据的 web 端展示（分析、检索等）</p>
<h3 id="3-6-Nginx-反向代理"><a href="#3-6-Nginx-反向代理" class="headerlink" title="3.6 Nginx 反向代理"></a>3.6 Nginx 反向代理</h3><blockquote>
<ul>
<li>代理 head</li>
<li>代理 kibana </li>
<li>从而实现统一访问</li>
<li>采用 host 网络模式</li>
</ul>
</blockquote>
<p><strong>1、采用 docker 安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-------------------------------自定义变量--------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义nginx主目录</span></span><br><span class="line">dir_conf=&quot;/data/nginx/conf&quot;</span><br><span class="line">dir_html=&quot;/data/nginx/html&quot;</span><br><span class="line">dir_logs=&quot;/data/nginx/logs&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置镜像版本</span></span><br><span class="line">img=&quot;nginx:1.20.2&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器名</span></span><br><span class="line">name=&quot;nginx&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口映射(针对bridge模式设置，host模式忽略)</span></span><br><span class="line">http_port=&quot;80&quot;</span><br><span class="line">https_port=&quot;443&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网络模式</span></span><br><span class="line">net=&quot;bridge&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">host模式：使用 --net=host 指定。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">none模式：使用 --net=none 指定。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bridge模式：使用 --net=bridge 指定，默认设置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">container模式：使用 --net=container:NAME_or_ID 指定</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建目录</span></span><br><span class="line">mkdir -p $&#123;dir_conf&#125; &amp;&amp; echo -e &quot;已创建 $&#123;dir_conf&#125; 目录，继续执行... \033[32m[ok]\033[0m&quot; || echo -e &quot;$&#123;dir_conf&#125; 目录已存在，继续执行... \033[33m[Already exists]\033[0m&quot;</span><br><span class="line">mkdir -p $&#123;dir_html&#125; &amp;&amp; echo -e &quot;已创建 $&#123;dir_html&#125; 目录，继续执行... \033[32m[ok]\033[0m&quot; || echo -e &quot;$&#123;dir_html&#125; 目录已存在，继续执行... \033[33m[Already exists]\033[0m&quot;</span><br><span class="line">mkdir -p $&#123;dir_logs&#125; &amp;&amp; echo -e &quot;已创建 $&#123;dir_logs&#125; 目录，继续执行... \033[32m[ok]\033[0m&quot; || echo -e &quot;$&#123;dir_logs&#125; 目录已存在，继续执行... \033[33m[Already exists]\033[0m&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">echo &quot;正在拉取$&#123;img&#125;镜像，请耐心等待...&quot;</span><br><span class="line">docker pull $img &amp;&gt; /dev/null</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动临时容器（<span class="built_in">cp</span>配置文件）</span></span><br><span class="line">echo &quot;正在启动$&#123;name&#125;临时容器...&quot;</span><br><span class="line">docker run -d --name=$&#123;name&#125; $img &amp;&gt; /dev/null</span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">    echo -e &quot;$&#123;name&#125;临时容器启动成功 \033[32m[ok]\033[0m&quot;</span><br><span class="line">else</span><br><span class="line">    echo -e &quot;\033[31m[error]$&#123;name&#125;临时容器启动失败\033[0m&quot; &amp;&amp; exit 1</span><br><span class="line">fi</span><br><span class="line">echo &quot;正在拷贝配置文件至宿主机...&quot;</span><br><span class="line">docker cp $&#123;name&#125;:/etc/nginx/nginx.conf $&#123;dir_conf&#125;</span><br><span class="line">docker cp $&#123;name&#125;:/etc/nginx/conf.d $&#123;dir_conf&#125;</span><br><span class="line">echo -e &quot;配置文件拷贝成功 \033[32m[ok]\033[0m&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除临时容器</span></span><br><span class="line">echo &quot;正在删除$&#123;name&#125;容器...&quot;</span><br><span class="line">docker stop $name &amp;&gt; /dev/null</span><br><span class="line">docker rm $name &amp;&gt; /dev/null</span><br><span class="line">echo -e &quot;$&#123;name&#125;容器删除成功 \033[32m[ok]\033[0m&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行正式容器</span></span><br><span class="line">echo &quot;正在启动$&#123;name&#125;正式容器...&quot;</span><br><span class="line">a=&quot;host&quot;</span><br><span class="line">b=&quot;bridge&quot;</span><br><span class="line">c=&quot;none&quot;</span><br><span class="line">d=&quot;container&quot;</span><br><span class="line">if [ $net = $a ]; then</span><br><span class="line">    docker run -itd \</span><br><span class="line">    --name=$&#123;name&#125; \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    --restart=always \</span><br><span class="line">    --net=$&#123;a&#125; \</span><br><span class="line">    -v /etc/localtime:/etc/localtime \</span><br><span class="line">    -v $&#123;dir_conf&#125;/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">    -v $&#123;dir_conf&#125;/conf.d:/etc/nginx/conf.d \</span><br><span class="line">    -v $&#123;dir_html&#125;:/usr/share/nginx/html \</span><br><span class="line">    -v $&#123;dir_logs&#125;:/var/log/nginx $&#123;img&#125; &amp;&gt; /dev/null</span><br><span class="line">    elif [ $net = $b ]; then</span><br><span class="line">        docker run -itd \</span><br><span class="line">        --name=$&#123;name&#125; \</span><br><span class="line">        --privileged=true \</span><br><span class="line">        --restart=always \</span><br><span class="line">        -p $&#123;http_port&#125;:80 \</span><br><span class="line">        -p $&#123;https_port&#125;:443 \</span><br><span class="line">        -v /etc/localtime:/etc/localtime \</span><br><span class="line">        -v $&#123;dir_conf&#125;/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">        -v $&#123;dir_conf&#125;/conf.d:/etc/nginx/conf.d \</span><br><span class="line">        -v $&#123;dir_html&#125;:/usr/share/nginx/html \</span><br><span class="line">        -v $&#123;dir_logs&#125;:/var/log/nginx $&#123;img&#125; &amp;&gt; /dev/null</span><br><span class="line">else</span><br><span class="line">    echo -e &quot;\033[31m[error]容器启动失败，请指定正确的网络模式\033[0m&quot; &amp;&amp; exit 1</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">    echo -e &quot;$&#123;name&#125;容器启动成功 \033[32m[ok]\033[0m&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    echo -e &quot;\033[32m发布路径：$&#123;dir_html&#125;\033[0m&quot;</span><br><span class="line">    echo -e &quot;\033[32m配置路径：$&#123;dir_conf&#125;\033[0m&quot;</span><br><span class="line">    echo -e &quot;\033[32m日志路径：$&#123;dir_logs&#125;\033[0m&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">else</span><br><span class="line">    echo -e &quot;\033[31m[error]$&#123;name&#125;容器启动失败，请手动检查错误原因\033[0m&quot; &amp;&amp; exit 1</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打印容器网络模式</span></span><br><span class="line">echo -e &quot;$&#123;name&#125;容器网络模式为：\033[35m$&#123;net&#125;\033[0m&quot;</span><br><span class="line">echo &quot;&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打印端口</span></span><br><span class="line">if [ $net = &quot;bridge&quot; ]; then</span><br><span class="line">    echo -e &quot;\033[32mhttp端口：$&#123;http_port&#125;:80\033[0m&quot;</span><br><span class="line">    echo -e &quot;\033[32mhttps端口：$&#123;https_port&#125;:443\033[0m&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;具体的 Nginx 反向代理配置请看 4.4 部分。&#x3D;&#x3D;</p>
<h3 id="3-7-Zookeeper-集群"><a href="#3-7-Zookeeper-集群" class="headerlink" title="3.7 Zookeeper 集群"></a>3.7 Zookeeper 集群</h3><blockquote>
<p>具体部署过程可看我博客<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/IT_ZRS/article/details/125615805?spm=1001.2014.3001.5501">《ZooKeeper 集群部署》</a>，这里不再重复部署。</p>
</blockquote>
<h3 id="3-8-Kafka-集群"><a href="#3-8-Kafka-集群" class="headerlink" title="3.8 Kafka 集群"></a>3.8 Kafka 集群</h3><blockquote>
<p>下载地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/apache/kafka/releases/tag/3.1.1">https://github.com/apache/kafka/releases/tag/3.1.1</a></p>
</blockquote>
<p><code>Kafka 集群</code>依赖于 <code>Zookeeper 集群</code>，因此在部署 Kafka 集群前，需保证 Zookeeper 集群是正常工作的，一般将 Zookeeper 集群与 Kafka 集群部署在一起即可（当然如果你的服务器充裕的话，也可分开部署）。</p>
<p>1、下载并解压</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/apache/kafka/archive/refs/tags/3.1.1.tar.gz</span><br><span class="line">tar xzf 3.1.1.tar.gz -C /data/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>官方提供的 Kafka 安装包中已经包含 Zookeeper 安装程序，对于非 Docker 安装的方式，直接下载 Kafka 安装包即可安装 Zookeeper 集群了，Kafka 相关配置文件如下图。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220806134544705.png" alt="image-20220806134544705"></p>
<p>2、修改配置文件</p>
<blockquote>
<p>配置文件：<code>/data/kafka-3.1.1/config/server.properties</code></p>
</blockquote>
<ul>
<li><p>kafka-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">broker.id=1</span><br><span class="line">listeners=PLAINTEXT://192.168.56.137:9092</span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/data/kafka-3.1.1/logs</span><br><span class="line">num.partitions=6</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line">offsets.topic.replication.factor=2</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line">log.retention.hours=168</span><br><span class="line">log.segment.bytes=536870912</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line">zookeeper.connect=192.168.56.137:2181,192.168.56.138:2181,192.168.56.139:2181</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建配置文件中指定的日志路径</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/kafka-3.1.1/logs</span><br></pre></td></tr></table></figure>
</li>
<li><p>kafka-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">broker.id=2</span><br><span class="line">listeners=PLAINTEXT://192.168.56.138:9092</span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/opt/data/kafka/logs</span><br><span class="line">num.partitions=6</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line">offsets.topic.replication.factor=2</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line">log.retention.hours=168</span><br><span class="line">log.segment.bytes=536870912</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line">zookeeper.connect=192.168.56.137:2181,192.168.56.138:2181,192.168.56.139:2181</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建配置文件中指定的日志路径</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/kafka-3.1.1/logs</span><br></pre></td></tr></table></figure>
</li>
<li><p>kafka-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">broker.id=3</span><br><span class="line">listeners=PLAINTEXT://192.168.56.139:9092</span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/opt/data/kafka/logs</span><br><span class="line">num.partitions=6</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line">offsets.topic.replication.factor=2</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line">log.retention.hours=168</span><br><span class="line">log.segment.bytes=536870912</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line">zookeeper.connect=192.168.56.137:2181,192.168.56.138:2181,192.168.56.139:2181</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建配置文件中指定的日志路径</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/kafka-3.1.1/logs</span><br></pre></td></tr></table></figure></li>
</ul>
<p>3、启动 Kafka 集群</p>
<ul>
<li><p>kafka-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/kafka-3.1.1</span><br><span class="line">nohup bin/kafka-server-start.sh config/server.properties &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>kafka-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/kafka-3.1.1</span><br><span class="line">nohup bin/kafka-server-start.sh config/server.properties &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>kafka-3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/kafka-3.1.1</span><br><span class="line">nohup bin/kafka-server-start.sh config/server.properties &amp;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>&#x3D;&#x3D;至此，Kafka 集群部署完毕！&#x3D;&#x3D;</p>
<h3 id="3-9-FAQ"><a href="#3-9-FAQ" class="headerlink" title="3.9 FAQ"></a>3.9 FAQ</h3><h4 id="3-9-1-ES-Systemd-启动报错"><a href="#3-9-1-ES-Systemd-启动报错" class="headerlink" title="3.9.1 ES Systemd 启动报错"></a>3.9.1 ES Systemd 启动报错</h4><p>如果你配置 ES systemd 管理，对 jdk 的就就会有要求，否则无法启动，具体报错如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@es-1 bin]# journalctl -u es.service </span><br><span class="line">-- Logs begin at Wed 2022-06-22 09:38:05 CST, end at Wed 2022-06-22 09:45:27 CST. --</span><br><span class="line">Jun 22 09:45:27 es-1 systemd[1]: Starting elasticsearch...</span><br><span class="line">Jun 22 09:45:27 es-1 elasticsearch[1571]: which: no java in (/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin)</span><br><span class="line">Jun 22 09:45:27 es-1 elasticsearch[1571]: could not find java; set JAVA_HOME or ensure java is in PATH</span><br><span class="line">Jun 22 09:45:27 es-1 systemd[1]: es.service: control process exited, code=exited status=1</span><br><span class="line">Jun 22 09:45:27 es-1 systemd[1]: Failed to start elasticsearch.</span><br><span class="line">Jun 22 09:45:27 es-1 systemd[1]: Unit es.service entered failed state.</span><br><span class="line">Jun 22 09:45:27 es-1 systemd[1]: es.service failed.</span><br></pre></td></tr></table></figure>

<p>因为我的 jdk 路径是配置在 profile.d 下的，所在加载的时候没有识别出来，而且报错也给出了提示，修改一下路径即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /data/jdk/bin/* /usr/bin/</span><br></pre></td></tr></table></figure>

<p>以 systemd 启动的服务，同时还需要修改一下配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system.conf</span><br><span class="line"></span><br><span class="line">DefaultLimitNOFILE=65536</span><br><span class="line">DefaultLimitNPROC=32000</span><br><span class="line">DefaultLimitMEMLOCK=infinity</span><br></pre></td></tr></table></figure>

<h4 id="3-9-2-Logstash-启动报错"><a href="#3-9-2-Logstash-启动报错" class="headerlink" title="3.9.2 Logstash 启动报错"></a>3.9.2 Logstash 启动报错</h4><p>当我运行测试命令启动 logstash 时，包如下错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash-1 logstash]# /data/logstash/bin/logstash -e &#x27;input &#123; stdin &#123;&#125; &#125; output &#123; elasticsearch &#123; hosts =&gt; [&quot;192.168.56.133:9200&quot;] &#125; &#125;&#x27;</span><br><span class="line">Sending Logstash&#x27;s logs to /data/logstash/logs which is now configured via log4j2.properties</span><br><span class="line">[2022-06-22T13:13:22,138][INFO ][logstash.modules.scaffold] Initializing module &#123;:module_name=&gt;&quot;fb_apache&quot;, :directory=&gt;&quot;/data/logstash/modules/fb_apache/configuration&quot;&#125;</span><br><span class="line">[2022-06-22T13:13:22,140][INFO ][logstash.modules.scaffold] Initializing module &#123;:module_name=&gt;&quot;netflow&quot;, :directory=&gt;&quot;/data/logstash/modules/netflow/configuration&quot;&#125;</span><br><span class="line">[2022-06-22T13:13:22,245][WARN ][logstash.config.source.multilocal] Ignoring the &#x27;pipelines.yml&#x27; file because modules or command line options are specified</span><br><span class="line">[2022-06-22T13:13:22,256][FATAL][logstash.runner          ] Logstash could not be started because there is already another instance using the configured data directory.  If you wish to run multiple instances, you must change the &quot;path.data&quot; setting.</span><br></pre></td></tr></table></figure>

<p>解决方案：因为在 logstash 数据目录下存在缓冲文件（.lock），删除即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash-1 data]# cd /data/logstash/data/</span><br><span class="line">[root@logstash-1 data]# ll -a</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x  4 root root  69 Jun 22 13:42 .</span><br><span class="line">drwxr-xr-x 12 root root 259 Jun 22 12:06 ..</span><br><span class="line">drwxr-xr-x  2 root root   6 Jun 22 12:06 dead_letter_queue</span><br><span class="line">-rw-r--r--  1 root root   0 Jun 22 13:42 .lock</span><br><span class="line">drwxr-xr-x  2 root root   6 Jun 22 12:06 queue</span><br><span class="line">-rw-r--r--  1 root root  36 Jun 22 12:06 uuid</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622143509359.png" alt="image-20220622143509359"></p>
<h4 id="3-9-3-head-插件-406-错误"><a href="#3-9-3-head-插件-406-错误" class="headerlink" title="3.9.3 head 插件 406 错误"></a>3.9.3 head 插件 406 错误</h4><p>当我们在浏览数据时，发现右边框并无数据，F12 看一下报 406，原因是 es 6.x 的版本增加了严格的请求头校验，返回结果为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">“error” : “Content-Type [header](https://so.csdn.net/so/search?q=header&amp;spm=1001.2101.3001.7020) [application/x-www-form-urlencoded] is not supported”,</span><br><span class="line">“status” : 406</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622151358131.png" alt="image-20220622151358131">解决方案：修改<code>vendor.js</code>文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将文件复制到本地</span></span><br><span class="line">docker cp es-head:/usr/src/app/_site/vendor.js ./</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进行修改（定位至6886行）</span></span><br><span class="line">        ajaxSettings: &#123;</span><br><span class="line">                url: ajaxLocation,</span><br><span class="line">                isLocal: rlocalProtocol.test( ajaxLocParts[ 1 ] ),</span><br><span class="line">                global: true,</span><br><span class="line">                type: &quot;GET&quot;,</span><br><span class="line">                contentType: &quot;application/json;charset=UTF-8&quot;,</span><br><span class="line">                processData: true,</span><br><span class="line">                async: true,</span><br><span class="line">                ...</span><br><span class="line">                ...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再复制到容器中</span></span><br><span class="line">docker cp vendor.js es-head:/usr/src/app/_site/</span><br></pre></td></tr></table></figure>

<p>修改前：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622152458877.png" alt="image-20220622152458877"></p>
<p>修改后：<br><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622152619484.png" alt="image-20220622152619484"></p>
<p>无需重启 es-head，刷新一下 head 页面即可：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622153010483.png" alt="image-20220622153010483"></p>
<hr>
<p>附件：…</p>
<h2 id="四、Docker-部署-ELK-集群"><a href="#四、Docker-部署-ELK-集群" class="headerlink" title="四、Docker 部署 ELK 集群"></a>四、Docker 部署 ELK 集群</h2><blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.docker.elastic.co/">官方 Docker 镜像</a></p>
</blockquote>
<h3 id="4-1-ES-集群"><a href="#4-1-ES-集群" class="headerlink" title="4.1 ES 集群"></a>4.1 ES 集群</h3><h4 id="4-1-1-ES-集群部署"><a href="#4-1-1-ES-集群部署" class="headerlink" title="4.1.1 ES 集群部署"></a>4.1.1 ES 集群部署</h4><p><strong>1、安装docker</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行安装脚本</span><br></pre></td></tr></table></figure>

<p><strong>2、创建 ES 相关目录</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/elasticsearch/data</span><br><span class="line">mkdir -p /data/elasticsearch/logs</span><br><span class="line">mkdir -p /data/elasticsearch/plugins</span><br><span class="line">mkdir -p /data/elasticsearch/config/</span><br></pre></td></tr></table></figure>

<p><strong>3、任意一个 ES 节点运行一个es临时容器，拷贝配置文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd \</span><br><span class="line">--name=tmp \</span><br><span class="line">-e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; \</span><br><span class="line">-e &quot;discovery.type=single-node&quot; \</span><br><span class="line">elasticsearch:6.8.23</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker cp tmp:/usr/share/elasticsearch/config /data/elasticsearch/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或（运行容器时直接映射elasticsearch目录即可）</span></span><br><span class="line">docker cp tmp:/usr/share/elasticsearch /data/</span><br></pre></td></tr></table></figure>

<p><strong>4、修改 ES 配置文件</strong></p>
<ul>
<li><p>es-1</p>
<blockquote>
<p>elasticsearch.yml</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cluster.name 三者需相同</span></span><br><span class="line">cluster.name: es-cluster</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.name 节点名，设置与主机名一致即可</span></span><br><span class="line">node.name: es-1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.master 符合成为主节点的条件</span></span><br><span class="line">node.master: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.data 符合成为数据节点的条件</span></span><br><span class="line">node.data: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.data 数据存储路径（下面会进行创建）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.data: /data/elasticsearch/data</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.logs 日志存储路径（下面会进行创建）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.logs: /data/elasticsearch/logs</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bootstrap.memory_lock 锁住内存，即只使用内存，不使用交换分区</span></span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network.host 允许所有IP访问</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network.publish_host 集群节点交互IP（docker方式的部署填写公网IP）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker 方式部署的需指定 network.publish_host，否则无法访问集群</span></span><br><span class="line">network.publish_host: 192.168.56.133</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http.port web访问端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping.unicast.hosts 关闭单播</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.56.133&quot;, &quot;192.168.56.134&quot;, &quot;192.168.56.135&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.minimum_master_nodes 指定master备选数（N/2+1）取整，N为集群节点数</span></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping_timeout 节点在发现过程中的等待超时时间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">discovery.zen.ping_timeout: 120s</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.fd.ping_retries 节点发现重试次数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">discovery.zen.fd.ping_retries: 10</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">client.transport.ping_timeout  ping命令的响应超时时间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">client.transport.ping_timeout: 60s</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决跨域问题</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>jvm.options</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># JVM configuration</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># IMPORTANT: JVM heap size</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># You should always set the min and max JVM heap</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># size to the same value. For example, to set</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># the heap to 4 GB, set:</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># -Xms4g</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># -Xmx4g</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># See https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># for more information</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Xms represents the initial size of total heap space</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Xmx represents the maximum size of total heap space</span></span><br><span class="line"></span><br><span class="line">-Xms512m</span><br><span class="line">-Xmx512m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Expert settings</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># All settings below this section are considered</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># expert settings. Don&#x27;t tamper with them unless</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># you understand what you are doing</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># GC configuration</span></span></span><br><span class="line">8-13:-XX:+UseConcMarkSweepGC</span><br><span class="line">8-13:-XX:CMSInitiatingOccupancyFraction=75</span><br><span class="line">8-13:-XX:+UseCMSInitiatingOccupancyOnly</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># G1GC Configuration</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NOTE: G1 GC is only supported on JDK version 10 or later</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to use G1GC, uncomment the next two lines and update the version on the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">following three lines to your version of the JDK</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10-13:-XX:-UseConcMarkSweepGC</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10-13:-XX:-UseCMSInitiatingOccupancyOnly</span></span><br><span class="line">14-:-XX:+UseG1GC</span><br><span class="line">14-:-XX:G1ReservePercent=25</span><br><span class="line">14-:-XX:InitiatingHeapOccupancyPercent=30</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># DNS cache policy</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cache ttl <span class="keyword">in</span> seconds <span class="keyword">for</span> positive DNS lookups noting that this overrides the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">JDK security property networkaddress.cache.ttl; <span class="built_in">set</span> to -1 to cache forever</span></span><br><span class="line">-Des.networkaddress.cache.ttl=60</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cache ttl <span class="keyword">in</span> seconds <span class="keyword">for</span> negative DNS lookups noting that this overrides the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">JDK security property networkaddress.cache.negative ttl; <span class="built_in">set</span> to -1 to cache</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">forever</span></span><br><span class="line">-Des.networkaddress.cache.negative.ttl=10</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># optimizations</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pre-touch memory pages used by the JVM during initialization</span></span><br><span class="line">-XX:+AlwaysPreTouch</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># basic</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">explicitly <span class="built_in">set</span> the stack size</span></span><br><span class="line">-Xss1m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> to headless, just <span class="keyword">in</span> <span class="keyword">case</span></span></span><br><span class="line">-Djava.awt.headless=true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ensure UTF-8 encoding by default (e.g. filenames)</span></span><br><span class="line">-Dfile.encoding=UTF-8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">use our provided JNA always versus the system one</span></span><br><span class="line">-Djna.nosys=true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">turn off a JDK optimization that throws away stack traces <span class="keyword">for</span> common</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">exceptions because stack traces are important <span class="keyword">for</span> debugging</span></span><br><span class="line">-XX:-OmitStackTraceInFastThrow</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">enable</span> helpful NullPointerExceptions (https://openjdk.java.net/jeps/358), <span class="keyword">if</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">they are supported</span></span><br><span class="line">14-:-XX:+ShowCodeDetailsInExceptionMessages</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">flags to configure Netty</span></span><br><span class="line">-Dio.netty.noUnsafe=true</span><br><span class="line">-Dio.netty.noKeySetOptimization=true</span><br><span class="line">-Dio.netty.recycler.maxCapacityPerThread=0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">log4j 2</span></span><br><span class="line">-Dlog4j.shutdownHookEnabled=false</span><br><span class="line">-Dlog4j2.disable.jmx=true</span><br><span class="line">-Dlog4j2.formatMsgNoLookups=true</span><br><span class="line"></span><br><span class="line">-Djava.io.tmpdir=$&#123;ES_TMPDIR&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># heap dumps</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">generate a heap dump when an allocation from the Java heap fails</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">heap dumps are created <span class="keyword">in</span> the working directory of the JVM</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">specify an alternative path <span class="keyword">for</span> heap dumps; ensure the directory exists and</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">has sufficient space</span></span><br><span class="line">-XX:HeapDumpPath=data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">specify an alternative path <span class="keyword">for</span> JVM fatal error logs</span></span><br><span class="line">-XX:ErrorFile=logs/hs_err_pid%p.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># JDK 8 GC logging</span></span></span><br><span class="line"></span><br><span class="line">8:-XX:+PrintGCDetails</span><br><span class="line">8:-XX:+PrintGCDateStamps</span><br><span class="line">8:-XX:+PrintTenuringDistribution</span><br><span class="line">8:-XX:+PrintGCApplicationStoppedTime</span><br><span class="line">8:-Xloggc:logs/gc.log</span><br><span class="line">8:-XX:+UseGCLogFileRotation</span><br><span class="line">8:-XX:NumberOfGCLogFiles=32</span><br><span class="line">8:-XX:GCLogFileSize=64m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">JDK 9+ GC logging</span></span><br><span class="line">9-:-Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">due to internationalization enhancements <span class="keyword">in</span> JDK 9 Elasticsearch need to <span class="built_in">set</span> the provider to COMPAT otherwise</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">time/date parsing will <span class="built_in">break</span> <span class="keyword">in</span> an incompatible way <span class="keyword">for</span> some <span class="built_in">date</span> patterns and locals</span></span><br><span class="line">9-:-Djava.locale.providers=COMPAT</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">temporary workaround <span class="keyword">for</span> C2 bug with JDK 10 on hardware with AVX-512</span></span><br><span class="line">10-:-XX:UseAVX=2</span><br></pre></td></tr></table></figure>
</li>
<li><p>es-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">同es-1，唯一不同的是 node.name 和 network.publish_host</span><br><span class="line">node.name: es-2</span><br><span class="line">network.publish_host: 192.168.56.134</span><br></pre></td></tr></table></figure>
</li>
<li><p>es-3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">同es-1，唯一不同的是 node.name 和 network.publish_host</span><br><span class="line">node.name: es-3</span><br><span class="line">network.publish_host: 192.168.56.135</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>5、运行容器</strong></p>
<ul>
<li><p>es-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker run -it \</span><br><span class="line">--name=es-1 \</span><br><span class="line">--privileged=true \</span><br><span class="line">--restart=always \</span><br><span class="line">-p 9200:9200 \</span><br><span class="line">-p 9300:9300 \</span><br><span class="line">-v /etc/localtime:/etc/localtime \</span><br><span class="line">-v /data/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v /data/elasticsearch/logs:/usr/share/elasticsearch/logs \</span><br><span class="line">-v /data/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-v /data/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /data/elasticsearch/config/jvm.options:/usr/share/elasticsearch/config/jvm.options \</span><br><span class="line">-d elasticsearch:6.8.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或（运行容器时直接映射elasticsearch目录即可）</span></span><br><span class="line">docker run -it \</span><br><span class="line">--name=es-1 \</span><br><span class="line">--privileged=true \</span><br><span class="line">--restart=always \</span><br><span class="line">--net=host \</span><br><span class="line">-v /etc/localtime:/etc/localtime \</span><br><span class="line">-v /data/elasticsearch:/usr/share/elasticsearch \</span><br><span class="line">-d elasticsearch:6.8.23</span><br></pre></td></tr></table></figure>
</li>
<li><p>es-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker run -it \</span><br><span class="line">--name=es-2 \</span><br><span class="line">--privileged=true \</span><br><span class="line">--restart=always \</span><br><span class="line">-p 9200:9200 \</span><br><span class="line">-p 9300:9300 \</span><br><span class="line">-v /etc/localtime:/etc/localtime \</span><br><span class="line">-v /data/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v /data/elasticsearch/logs:/usr/share/elasticsearch/logs \</span><br><span class="line">-v /data/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-v /data/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /data/elasticsearch/config/jvm.options:/usr/share/elasticsearch/config/jvm.options \</span><br><span class="line">-d elasticsearch:6.8.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或（运行容器时直接映射elasticsearch目录即可）</span></span><br><span class="line">docker run -it \</span><br><span class="line">--name=es-2 \</span><br><span class="line">--privileged=true \</span><br><span class="line">--restart=always \</span><br><span class="line">--net=host \</span><br><span class="line">-v /etc/localtime:/etc/localtime \</span><br><span class="line">-v /data/elasticsearch:/usr/share/elasticsearch \</span><br><span class="line">-d elasticsearch:6.8.23</span><br></pre></td></tr></table></figure>
</li>
<li><p>es-3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker run -it \</span><br><span class="line">--name=es-3 \</span><br><span class="line">--privileged=true \</span><br><span class="line">--restart=always \</span><br><span class="line">-p 9200:9200 \</span><br><span class="line">-p 9300:9300 \</span><br><span class="line">-v /etc/localtime:/etc/localtime \</span><br><span class="line">-v /data/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v /data/elasticsearch/logs:/usr/share/elasticsearch/logs \</span><br><span class="line">-v /data/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-v /data/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /data/elasticsearch/config/jvm.options:/usr/share/elasticsearch/config/jvm.options \</span><br><span class="line">-d elasticsearch:6.8.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或（运行容器时直接映射elasticsearch目录即可）</span></span><br><span class="line">docker run -it \</span><br><span class="line">--name=es-3 \</span><br><span class="line">--privileged=true \</span><br><span class="line">--restart=always \</span><br><span class="line">--net=host \</span><br><span class="line">-v /etc/localtime:/etc/localtime \</span><br><span class="line">-v /data/elasticsearch:/usr/share/elasticsearch \</span><br><span class="line">-d elasticsearch:6.8.23</span><br></pre></td></tr></table></figure></li>
</ul>
<p>&#x3D;&#x3D;es-head 插件安装看 3.5 小节&#x3D;&#x3D;</p>
<p>集群状态查看：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220622233940503.png" alt="image-20220622233940503"></p>
<p><strong>6、配置 ES 集群证书</strong></p>
<blockquote>
<ol>
<li><p>先保证在没有使用证书的情况下，ES 集群是正常运行的，然后再配置 ES 集群证书；</p>
</li>
<li><p>在任意 ES 集群节点上生成集群证书（本次我在 es-1 节点）；</p>
</li>
<li><p>证书生成完毕之后，再将对应证书 copy 到其他节点的 config 目录下；</p>
</li>
<li><p>重启 ES 集群，此时保证集群正常运行，如果此时集群正常，说明集群间已经通过密钥方式通信；</p>
</li>
<li><p>然后创建 ES 集群的用户名&#x2F;密码（在任意 ES 集群节点上执行即可，因为集群会同步状态）；</p>
</li>
<li><p>启用 ES 集群证书的目：数据安全、防止其他 ES 节点恶意并入集群。</p>
</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it es-1 bash</span><br><span class="line">./bin/elasticsearch-certutil ca</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会在当前目录生产elastic-stack-ca.p12证书文件</span></span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624141418370.png" alt="image-20220624141418370"></p>
<p>为集群中的每个节点生成证书和私钥：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624142040376.png" alt="image-20220624142040376"></p>
<p>复制证书文件到其他节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp elastic-* es-2:/data/elasticsearch/config/</span><br><span class="line">scp elastic-* es-3:/data/elasticsearch/config/</span><br></pre></td></tr></table></figure>

<p>接着修改 ES 集群配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cluster.name 三者需相同</span></span><br><span class="line">cluster.name: es-cluster</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.name 节点名，设置与主机名一致即可</span></span><br><span class="line">node.name: es-1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.master 符合成为主节点的条件</span></span><br><span class="line">node.master: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.data 符合成为数据节点的条件</span></span><br><span class="line">node.data: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.data 数据存储路径（下面会进行创建）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.data: /data/elasticsearch/data</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.logs 日志存储路径（下面会进行创建）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.logs: /data/elasticsearch/logs</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bootstrap.memory_lock 锁住内存，即只使用内存，不使用交换分区（有时会报错，报错时注释掉就行）</span></span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network.host 允许所有IP访问</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">network.publish_host 集群节点交互IP（docker方式的部署填写公网IP）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker 方式部署的需指定 network.publish_host，否则无法访问集群</span></span><br><span class="line">network.publish_host: 192.168.56.133</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http.port web访问端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping.unicast.hosts 关闭单播</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.56.133&quot;, &quot;192.168.56.134&quot;, &quot;192.168.56.135&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.minimum_master_nodes 指定master备选数（N/2+1）取整，N为集群节点数</span></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping_timeout 节点在发现过程中的等待超时时间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">discovery.zen.ping_timeout: 120s</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.fd.ping_retries 节点发现重试次数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">discovery.zen.fd.ping_retries: 10</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">client.transport.ping_timeout  ping命令的响应超时时间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">client.transport.ping_timeout: 60s</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决跨域问题</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Auth（如果你不配置证书，只是单纯的给ES设置密码，打开下面两项即可）</span></span><br><span class="line">xpack.security.enabled: true</span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果你需要使用证书请保持下列参数是打开状态</span></span><br><span class="line">xpack.security.transport.ssl.verification_mode: certificate</span><br><span class="line">xpack.security.transport.ssl.keystore.path: elastic-certificates.p12</span><br><span class="line">xpack.security.transport.ssl.truststore.path: elastic-certificates.p12</span><br></pre></td></tr></table></figure>

<p>重启 ES 集群：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker restart es-1</span><br><span class="line">docker restart es-2</span><br><span class="line">docker restart es-3</span><br></pre></td></tr></table></figure>

<p>新增用户名、密码：</p>
<blockquote>
<p>任意一台 ES 集群节点上执行即可，执行结果会同步到整个 ES 集群</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch-setup-passwords interactive</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我的密码为123456</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">西谷：Xgxy@2021!</span></span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624155056881.png" alt="image-20220624155056881"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Changed password for user [apm_system]</span><br><span class="line">Changed password for user [kibana]</span><br><span class="line">Changed password for user [logstash_system]</span><br><span class="line">Changed password for user [beats_system]</span><br><span class="line">Changed password for user [remote_monitoring_user]</span><br><span class="line">Changed password for user [elastic]</span><br></pre></td></tr></table></figure>

<p>上面的用户名密码在任意一台 ES 集群服务器上执行就行，密码会被更新到集群中，就算你在其他节点设置密码也是会报错的，而且会提示你，强一致性密码已经更新至集群，如下所示：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624155456231.png" alt="image-20220624155456231"></p>
<p><strong>7、keepalived 高可用</strong></p>
<p>因为集群环境下所有的 ES 节点都是平等的，所以用 keepalived 来做集群统一入口。</p>
<p>安装keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置文件路径：/etc/keepalived/keepalived.conf</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>es-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id es</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_es &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_es_status.sh&quot;</span><br><span class="line">    interval 5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 90</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.56.10/24</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_es</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>es-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id es</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_es &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_es_status.sh&quot;</span><br><span class="line">    interval 5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 90</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.56.10/24</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_es</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>es-3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id es</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_es &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_es_status.sh&quot;</span><br><span class="line">    interval 5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_3 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 90</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.56.10/24</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_es</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>健康检测脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/keepalived/check_es_status.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">docker ps |grep es-1</span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">    echo &quot;status ok&quot;</span><br><span class="line">else</span><br><span class="line">    systemctl stop keepalived.service</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>启动 keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived.service</span><br><span class="line">systemctl enable keepalived.service</span><br><span class="line">systemctl stop keepalived.service</span><br><span class="line">systemctl restart keepalived.service</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-ES-修改-x2F-忘记密码"><a href="#4-1-2-ES-修改-x2F-忘记密码" class="headerlink" title="4.1.2 ES 修改&#x2F;忘记密码"></a>4.1.2 ES 修改&#x2F;忘记密码</h4><blockquote>
<p>Kibana 可视化操作</p>
</blockquote>
<p><strong>1、点击用户页面对应的用户名</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624163946479.png" alt="image-20220624163946479"></p>
<p><strong>2、进入用户密码修改页面</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624164115642.png" alt="image-20220624164115642"></p>
<blockquote>
<p>如果忘记密码，可根据以下忘记密码步骤重置密码</p>
</blockquote>
<h4 id="4-3-2-ES-实例操作"><a href="#4-3-2-ES-实例操作" class="headerlink" title="4.3.2 ES 实例操作"></a>4.3.2 ES 实例操作</h4><p><strong>1、修改密码</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Content-Type:application/json&quot; -XPOST -u elastic &#x27;http://172.17.16.95:9200/_xpack/security/user/elastic/_password&#x27; -d &#x27;&#123; &quot;password&quot; : &quot;123456&quot; &#125;&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这种方式修改密码需要注意的是：</p>
<ol>
<li>之前设置过 elastic 的用户密码；</li>
<li>还记的用户 elastic 用户的密码。</li>
</ol>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220816141358233.png" alt="image-20220816141358233"></p>
<p><strong>2、忘记密码</strong></p>
<p>&#x3D;&#x3D;注意&#x3D;&#x3D;：如果忘记之前 elastic 用户的密码，这个时候又要用到 ES 的加密功能，那需要重置ES的密码认证。详细步骤如下：</p>
<p>&#x3D;&#x3D;方法1：&#x3D;&#x3D;</p>
<ul>
<li><p>关闭密码使用策略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /data/elasticsearch/config/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220816141705539.png" alt="image-20220816141705539"></p>
</li>
<li><p>重启 ES</p>
<blockquote>
<p>重启 ES 后，查看索引，发现多了一个<code>.security-6</code></p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220816142328223.png" alt="image-20220816142328223"></p>
</li>
<li><p>删除<code>.security-6</code>索引</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE http://10.150.16.95:9200/.security-6 &#123;&quot;acknowledged&quot;:true&#125;[root@qcloud elasticsearch]</span><br></pre></td></tr></table></figure>
</li>
<li><p>ES 启用密码使用策略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /data/elasticsearch/config/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220816161352121.png" alt="image-20220816161352121"></p>
</li>
<li><p>重启 ES</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart es-1</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入容器开始时初始化密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">看2.2部分</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>&#x3D;&#x3D;方法2（推荐）：&#x3D;&#x3D;</p>
<ul>
<li><p>进入容器，创建一个管理用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@qcloud elasticsearch]# docker exec -it es-1 bash</span><br><span class="line">[root@qcloud elasticsearch]# ./bin/elasticsearch-users useradd newadmin -p password -r superuser</span><br><span class="line">[root@qcloud elasticsearch]# ./bin/elasticsearch-users list</span><br><span class="line">newadmin       : superuser</span><br></pre></td></tr></table></figure>
</li>
<li><p>退出容器，并修改密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -s --user newadmin:password -XPUT &quot;http://10.150.16.95:9200/_xpack/security/user/elastic/_password?pretty&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;password&quot; : &quot;zhurs@123&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Kibana 登录</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220816162722239.png" alt="image-20220816162722239"></p>
</li>
</ul>
<h3 id="4-2-Logstash-分流"><a href="#4-2-Logstash-分流" class="headerlink" title="4.2 Logstash 分流"></a>4.2 Logstash 分流</h3><blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/logstash/current/index.html">《官方文档》</a></p>
</blockquote>
<p><strong>1、下载镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co/logstash/logstash:6.8.23</span><br></pre></td></tr></table></figure>

<p><strong>2、运行临时容器，并拷贝配置文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=tmp logstash:6.8.23</span><br><span class="line">docker cp tmp:/usr/share/logstash /data/</span><br></pre></td></tr></table></figure>

<p><strong>3、创建配置文件并授权</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/logstash/config/conf.d</span><br><span class="line">chmod 777 -R /data/logstash</span><br></pre></td></tr></table></figure>

<p><strong>4、修改配置文件</strong></p>
<ul>
<li><p>修改前</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /data/logstash/config/logstash.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627113158512.png" alt="image-20220627113158512"></p>
</li>
<li><p>修改后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat /data/logstash/config/logstash.yml</span><br><span class="line"></span><br><span class="line">http.host: &quot;0.0.0.0&quot;</span><br><span class="line">xpack.monitoring.enabled: true</span><br><span class="line">xpack.monitoring.elasticsearch.username: &quot;elastic&quot;</span><br><span class="line">xpack.monitoring.elasticsearch.password: &quot;123456&quot;</span><br><span class="line">xpack.monitoring.elasticsearch.hosts: [ &quot;http://192.168.56.133:9200&quot;,&quot;http://192.168.56.134:9200&quot;,&quot;http://192.168.56.135:9200&quot; ]</span><br><span class="line">path.config: /usr/share/logstash/config/conf.d/*.conf</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627164557104.png" alt="image-20220627164557104"></p>
</li>
</ul>
<p><strong>5、启动容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">桥接</span></span><br><span class="line">docker run -d \</span><br><span class="line">  --name=logstash \</span><br><span class="line">  --privileged=true \</span><br><span class="line">  --restart=always \</span><br><span class="line">  -p 5044:5044 \</span><br><span class="line">  -v /etc/localtime:/etc/localtime \</span><br><span class="line">  -v /data/logstash:/usr/share/logstash \</span><br><span class="line">  logstash:6.8.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">host（本次采用）</span></span><br><span class="line">docker run -d \</span><br><span class="line">  --name=logstash \</span><br><span class="line">  --privileged=true \</span><br><span class="line">  --restart=always \</span><br><span class="line">  --net=host \</span><br><span class="line">  -v /etc/localtime:/etc/localtime \</span><br><span class="line">  -v /data/logstash:/usr/share/logstash \</span><br><span class="line">  logstash:6.8.23</span><br></pre></td></tr></table></figure>

<blockquote>
<p>接下来看看二进制部署的 Logstash</p>
</blockquote>
<p><strong>1、JDK 环境</strong></p>
<p>上面有安装步骤</p>
<p><strong>2、解压</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xzf logstash-6.8.23.tar.gz -C /data/</span><br><span class="line">mv /data/logstash-6.8.23/ /data/logstash</span><br></pre></td></tr></table></figure>

<p><strong>3、创建配置文件目录</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/logstash/config/conf.d</span><br></pre></td></tr></table></figure>

<p><strong>4、编写配置文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim /data/logstash/config/conf.d/all.conf</span><br><span class="line"></span><br><span class="line">input&#123;</span><br><span class="line">    file&#123;</span><br><span class="line">        path =&gt; [&quot;/data/nginx/logs/access.log&quot;]</span><br><span class="line">        type =&gt; &quot;nginx_access&quot;</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">input&#123;</span><br><span class="line">    file&#123;</span><br><span class="line">        path =&gt; [&quot;/var/log/messages&quot;]</span><br><span class="line">        type =&gt; &quot;system_error&quot;</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output&#123;</span><br><span class="line">    if [type] ==  &quot;nginx_access&quot; &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;] </span><br><span class="line">            index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">    if [type] ==  &quot;system_error&quot; &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;] </span><br><span class="line">            index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">前台启动</span></span><br><span class="line">/data/logstash/bin/logstash -f /data/logstash/config/conf.d/ --config.reload.automatic</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">后台启动</span></span><br><span class="line">nohup /data/logstash/bin/logstash -f /data/logstash/config/conf.d/ --config.reload.automatic &amp;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--config.reload.automatic：可以加载conf.d 目录下的所有.conf文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">想要单独加载的话，则去掉--config.reload.automatic参数，并指定具体的 .conf 文件</span></span><br></pre></td></tr></table></figure>

<p><strong>5、集群验证</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623102312200.png" alt="image-20220623102312200"></p>
<h3 id="4-3-Kibana-前端展示"><a href="#4-3-Kibana-前端展示" class="headerlink" title="4.3 Kibana 前端展示"></a>4.3 Kibana 前端展示</h3><blockquote>
<p>官方文档：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/cn/kibana/current/index.html">https://www.elastic.co/guide/cn/kibana/current/index.html</a></p>
</blockquote>
<p><strong>1、安装 es-head 插件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name=es-head \</span><br><span class="line">  --privileged=true \</span><br><span class="line">  --restart=always \</span><br><span class="line">  -v /etc/localtime:/etc/localtime \</span><br><span class="line">  -p 9100:9100 \</span><br><span class="line">  docker.io/mobz/elasticsearch-head:5-alpine</span><br></pre></td></tr></table></figure>

<p><strong>2、安装 Kibana</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行临时容器</span></span><br><span class="line">docker run -itd --name=tmp kibana:6.8.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝相关目录</span></span><br><span class="line">docker cp tmp:/usr/share/kibana /data/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">授权</span></span><br><span class="line">chmod 777 -R /data/kibana/*</span><br></pre></td></tr></table></figure>

<p><strong>3、修改配置文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /data/kibana/config/kibana.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Default Kibana configuration <span class="keyword">for</span> docker target</span></span><br><span class="line">server.name: kibana</span><br><span class="line">server.host: &quot;0&quot;</span><br><span class="line">elasticsearch.hosts: [ &quot;http://192.168.56.133:9200&quot;,&quot;http://192.168.56.134:9200&quot;,&quot;http://192.168.56.135:9200&quot; ]</span><br><span class="line">xpack.monitoring.ui.container.elasticsearch.enabled: true</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">kibana.index: <span class="string">&quot;.kibana&quot;</span></span></span><br><span class="line">i18n.locale: &quot;zh-CN&quot;</span><br><span class="line">elasticsearch.username: &quot;kibana&quot;</span><br><span class="line">elasticsearch.password: &quot;123456&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">xpack.reporting.encryptionKey: <span class="string">&quot;a_random_string&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">xpack.security.encryptionKey: <span class="string">&quot;something_at_least_32_characters&quot;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>4、启动新容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --restart=always \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    --name=kibana \</span><br><span class="line">	-p 5601:5601 \</span><br><span class="line">	-v &quot;/data/kibana:/usr/share/kibana&quot; \</span><br><span class="line">	-v /etc/localtime:/etc/localtime \</span><br><span class="line">	kibana:6.8.23</span><br></pre></td></tr></table></figure>

<p><strong>5、访问验证</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://192.168.56.136:5601/">http://192.168.56.136:5601/</a></p>
</blockquote>
<p>输入账号密码：&lt;账号密码就是你配置ES时的密码&gt;</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624155844791.png" alt="image-20220624155844791"></p>
<blockquote>
<p>然后就会进入登录页面。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623123020509.png" alt="image-20220623123020509"></p>
<blockquote>
<p>上图是我之前截的图，当时没有设置 ES 集群密码强一致性验证，设置之后你会发现管理菜单下会多出一个安全性&#x3D;&#x3D;&gt;<code>用户/角色</code></p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624160113968.png" alt="image-20220624160113968"></p>
<h3 id="4-4-Nginx-反向代理"><a href="#4-4-Nginx-反向代理" class="headerlink" title="4.4 Nginx 反向代理"></a>4.4 Nginx 反向代理</h3><p><strong>1、安装 Nginx</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">看6.2.4</span></span><br><span class="line">docker run -itd \</span><br><span class="line">    --name=nginx \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    --restart=always \</span><br><span class="line">    --net=host \</span><br><span class="line">    -v /etc/localtime:/etc/localtime \</span><br><span class="line">    -v /data/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">    -v /data/nginx/conf/conf.d:/etc/nginx/conf.d \</span><br><span class="line">    -v /data/nginx/html:/usr/share/nginx/html \</span><br><span class="line">    -v /data/nginx/logs:/var/log/nginx nginx:1.20.2</span><br></pre></td></tr></table></figure>

<p><strong>2、反向代理</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  192.168.56.136;</span><br><span class="line"></span><br><span class="line">    # kibana前端展示</span><br><span class="line">    location / &#123;</span><br><span class="line">        root  html;</span><br><span class="line">        proxy_pass http://192.168.56.136:5601/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # es-head插件</span><br><span class="line">    location /head/ &#123;</span><br><span class="line">        proxy_pass http://192.168.56.136:9100/;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    # Kafka-Manager可视化管理</span><br><span class="line">    location /manager/ &#123;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass http://192.168.56.136:9000/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-Zookeeper-集群"><a href="#4-5-Zookeeper-集群" class="headerlink" title="4.5 Zookeeper 集群"></a>4.5 Zookeeper 集群</h3><p><strong>1、pull 镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper:3.7.1</span><br></pre></td></tr></table></figure>

<p><strong>2、创建对应目录</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/zookeeper/conf</span><br><span class="line">mkdir -p /data/zookeeper/data</span><br><span class="line">mkdir -p /data/zookeeper/datalog</span><br><span class="line">mkdir -p /data/zookeeper/logs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置文件路径：/data/zookeeper/conf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据存储路径：/data/zookeeper/data</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据日志存储路径：/data/zookeeper/datalog</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志存储路径：/data/zookeeper/logs</span></span><br></pre></td></tr></table></figure>

<p><strong>3、创建配置文件</strong></p>
<blockquote>
<p>三个节点均添加</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data</span><br><span class="line">dataLogDir=/datalog</span><br><span class="line">quorumListenOnAllIPs=true</span><br><span class="line">clientPort=2181 </span><br><span class="line">tickTime=2000 </span><br><span class="line">initLimit=20 </span><br><span class="line">syncLimit=10 </span><br><span class="line">server.1=192.168.56.137:2888:3888;2181</span><br><span class="line">server.2=192.168.56.138:2888:3888;2181</span><br><span class="line">server.3=192.168.56.139:2888:3888;2181</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基础参数说明：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tickTime：心跳检测时间</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">initLimit：follower连接到leader的初始化时间 --&gt; 10*2000=20s</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">quorumListenOnAllIPs：是否在所有可用的IP上监听来自其对等节点的连接请求，默认值为<span class="literal">false</span>，这意味着只在zoo.cfg中配置的服务器ip地址上监听连接请求</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">autopurge.snapRetainCount：保留的快照文件数目，默认是保留3个 --&gt; 自动清理Zookeeper的历史数据</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">autopurge.purgeInterval：清理频率（单位是小时），默认是0，表示不开启自动清理功能 --&gt; 自动清理Zookeeper的历史数据</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口说明：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2181：对Client端提供服务的端口（可自定义）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2888：集群内部通信端口（可自定义）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3888：选举Leader的端口（可自定义）</span></span><br></pre></td></tr></table></figure>

<p><strong>4、启动 ZK 集群</strong></p>
<blockquote>
<p>zk-1 部署于 kafka-1 服务器上</p>
<p>zk-2 部署于 kafka-2 服务器上</p>
<p>zk-3 部署于 kafka-3 服务器上</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zk-1</span></span><br><span class="line">docker run -d \</span><br><span class="line">   --restart=always \</span><br><span class="line">   --name=zk-1 \</span><br><span class="line">   --privileged=true \</span><br><span class="line">   --net=host \</span><br><span class="line">   -e ZOO_MY_ID=1 \</span><br><span class="line">   -v /data/zookeeper/conf/zoo.cfg:/conf/zoo.cfg \</span><br><span class="line">   -v /data/zookeeper/data:/data \</span><br><span class="line">   -v /data/zookeeper/datalog:/datalog \</span><br><span class="line">   -v /data/zookeeper/logs:/logs \</span><br><span class="line">   -v /etc/localtime:/etc/localtime \</span><br><span class="line">   zookeeper:3.7.1</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zk-2</span></span><br><span class="line">docker run -d \</span><br><span class="line">   --restart=always \</span><br><span class="line">   --name zk-2 \</span><br><span class="line">   --privileged=true \</span><br><span class="line">   --net=host \</span><br><span class="line">   -e ZOO_MY_ID=2 \</span><br><span class="line">   -v /data/zookeeper/conf/zoo.cfg:/conf/zoo.cfg \</span><br><span class="line">   -v /data/zookeeper/data:/data \</span><br><span class="line">   -v /data/zookeeper/datalog:/datalog \</span><br><span class="line">   -v /data/zookeeper/logs:/logs \</span><br><span class="line">   -v /etc/localtime:/etc/localtime \</span><br><span class="line">   zookeeper:3.7.1</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zk-3</span></span><br><span class="line">docker run -d \</span><br><span class="line">   --restart=always \</span><br><span class="line">   --name zk-3 \</span><br><span class="line">   --privileged=true \</span><br><span class="line">   --net=host \</span><br><span class="line">   -e ZOO_MY_ID=3 \</span><br><span class="line">   -v /data/zookeeper/conf/zoo.cfg:/conf/zoo.cfg \</span><br><span class="line">   -v /data/zookeeper/data:/data \</span><br><span class="line">   -v /data/zookeeper/datalog:/datalog \</span><br><span class="line">   -v /data/zookeeper/logs:/logs \</span><br><span class="line">   -v /etc/localtime:/etc/localtime \</span><br><span class="line">   zookeeper:3.7.1</span><br></pre></td></tr></table></figure>

<p><strong>5、查看集群选举情况</strong></p>
<blockquote>
<p>看到 leader 为 zk-2，只要其中某一台服务器挂了，剩余两者会进行 leader 选举。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@kafka-1 ~]# docker exec -it zk-1 bash</span><br><span class="line">root@kafka-1:/apache-zookeeper-3.7.1-bin# bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: false.</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line">[root@kafka-2 ~]# docker exec -it zk-2 bash</span><br><span class="line">root@kafka-2:/apache-zookeeper-3.7.1-bin# bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: false.</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line">[root@kafka-3 ~]# docker exec -it zk-3 bash</span><br><span class="line">root@kafka-3:/apache-zookeeper-3.7.1-bin# bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: false.</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;至此，ZK 集群部署完毕！&#x3D;&#x3D;</p>
<h3 id="4-6-Kafka-集群"><a href="#4-6-Kafka-集群" class="headerlink" title="4.6 Kafka 集群"></a>4.6 Kafka 集群</h3><p><strong>1、pull 镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull bitnami/kafka:3.1.1</span><br></pre></td></tr></table></figure>

<p><strong>2、运行容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kafka-1</span></span><br><span class="line">docker run -d \</span><br><span class="line">    --name=kafka-1 \</span><br><span class="line">    --restart=always \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    --net=host \</span><br><span class="line">    -e KAFKA_BROKER_ID=1 \</span><br><span class="line">    -e KAFKA_ZOOKEEPER_CONNECT=&quot;192.168.56.137:2181,192.168.56.138:2181,192.168.56.139:2181&quot; \</span><br><span class="line">    -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.56.137:9092 \</span><br><span class="line">    -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line">    -e ALLOW_PLAINTEXT_LISTENER=yes \</span><br><span class="line">    -v /etc/localtime:/etc/localtime \</span><br><span class="line">    -t bitnami/kafka:3.1.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kafka-2</span></span><br><span class="line">docker run -d \</span><br><span class="line">    --name=kafka-2 \</span><br><span class="line">    --restart=always \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    --net=host \</span><br><span class="line">    -e KAFKA_BROKER_ID=2 \</span><br><span class="line">    -e KAFKA_ZOOKEEPER_CONNECT=&quot;192.168.56.137:2181,192.168.56.138:2181,192.168.56.139:2181&quot; \</span><br><span class="line">    -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.56.138:9092 \</span><br><span class="line">    -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line">    -e ALLOW_PLAINTEXT_LISTENER=yes \</span><br><span class="line">    -v /etc/localtime:/etc/localtime \</span><br><span class="line">    -t bitnami/kafka:3.1.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kafka-3</span></span><br><span class="line">docker run -d \</span><br><span class="line">    --name=kafka-3 \</span><br><span class="line">    --restart=always \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    --net=host \</span><br><span class="line">    -e KAFKA_BROKER_ID=3 \</span><br><span class="line">    -e KAFKA_ZOOKEEPER_CONNECT=&quot;192.168.56.137:2181,192.168.56.138:2181,192.168.56.139:2181&quot; \</span><br><span class="line">    -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.56.139:9092 \</span><br><span class="line">    -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line">    -e ALLOW_PLAINTEXT_LISTENER=yes \</span><br><span class="line">    -v /etc/localtime:/etc/localtime \</span><br><span class="line">    -t bitnami/kafka:3.1.1</span><br></pre></td></tr></table></figure>

<p><strong>3、安装 kafka-manager 管理工具</strong></p>
<blockquote>
<p>我们在 kibana 上部署</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull sheepkiller/kafka-manager:stable</span><br></pre></td></tr></table></figure>

<blockquote>
<p>运行容器</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --name=kafka-manager \</span><br><span class="line">    --restart=always \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    -p 9000:9000 \</span><br><span class="line">    -e ZK_HOSTS=&quot;192.168.56.137:2181,192.168.56.138:2181,192.168.56.139:2181&quot; \</span><br><span class="line">    sheepkiller/kafka-manager:stable</span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器访问：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://192.168.56.136:9000/">http://192.168.56.136:9000/</a></p>
</blockquote>
<p>创建 Kafka 集群节点，来查看当前集群状态：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623215647425.png" alt="image-20220623215647425"></p>
<p>依次建立即可：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623215853651.png" alt="image-20220623215853651"></p>
<p>看看集群状态：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623220003302.png" alt="image-20220623220003302"></p>
<p>进入 Brokers 查看，每一个 Brokers 代表一个 Kafka 实例，这里显示为 3 ，所以我们的集群实例为三个：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220623220148318.png" alt="image-20220623220148318"></p>
<p>&#x3D;&#x3D;至此，Kafka集群部署完毕！&#x3D;&#x3D;</p>
<h3 id="4-7-Filebeat-原理及应用"><a href="#4-7-Filebeat-原理及应用" class="headerlink" title="4.7 Filebeat 原理及应用"></a>4.7 Filebeat 原理及应用</h3><blockquote>
<p>官方文档：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/6.8/index.html">Doc</a></p>
</blockquote>
<h4 id="4-7-1-架构图"><a href="#4-7-1-架构图" class="headerlink" title="4.7.1 架构图"></a>4.7.1 架构图</h4><p>Filebeat 隶属于Beats，一款轻量级的数据收集引擎，那它如何工作于 ELK 集群中呢？</p>
<p>Filebeat 安装在要收集日志的应用服务器中，Filebeat收集到日志之后传输到kafka中，logstash通过kafka拿到日志，在由logstash传给后面的es，es将日志传给后面的kibana，最后通过kibana展示出来。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/filebeat.png" alt="filebeat"></p>
<h4 id="4-7-2-工作原理"><a href="#4-7-2-工作原理" class="headerlink" title="4.7.2 工作原理"></a>4.7.2 工作原理</h4><p><strong>1、输入</strong></p>
<p>比如定义了一个输入类型（type）为 log 的源，在启动 filebeat 时，输入查找驱动器会匹配全局（glob）路径（path）的所有文件，并为每个文件启动一个收集器（harvester），且每个输入都在自己的 go 进程中运行。只有当收集文件有新内容时才会启动（harvester）。</p>
<p><strong>2、如何保持文件状态</strong></p>
<p>在实际中会有个问题，如果输出（Kafka、ES、Kibana）无法连接（访问）时，filebeat 如何保持文件状态？该文件内容是否成功发送给输出？</p>
<p>答案是可以的，<code>Filebeat 会保存每个文件的状态</code>，它会把<code>注册表文件中的状态</code>刷新到磁盘，该状态记录了<code>harvester</code>读取文件的最后一个偏移量，如果此时无法访问 Elasticsearch 或 Logstash 等输出，Filebeat 会跟踪发送的最后几行，并在输出再次可用时继续读取文件，从而确保发送所有日志行。</p>
<p>在 Filebeat 运行时，每个输入的状态信息也会保存在内存中。当 Filebeat 重新启动时，来自注册表文件的数据用于重建状态，并且 Filebeat 在最后一个已知位置继续每个 <code>harvester</code>（即继续采集当前最新数据并输出到输出目标）。</p>
<p>也就是说只有 <code>Filebeat</code> 将 <code>harvester</code> 到的日志内容成功发送到输出目标（Kafka、ES、Kibana），且直到输出确认它已收到事件时，才会开启下一轮的 <code>harvester</code> 。如果在发送事件的过程中关闭 <code>Filebeat</code>，它不会在关闭前等待输出确认所有事件是否收到，&#x3D;&#x3D;任何发送到输出但在 Filebeat 关闭之前未确认的事件，在 Filebeat 重新启动时会再次发送&#x3D;&#x3D;。这可确保每个事件至少发送一次，但最终可能会将重复的事件发送到输出。我们可以通过设置 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/6.8/configuration-general-options.html#shutdown-timeout"><code>shutdown_timeout</code></a> 选项将 Filebeat 配置为在关闭之前等待特定的时间。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803115450602.png" alt="image-20220803115450602"></p>
<p><strong>3、确保至少一次交付</strong></p>
<p>由于 filebeat 可保持文件状态。</p>
<p>&#x3D;&#x3D;Filebeat 默认 30s 检测一次文件是否有变化。&#x3D;&#x3D;</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803181401142.png" alt="image-20220803181401142"></p>
<p><strong>4、实战看看偏移量</strong></p>
<p>初始化完成后，会有一个文件来存储采集文件状态 <code>/data/filebeat/data/registry</code></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803182713495.png" alt="image-20220803182713495"></p>
<p>此时，我新建一个 yml 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br></pre></td></tr></table></figure>

<p>新建 <code>/tmp/test.log</code> 文件并写入数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /tmp/test.log</span><br><span class="line">echo &quot;sdcnnwinhwwwwwwwwwwwwwwwwwwwwwwwwwwww&quot; &gt;&gt; /tmp/test.log</span><br></pre></td></tr></table></figure>

<p>启动 filebeat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c conf.d/01.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803183210042.png" alt="image-20220803183210042"></p>
<p>查看 Filebeat 存储文件状态的文件内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /data/filebeat/data/registry</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个registry文件根据你部署的方式不同，位置也会有所不同啊，一般就在你Filebeat的数据目录下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">看到下图，该文件存储了采集数据的源文件及偏移量（下图红框）</span></span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803183244080.png" alt="image-20220803183244080"></p>
<p>再来看看源文件自身文件大小</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">文件大小为53，刚好与偏移量相同，因此我们现在就很明白了，当filebeat出现故障时，它会记录下源文件的偏移量，且在恢复时从该偏移量开始读取数据并发送数据到输出（Kafka、ES），实现数据的完整性。</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803183312130.png" alt="image-20220803183312130"></p>
<h4 id="4-7-3-部署及应用"><a href="#4-7-3-部署及应用" class="headerlink" title="4.7.3 部署及应用"></a>4.7.3 部署及应用</h4><p><strong>1、安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在要收集的日志的服务器上部署该插件</span></span><br><span class="line">tar xzf filebeat-6.8.23-linux-x86_64.tar.gz -C /data/</span><br><span class="line">mv /data/filebeat-6.8.23-linux-x86_64/ /data/filebeat</span><br></pre></td></tr></table></figure>

<p><strong>2、配置</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/filebeat/</span><br><span class="line">cp filebeat.yml filebeat.yml.bak</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat filebeat.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">=========================== Filebeat inputs =============================</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  json.keys_under_root: true</span><br><span class="line">  json.add_error_key: true</span><br><span class="line">  json.message_key: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data/nginx/logs/access.log</span><br><span class="line">    - /data/nginx/logs/error.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">============================= Kafka outputs =============================</span></span><br><span class="line">output.kafka:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;192.168.56.137:9092&quot;,&quot;192.168.56.138:9092&quot;,&quot;192.168.56.139:9092&quot;]</span><br><span class="line">  topic: filebeat_test</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">说明：paths 可以指定多个路径</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>运行 filebeat</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">前台启动</span></span><br><span class="line">/data/filebeat/filebeat -e -c filebeat.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">后台启动</span></span><br><span class="line">nohup /data/filebeat/filebeat -e -c filebeat.yml &amp;</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;Docker 方式如何部署 Filebeat ？&#x3D;&#x3D;</p>
<ul>
<li><p>创建相关目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/docker_container/</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行临时容器（复制相关目录到宿主机）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp tmp:/usr/share/filebeat /data/docker_container/</span><br></pre></td></tr></table></figure>
</li>
<li><p>赋予权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 -R /data/docker_container/filebeat/</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除临时容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f tmp</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动新容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">普通docker中创建</span></span><br><span class="line">docker run -itd \</span><br><span class="line">  --privileged=true \</span><br><span class="line">  --restart=always \</span><br><span class="line">  --name=filebeat \</span><br><span class="line">  --hostname=filebeat \</span><br><span class="line">  -v /data/docker_container/filebeat:/usr/share/filebeat \</span><br><span class="line">  -v /data/nginx/logs:/data/nginx/logs \</span><br><span class="line">  -v /etc/localtime:/etc/localtime \</span><br><span class="line">  docker.elastic.co/beats/filebeat:6.8.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker swarm 集群中创建</span></span><br><span class="line">docker service create \</span><br><span class="line">  --replicas 1 \</span><br><span class="line">  --name filebeat \</span><br><span class="line">  --network my-network \</span><br><span class="line">  --hostname=&quot;filebeat&quot; \</span><br><span class="line">  --constraint &#x27;node.labels.label == filebeat1&#x27; \</span><br><span class="line">  --mount type=bind,src=/data/docker_container/filebeat,dst=/usr/share/filebeat \</span><br><span class="line">  --mount type=bind,src=/data/nginx/logs,dst=/data/nginx/logs \</span><br><span class="line">  --mount type=bind,src=/etc/localtime,dst=/etc/localtime \</span><br><span class="line">  docker.elastic.co/beats/filebeat:6.8.23</span><br><span class="line"></span><br><span class="line">docker service create \</span><br><span class="line">  --replicas 1 \</span><br><span class="line">  --name filebeat \</span><br><span class="line">  --network my-network \</span><br><span class="line">  --hostname=&quot;filebeat&quot; \</span><br><span class="line">  --constraint &#x27;node.labels.label == filebeat1&#x27; \</span><br><span class="line">  --mount type=bind,src=/data/docker_container/filebeat,dst=/usr/share/filebeat \</span><br><span class="line">  --mount type=bind,src=/data/nginx/logs,dst=/data/nginx/logs \</span><br><span class="line">  --mount type=bind,src=/etc/localtime,dst=/etc/localtime \</span><br><span class="line">  docker.elastic.co/beats/filebeat:6.8.23 \</span><br><span class="line">  filebeat -e -c /usr/share/filebeat/conf.d/nginx_logs.yml</span><br><span class="line"></span><br><span class="line">=================以下为测试，忽略即可===================</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加命令</span></span><br><span class="line">docker service create \</span><br><span class="line">  --replicas 1 \</span><br><span class="line">  --name filebeat \</span><br><span class="line">  --network my-network \</span><br><span class="line">  --hostname=&quot;filebeat&quot; \</span><br><span class="line">  --constraint &#x27;node.labels.label == filebeat1&#x27; \</span><br><span class="line">  --mount type=bind,src=/data/docker_container/filebeat,dst=/usr/share/filebeat \</span><br><span class="line">  --mount type=bind,src=/data/nginx/logs,dst=/data/nginx/logs \</span><br><span class="line">  --mount type=bind,src=/etc/localtime,dst=/etc/localtime \</span><br><span class="line">  docker.elastic.co/beats/filebeat:6.8.23 \</span><br><span class="line">  -e -c /usr/share/filebeat/conf.d/nginx_logs.yml</span><br><span class="line">  </span><br><span class="line">docker service create \</span><br><span class="line">  --replicas 1 \</span><br><span class="line">  --name filebeat2 \</span><br><span class="line">  --network my-network \</span><br><span class="line">  --hostname=&quot;filebeat&quot; \</span><br><span class="line">  --constraint &#x27;node.labels.label == filebeat2&#x27; \</span><br><span class="line">  --mount type=bind,src=/data/docker_container/filebeat,dst=/usr/share/filebeat \</span><br><span class="line">  --mount type=bind,src=/data/nginx/logs,dst=/data/nginx/logs \</span><br><span class="line">  --mount type=bind,src=/etc/localtime,dst=/etc/localtime \</span><br><span class="line">  docker.elastic.co/beats/filebeat:6.8.23 \</span><br><span class="line">  -e -c /usr/share/filebeat/conf.d/nginx_logs.yml</span><br><span class="line">  </span><br><span class="line">docker service create \</span><br><span class="line">  --replicas 1 \</span><br><span class="line">  --name filebeat \</span><br><span class="line">  --network my-network \</span><br><span class="line">  --hostname=&quot;filebeat&quot; \</span><br><span class="line">  --constraint &#x27;node.labels.label == filebeat-m&#x27; \</span><br><span class="line">  --mount type=bind,src=/data/docker_container/filebeat,dst=/usr/share/filebeat \</span><br><span class="line">  --mount type=bind,src=/data/nginx/logs,dst=/data/nginx/logs \</span><br><span class="line">  --mount type=bind,src=/etc/localtime,dst=/etc/localtime \</span><br><span class="line">  docker.elastic.co/beats/filebeat:6.8.23 \</span><br><span class="line">  -e -c /usr/share/filebeat/conf.d/nginx_logs.yml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>docker swarm 集群启动服务后，报错了，错误日志显示为文件权限问题，按照提示修改即可</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service logs filebeat</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220808162208549.png" alt="image-20220808162208549"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod go-w /data/docker_container/filebeat/filebeat.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：/usr/share/filebeat/filebeat.yml已经被持久化了</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>&#x3D;&#x3D;扩展：启动后 Filebeat 容器后，它执行了哪些命令？&#x3D;&#x3D;</p>
<ul>
<li><p>先看看镜像层是如何实现的？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初略的看看镜像构建过程</span></span><br><span class="line">docker history &lt;image-name:tags&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">详细看镜像构建过程</span></span><br><span class="line">docker image inspect &lt;image-name:tags&gt;</span><br></pre></td></tr></table></figure>



<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220808181035427.png" alt="image-20220808181035427"></p>
</li>
<li><p>启动容器后，会默认执行 <code>filebeat -e</code></p>
<p>之所以会执行filebeat -e，是因为其镜像层中的 <code>ENTRYPOINT</code> 和 <code>CMD</code>，熟悉 Docker 的都知道，ENTRYPOINT 语句肯定会执行，如果有 CMD 参数，那 CMD 参数将会作为 ENTRYPOINT 的选项参数而执行。</p>
</li>
</ul>
<p><strong>3、查看 kafka 集群状态</strong></p>
<p>可以看到新增了一个 Topics，说明 filebeat 采集的数据成功输出到了 Kafka 集群中了。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624103042003.png" alt="image-20220624103042003"></p>
<p>点击进去看看是否是我们上面定义的 <code>Topic: filebeat_test</code></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624103408352.png" alt="image-20220624103408352"></p>
<p><strong>4、这个时候就需要消费者来消费我这条数据了</strong></p>
<p>从 ELK 集群架构上看，消费者是我们的 ES 集群，那 ES 集群如何消费 Kafka 集群的消息呢？答案是通过 Logstash，为什么这里还要使用 logstash？原因是其具备 <code>input ---&gt; filter ---&gt; output</code> 的流功能，当然，filebeat 可以将数据直接发送到 ES 集群。</p>
<ul>
<li><p>配置 logstash</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        type =&gt; &quot;filebeat_test_log&quot;</span><br><span class="line">        codec =&gt; &quot;json&quot;</span><br><span class="line">        topics =&gt; &quot;filebeat_test&quot;</span><br><span class="line">        decorate_events =&gt; true</span><br><span class="line">        bootstrap_servers =&gt; &quot;192.168.56.137:9092, 192.168.56.138:9092, 192.168.56.139:9092&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">        user =&gt; &quot;elastic&quot;</span><br><span class="line">        password =&gt; &quot;123456&quot;</span><br><span class="line">        index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行 logstash</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/logstash/bin/logstash -f /data/logstash/config/conf.d/filebeat_test.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>ES 集群查看是否收到了该消息</p>
<blockquote>
<p>可看到，ES 集群已经成功消费了 Kafka 集群的消息了。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624105553521.png" alt="image-20220624105553521"></p>
</li>
<li><p>我们再去 Kibana 看看，进行相关检索</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624111301216.png" alt="image-20220624111301216"></p>
</li>
</ul>
<h4 id="4-7-4-调用模块"><a href="#4-7-4-调用模块" class="headerlink" title="4.7.4 调用模块"></a>4.7.4 调用模块</h4><p>内置模块路径（<code>/data/filebeat/modules.d/*.yml.disabled</code>），默认下是没开启模块的，需我们手动开启，实现方式有两种：配置文件、命令行。</p>
<h5 id="4-7-4-1-配置文件方式"><a href="#4-7-4-1-配置文件方式" class="headerlink" title="4.7.4.1 配置文件方式"></a>4.7.4.1 配置文件方式</h5><p>1、修改 filebeat.yml 配置文件</p>
<blockquote>
<p>新增如下内容</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">filebeat.config.modules:</span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">  reload.enabled: true</span><br><span class="line">  reload.period: 10s</span><br></pre></td></tr></table></figure>

<p>2、启用模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用 mysql 模块</span></span><br><span class="line">[root@kibana filebeat]# ./filebeat modules enable mysql</span><br><span class="line">Enabled mysql</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用多个模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[root@kibana filebeat]<span class="comment"># ./filebeat modules enable apache2 mysql</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停用模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">./filebeat modules <span class="built_in">disable</span> apache2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看哪些模块被启用了</span></span><br><span class="line">./filebeat modules list</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803122353089.png" alt="image-20220803122353089"></p>
<blockquote>
<p>当启用了对应的模块时， <code>/data/filebeat/modules.d/*.yml.disabled</code> 对应的<code>*.yml.disabled</code> 也会被自动重命名为 <code>/data/filebeat/modules.d/*.yml</code></p>
</blockquote>
<p>3、修改模块文件下的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim /data/filebeat/modules.d/mysql.yml</span><br><span class="line">=============================================</span><br><span class="line">- module: mysql</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">Error logs</span></span><br><span class="line">  error:</span><br><span class="line">    enabled: true</span><br><span class="line"></span><br><span class="line">    # Set custom paths for the log files. If left empty,</span><br><span class="line">    # Filebeat will choose the paths depending on your OS.</span><br><span class="line">    var.paths: [&quot;/var/log/mariadb/mariadb.log&quot;]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">Slow logs</span></span><br><span class="line">  slowlog:</span><br><span class="line">    enabled: true</span><br><span class="line"></span><br><span class="line">    # Set custom paths for the log files. If left empty,</span><br><span class="line">    # Filebeat will choose the paths depending on your OS.</span><br><span class="line">    var.paths: [&quot;/var/log/mariadb/slow.log&quot;]</span><br></pre></td></tr></table></figure>

<p>4、修改 <code>filebeat.yml</code> 配置文件</p>
<blockquote>
<p>完整示例</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">案例1-【发送事件至Kafka集群】</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">=========================== Filebeat inputs =============================</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  json.keys_under_root: true</span><br><span class="line">  json.add_error_key: true</span><br><span class="line">  json.message_key: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data/nginx/logs/*.log </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">============================= Kafka outputs =============================</span></span><br><span class="line">output.kafka:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;192.168.56.137:9092&quot;,&quot;192.168.56.138:9092&quot;,&quot;192.168.56.139:9092&quot;]</span><br><span class="line">  topic: module-test</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">================================ modules ================================</span> </span><br><span class="line">filebeat.config.modules:</span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">  reload.enabled: true</span><br><span class="line">  reload.period: 10s</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">案例2-【发送事件至ES集群】</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">=========================== Filebeat inputs =============================</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  json.keys_under_root: true</span><br><span class="line">  json.add_error_key: true</span><br><span class="line">  json.message_key: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data/nginx/logs/*.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">========================= elasticsearch outputs =========================</span></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">================================ modules ================================</span> </span><br><span class="line">filebeat.config.modules:</span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">  reload.enabled: true</span><br><span class="line">  reload.period: 10s</span><br></pre></td></tr></table></figure>

<p>5、初始化环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./filebeat setup -e</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">setup 加载模板</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-e 将标准输出输出至屏幕，而非系统日志中</span></span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803154710606.png" alt="image-20220803154710606"></p>
<p>6、运行（启动）Filebeat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803154742551.png" alt="image-20220803154742551"></p>
<p>看看 ES 集群是否收到该数据</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220803155133839.png" alt="image-20220803155133839"></p>
<h5 id="4-7-4-2-命令行方式"><a href="#4-7-4-2-命令行方式" class="headerlink" title="4.7.4.2 命令行方式"></a>4.7.4.2 命令行方式</h5><p>该方式在启动 Filebeat 时直接指定</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -M &quot;nginx.access.var.paths=[/data/nginx/logs/access.log]&quot; -M &quot;nginx.error.var.paths=[/data/nginx/logs/error.log]&quot;</span><br></pre></td></tr></table></figure>

<h4 id="4-7-5-基础用法"><a href="#4-7-5-基础用法" class="headerlink" title="4.7.5 基础用法"></a>4.7.5 基础用法</h4><blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/6.8/filebeat-input-log.html">官方文档实例</a></p>
</blockquote>
<h5 id="4-7-5-1-input"><a href="#4-7-5-1-input" class="headerlink" title="4.7.5.1 input"></a>4.7.5.1 input</h5><p>1、Log</p>
<ul>
<li><p>通用配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例1</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/messages</span><br><span class="line">    - /var/log/*.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">案例2</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log </span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/system.log</span><br><span class="line">    - /var/log/wifi.log</span><br><span class="line">- type: log </span><br><span class="line">  paths:</span><br><span class="line">    - &quot;/var/log/apache2/*&quot;</span><br><span class="line">  fields:</span><br><span class="line">    apache: true</span><br><span class="line">  fields_under_root: true</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置选项</p>
<ul>
<li><p>encoding</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  encoding: plain</span><br><span class="line">  ...</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">encoding选项用于读取包含国际字符的数据的文件编码。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">常见编码：plain, latin1, utf-8, utf-16be-bom, utf-16be, utf-16le, big5, gb18030, gbk, hz-gb-2312, euc-kr, euc-jp, iso-2022-jp, shift-jis ...</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">plain编码比较特殊，因为它不验证或转换任何输入。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>paths</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/*/*.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取/var/log/目录下的所有子目录下的所有以.<span class="built_in">log</span>结尾的文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">但并不会获取/var/log/目录下的日志文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果向获取/var/log/目录下的日志文件，及子目录下的文件，可使用recursive_glob参数</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>exclude_lines</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  ...</span><br><span class="line">  exclude_lines: [&#x27;^DBG&#x27;]</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示不收集以DBG开头的行的日志信息</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认是收集所有行（空行跳过）</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>include_line</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  ...</span><br><span class="line">  include_lines: [&#x27;^ERR&#x27;, &#x27;^WARN&#x27;]</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示只收集以ERR、WARN开头的行的日志信息</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认是收集所有行（空行跳过）</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">exclude_lines与include_line结合使用</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  ...</span><br><span class="line">  include_lines: [&#x27;sometext&#x27;]</span><br><span class="line">  exclude_lines: [&#x27;^DBG&#x27;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>harvester_buffer_size</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  ...</span><br><span class="line">  harvester_buffer_size: 16384</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每个收集器在获取文件时使用的缓冲区大小（以字节为单位）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认值为 16384（16K）</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>max_bytes</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  ...</span><br><span class="line">  harvester_buffer_size: 10485760</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单个日志消息可以拥有的最大字节数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">之后的所有字节 max_bytes都被丢弃而不发送。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此设置对于可能变得很大的多行日志消息特别有用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认值为 10MB (10485760)。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>json</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  ...</span><br><span class="line">  json.keys_under_root: true</span><br><span class="line">  json.add_error_key: true</span><br><span class="line">  json.message_key: log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于解码结构化为JSON的日志信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因此JSON解码仅在每行有一个JSON对象时该选项参数才有效。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>enabled</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  ...</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">enabled：是否启用filebeat的input功能（默认是<span class="literal">true</span>）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果设置为<span class="literal">false</span>，将采集不到日志（因为input已经被关闭）</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>tags</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  . . .</span><br><span class="line">  tags: [&quot;json&quot;,&quot;...&quot;]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可在每个事件类型中定义标签（可定义多个）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">便于后期做过滤相关操作</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>fields</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  . . .</span><br><span class="line">  fields:</span><br><span class="line">    app_id: query_engine_12</span><br><span class="line">    new_name: rab</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于向输出添加附加信息的可选字段（自定义），可定义多个</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字段可以是标量值、数组、字典或这些的任何嵌套组合，默认为字典</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果fields_under_root选项设置为 <span class="literal">true</span>，则自定义 字段将作为顶级字段存储在输出文档中</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如下图，上面定义的标签（tags）和字段（fields），会在 Kibana 展现</p>
<p>打问号的字段就是我们自定义的，其他字段为默认字段。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220804161155427.png" alt="image-20220804161155427"></p>
</li>
</ul>
</li>
</ul>
<p>2、Stdin</p>
<blockquote>
<p>与 log 一样，就是类型不一样而已。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: stdin</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/*/*.log</span><br></pre></td></tr></table></figure>

<p>3、Redis</p>
<ul>
<li><p>通用配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: redis</span><br><span class="line">  hosts: [&quot;localhost:6379&quot;]</span><br><span class="line">  password: &quot;$&#123;redis_pwd&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置选项</p>
<ul>
<li><p>scan_frequency</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: redis</span><br><span class="line">  hosts: [&quot;localhost:6379&quot;]</span><br><span class="line">  password: &quot;$&#123;redis_pwd&#125;&quot;</span><br><span class="line">  scan_frequency: 5</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Filebeat 从 Redis 慢日志中读取条目的频率。指定1s尽可能频繁地扫描 Redis，而不会导致 Filebeat 扫描过于频繁。不要将此值设置为小于1s</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>maxconn</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: redis</span><br><span class="line">  hosts: [&quot;localhost:6379&quot;]</span><br><span class="line">  password: &quot;$&#123;redis_pwd&#125;&quot;</span><br><span class="line">  maxconn: 10</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最大并发连接，默认为10</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>其他选项与上面类似</p>
</li>
</ul>
</li>
</ul>
<p>4、Docker</p>
<ul>
<li><p>通用配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: docker</span><br><span class="line">  containers.ids: </span><br><span class="line">    - &#x27;8b6fe7dc9e067b58476dc57d6986dd96d7100430c5de3b109a99cd56ac655347&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置选项</p>
<ul>
<li><p>containers.ids</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: docker</span><br><span class="line">  containers.ids: </span><br><span class="line">    - &#x27;*&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器ID</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&#x27;*&#x27;</span> 表示所有容器</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>containers.path</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: docker</span><br><span class="line">  containers.ids: </span><br><span class="line">    - &#x27;*&#x27;</span><br><span class="line">  containers.path:</span><br><span class="line">    - /var/lib/docker/containers</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器所在路径</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>5、具体实例</p>
<p><font color=Crimson><strong>情况一：Java 堆栈日志类型，如何搜集？</strong></font></p>
<blockquote>
<p>Java 堆栈跟踪由多行组成，初始行之后的每一行都以空格开头。</p>
</blockquote>
<ul>
<li><p>日志类型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalStateException: A book has a null property</span><br><span class="line">       at com.example.myproject.Author.getBookIds(Author.java:38)</span><br><span class="line">       at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</span><br><span class="line">Caused by: java.lang.NullPointerException</span><br><span class="line">       at com.example.myproject.Book.getId(Book.java:22)</span><br><span class="line">       at com.example.myproject.Author.getBookIds(Author.java:35)</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
</li>
<li><p>Filebeat 配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">情形1---默认输出</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  multiline.pattern: &#x27;^[[:space:]]&#x27;</span><br><span class="line">  multiline.negate: false</span><br><span class="line">  multiline.match: after</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">  tags: [&quot;multiline-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    app_id: muil_12</span><br><span class="line">    new_name: rab</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line">  index: &quot;multiline-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">setup.template.name: &quot;filebeattest&quot;</span><br><span class="line">setup.template.pattern: &quot;filebeattest-*&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">情形2---自定义某部分内容为一个filebeat事件来输出</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">条件限制：要同时满足</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.匹配以空格开头的行，且在空格后紧跟at关键字或者...关键字符串</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2.匹配以Caused by开头的行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这1、2条件合为一个整体进行输出，也就是每次日志内容新增都是以特定的格式输出</span></span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  multiline.pattern: &#x27;^[[:space:]]+(at|\.&#123;3&#125;)\b|^Caused by:&#x27;</span><br><span class="line">  multiline.negate: false</span><br><span class="line">  multiline.match: after</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">  tags: [&quot;multiline-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    app_id: muil_12</span><br><span class="line">    new_name: rab</span><br><span class="line">  fields_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line">  index: &quot;multiline-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">setup.template.name: &quot;filebeattest&quot;</span><br><span class="line">setup.template.pattern: &quot;filebeattest-*&quot;</span><br></pre></td></tr></table></figure>

<p><strong>multiline的作用就是将某些格式化数据以一个完整filebeat事件进行输出至输出目标</strong></p>
<ul>
<li>情形1：如果没有过多的条件限制，只要日志文件按照特定的格式有新内容，它就会采集一条数据并作为一个filebeat事件输出</li>
<li>情形2：如果做了条件限制，如图2，我限制了它们为一个整体来输出，只要新来了一条数据，就会按指定的规则来输出</li>
</ul>
</li>
<li><p>Kibana 数据展示</p>
<ul>
<li><p>情形1 截图</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220804165030462.png" alt="image-20220804165030462"></p>
</li>
<li><p>情形2 截图</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220804162913904.png" alt="image-20220804162913904"></p>
</li>
<li><p>其他情况</p>
<p>而如果 Java 日志格式不统一，那 filebeat 规则就不生效了，如下又新增了一条内容（&#x3D;&#x3D;但一般不会出现这种情况&#x3D;&#x3D;）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalStateException: A book has a null property</span><br><span class="line">       at com.example.myproject.Author.getBookIds(Author.java:38)</span><br><span class="line">       at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</span><br><span class="line">Caused by: java.lang.NullPointerException</span><br><span class="line">       at com.example.myproject.Book.getId(Book.java:22)</span><br><span class="line">       at com.example.myproject.Author.getBookIds(Author.java:35)</span><br><span class="line">Caused test: java.lang.NullPointerException</span><br><span class="line">       aa com.example.myproject.Book.getId(Book.java:22)</span><br><span class="line">       aa com.example.myproject.Author.getBookIds(Author.java:35)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Kibana 数据展示：再看看 Kibana 数据展示，按filebeat定义的规则来看，收集到的数据并不完整。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220804163755203.png" alt="image-20220804163755203"></p>
</li>
</ul>
</li>
</ul>
<p><font color=Crimson><strong>情况二：带时间戳的 Java 应用日志格式，如何收集？</strong></font></p>
<blockquote>
<p>以测试环境 checkcheck 项目举例，下面就是一种典型的时间戳的日志格式。</p>
</blockquote>
<ul>
<li><p>日志类型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">2022-08-04 08:14:46.660 [schedule-1-t-10] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间656已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 08:24:46.661 [schedule-1-t-7] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间1256已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 08:54:46.661 [schedule-1-t-3] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间937已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 09:14:46.662 [schedule-1-t-10] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间865已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 09:24:46.662 [schedule-1-t-8] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间1465已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 09:34:46.663 [schedule-1-t-1] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间2065已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 09:44:46.663 [schedule-1-t-5] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间2665已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 09:54:46.663 [schedule-1-t-6] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间3265已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 10:04:46.664 [schedule-1-t-7] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间3865已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 10:14:46.664 [schedule-1-t-8] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间4465已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 10:24:46.665 [schedule-1-t-1] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间5065已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 10:34:46.665 [schedule-1-t-2] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间5665已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 10:44:46.665 [schedule-1-t-6] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间6265已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 10:54:46.666 [schedule-1-t-9] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间6865已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 11:04:46.666 [schedule-1-t-4] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间7465已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 11:14:46.666 [schedule-1-t-5] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间8065已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 11:24:46.667 [schedule-1-t-2] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间8665已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 11:34:46.667 [schedule-1-t-3] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间9265已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 11:44:46.667 [schedule-1-t-1] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间9865已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 11:54:46.668 [schedule-1-t-3] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间10465已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">2022-08-04 12:04:46.668 [schedule-1-t-4] ERROR com.kys.redis.gatehash.GateHashManager - 订阅HashCode最后活跃时间11065已经大于限制600秒,取消订阅，重新订阅</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>Filebeat 配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  multiline.pattern: &#x27;^\[[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">  tags: [&quot;multiline-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    app_id: muil_12</span><br><span class="line">    new_name: rab</span><br><span class="line">  fields_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line">  index: &quot;multiline-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">setup.template.name: &quot;filebeattest&quot;</span><br><span class="line">setup.template.pattern: &quot;filebeattest-*&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Kibana 数据展示</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220804172634632.png" alt="image-20220804172634632"></p>
</li>
</ul>
<p><font color=Crimson><strong>扩展</strong></font>：如果匹配不到 filebeat 规则的数据，将如何处理？</p>
<blockquote>
<p>在<code>情况一</code>中有出现数据不完整的去情况，那间如何处理？解决方案就是设置参数：</p>
<ul>
<li><code>multiline.negate: true</code> </li>
<li><code>multiline.match: after</code></li>
</ul>
</blockquote>
<ul>
<li><p>filebeat 配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  multiline.pattern: &#x27;^[[:space:]]+(at|\.&#123;3&#125;)\b|^Caused by:&#x27;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">  tags: [&quot;multiline-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    app_id: muil_12</span><br><span class="line">    new_name: rab</span><br><span class="line">  fields_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line">  index: &quot;multiline-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">setup.template.name: &quot;filebeattest&quot;</span><br><span class="line">setup.template.pattern: &quot;filebeattest-*&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>日志示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalStateException: A book has a null property</span><br><span class="line">       at com.example.myproject.Author.getBookIds(Author.java:38)</span><br><span class="line">       at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</span><br><span class="line">wtttwww sss dcsdccdc.csdcs.dscs.dc</span><br><span class="line">       cc sdc.cocsdc.csss(Book.java:36)</span><br><span class="line">       dd sdcs.grtr.ytu.pklm(Author.java:12)</span><br><span class="line">Caused by: java.lang.NullPointerException</span><br><span class="line">       at com.example.myproject.Book.getId(Book.java:22)</span><br><span class="line">       at com.example.myproject.Author.getBookIds(Author.java:35)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Kibana 数据展示</p>
<p>数据展示失败—-与预期不符（后面再研究）</p>
</li>
</ul>
<p>&#x3D;&#x3D;小结：通过以上案例你就可以发现，multiline 的作用无非就是一次输出与 filebeat 规则匹配的日志格式，类似于并发输出了，为什么这样说呢？默认的输出方式是来一条数据就输出一条（在filebeat采集时间内），而 multiline 也满足来一条数据就输出一条（在filebeat采集时间内），但如果在 filebeat 采集时间内匹配到了规则指定的数据，那就会作为单个事件一次性输出。&#x3D;&#x3D;</p>
<p><font color=Crimson><strong>情况三：日志格式有自定义的字段，如何收集？</strong></font></p>
<blockquote>
<p>有这么一种情况，也是在测试&#x2F;生产环境中常见的，由于某些特殊情况，开发一般会在日志中做相关的标记，比如起始事件的标识符。那我们如何每次截取开发指定的这段日志数据呢？</p>
</blockquote>
<ul>
<li><p>filebeat 配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  multiline.pattern: &#x27;Start new event&#x27;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  multiline.flush_pattern: &#x27;End event&#x27;</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">  tags: [&quot;multiline-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    app_id: muil_12</span><br><span class="line">    new_name: rab</span><br><span class="line">  fields_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line">  index: &quot;multiline-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">setup.template.name: &quot;filebeattest&quot;</span><br><span class="line">setup.template.pattern: &quot;filebeattest-*&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>日志示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2015-08-24 11:49:14,389] Start new event</span><br><span class="line">[2015-08-24 11:49:14,395] Content of processing something</span><br><span class="line">[2015-08-24 11:49:14,399] End event</span><br></pre></td></tr></table></figure>
</li>
<li><p>Kibana 数据展示</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220804180429618.png" alt="image-20220804180429618"></p>
</li>
</ul>
<h5 id="4-7-5-2-output"><a href="#4-7-5-2-output" class="headerlink" title="4.7.5.2 output"></a>4.7.5.2 output</h5><blockquote>
<p>更多 output 请看<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/6.8/configuring-output.html">《官方文档》</a>，以下仅列出了常用的几种。</p>
</blockquote>
<p>1、Elasticsearch</p>
<ul>
<li><p>基本格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;ES_IP:9200&quot;, &quot;ES_IP:9200&quot;, &quot;ES_IP:9200&quot;, ...]</span><br><span class="line">  protocol: &quot;http&quot;</span><br><span class="line">  username: &quot;&#123;beatname_lc&#125;_internal&quot;</span><br><span class="line">  password: &quot;&#123;pwd&#125;&quot;</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts：ES集群主机IP，可以定义为URL或IP:PORT</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">protocol：ES协议，默认http协议，如果你的ES加密，则使用https</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">username：ES用户名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">password：ES密码</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义输出到 ES 集群的索引</p>
<ul>
<li><p>基本索引定义格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://localhost:9200&quot;]</span><br><span class="line">  index: &quot;%&#123;[fields.log_type]&#125;-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot; </span><br></pre></td></tr></table></figure>
</li>
<li><p>带有条件的索引格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://localhost:9200&quot;]</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;warning-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        message: &quot;WARN&quot;</span><br><span class="line">    - index: &quot;error-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        message: &quot;ERR&quot;</span><br><span class="line">        </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">indices：定义一组索引选择器规则</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如何选择？当filebeat传入的日志数据内容中包含WARN关键字，则选择warning-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.<span class="built_in">dd</span>&#125;作为ES索引；当filebeat传入的日志数据内容中包含ERR关键字，则选择error-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.<span class="built_in">dd</span>&#125;作为ES索引</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>2、Logstash</p>
<p><code>Filebeat</code> 将事件发送到 <code>Logstash</code> 是基于 TCP 协议来实现，相比于 <code>Filebeat</code> 直接将数据输出到 ES 集群而言，<code>Logstash</code> 允许对生成的事件进行<code>额外处理和路由</code></p>
<p>3、Kafka</p>
<h4 id="4-7-6-Filebeat-ES"><a href="#4-7-6-Filebeat-ES" class="headerlink" title="4.7.6 Filebeat + ES"></a>4.7.6 Filebeat + ES</h4><blockquote>
<p>本次以 Docker Swarm 集群服务日志为搜集目标。</p>
</blockquote>
<h5 id="4-7-6-1-Nginx"><a href="#4-7-6-1-Nginx" class="headerlink" title="4.7.6.1 Nginx"></a>4.7.6.1 Nginx</h5><blockquote>
<p>先看看日志格式：可以是JSON格式，也可以是任意格式。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805173132226.png" alt="image-20220805173132226"></p>
<p>1、Docker Swarm 集群启用 Nginx 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">  --replicas 2 \</span><br><span class="line">  --name my-web \</span><br><span class="line">  --network my-network \</span><br><span class="line">  --publish published=8080,target=80 \</span><br><span class="line">  --hostname=&quot;my-nginx&quot; \</span><br><span class="line">  --mount type=bind,src=/data/nginx/conf/nginx.conf,dst=/etc/nginx/nginx.conf \</span><br><span class="line">  --mount type=bind,src=/data/nginx/conf/conf.d,dst=/etc/nginx/conf.d \</span><br><span class="line">  --mount type=bind,src=/data/nginx/html,dst=/usr/share/nginx/html \</span><br><span class="line">  --mount type=bind,src=/data/nginx/logs,dst=/var/log/nginx \</span><br><span class="line">  nginx:1.20.2</span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805152246800.png" alt="image-20220805152246800"></p>
<blockquote>
<p>因为 Docker Swarm 集群自身调度算法，每次的滚动升级（扩容&#x2F;缩容）都可能导致服务被调度到不同的 work 节点上，所以每个节点我们也同样配置相同的 Filebeat，这样不管你的服务被调度到哪个工作节点那都没关系，只要确保输出到 ES 的索引保持一致即可，因为在 Kibana 展示的时候就是就是通过 ES 存储的索引来展示数据的。</p>
</blockquote>
<p>2、Filebeat 配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@kibana filebeat]# cat conf.d/nginx_logs.yml </span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data/nginx/logs/access.log</span><br><span class="line">    - /data/nginx/logs/error.log</span><br><span class="line">  tags: [&quot;nginx-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_all_logs</span><br><span class="line">  fields_under_root: true</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;filebeattest&quot;</span><br><span class="line">setup.template.pattern: &quot;filebeattest-*&quot;</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line">  index: &quot;nginx_all_logs-%&#123;+yyyy.MM.dd&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>3、启动 filebeat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c conf.d/nginx_logs.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">说明</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-e：信息输出至屏幕终端</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-c：指定配置文件（如果你修改默认的配置文件名及路径，可以不指定）</span></span><br></pre></td></tr></table></figure>

<p>4、ES 简单查看验证</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805155313793.png" alt="image-20220805155313793"></p>
<p>5、Kibana 创建索引并查看具体信息</p>
<blockquote>
<p>Nginx 每访问一次，Kibana 就会输出一次内容。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805155434344.png" alt="image-20220805155434344"></p>
<p>&#x3D;&#x3D;更多过滤方法，请看第5节《Kibana 基础操作》&#x3D;&#x3D;</p>
<p>如果此时我故意将 <code>docker_swarm_work2</code> 节点上运行的 nginx 服务的配置文件做改动（写一个错误的语法），那 <code>nginx</code> 服务将是无法启动的，但是根据 Docker Swarm 的调度算法原理，会根据你 master 节点启动服务时指定的的服务副本数，从而再次启动相应的容器服务。</p>
<ul>
<li><p>Nginx 配置</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805171644827.png" alt="image-20220805171644827"></p>
</li>
<li><p>查看 Docker Swarm</p>
<blockquote>
<p>可看到，原本 work2 上的节点服务，由于启动失败，但要保持集群指定的服务数，Docker Swarm 集群会再次启动一个服务，可看到该服务已经运行在了 work1 节点上了。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805170249243.png" alt="image-20220805170249243"></p>
</li>
<li><p>此时再来看看 Kibana的数据</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805172249044.png" alt="image-20220805172249044"></p>
</li>
</ul>
<p>&#x3D;&#x3D;6、扩展&#x3D;&#x3D;</p>
<p>在 <code>filebeat</code> 输出到 ES 前，我们可以做相关的过滤操作，现将上面的例子进一步优化。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data/nginx/logs/access.log</span><br><span class="line">    - /data/nginx/logs/error.log</span><br><span class="line">  tags: [&quot;nginx-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_all_logs</span><br><span class="line">  fields_under_root: true</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;filebeattest&quot;</span><br><span class="line">setup.template.pattern: &quot;filebeattest-*&quot;</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;rab-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        message: &quot;Mozilla&quot;</span><br><span class="line">    - index: &quot;rab-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        message: &quot;error&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">说明</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">indices：索引过滤条件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">when.contains：当包日志内容含error信息时，数据索引为rab-error-%&#123;+yyyy.MM.<span class="built_in">dd</span>&#125;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果不定义过滤的when条件，则默认采集所有数据（访问和错误都会采集），比如indices:下可有多个index，但如果我的index不加when条件，那就默认收集所有日志数据</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当indices:下都有过滤条件，但是根据你提供的path日志内容你无法匹配到你定义的关键字，那将会以more索引filebeat-&#123;&#123;version&#125;&#125;-&#123;YYYYmmdd&#125;来输出</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>正常访问的情况，看看 ES 索引</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805180402674.png" alt="image-20220805180402674"></p>
</li>
<li><p>异常访问时，看看 ES 索引</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805182845157.png" alt="image-20220805182845157"></p>
</li>
<li><p>看看 Kibana 日志</p>
<blockquote>
<p>我在 Nginx 访问页面刷新了两次</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220805183102712.png" alt="image-20220805183102712"></p>
</li>
<li><p>还可以继续优化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data/nginx/logs/access.log</span><br><span class="line">    - /data/nginx/logs/error.log</span><br><span class="line">  tags: [&quot;nginx-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_all_logs</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  </span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data/nginx/logs/access.log</span><br><span class="line">    - /data/nginx/logs/error.log</span><br><span class="line">  tags: [&quot;nginx-01&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_all_logs</span><br><span class="line">  fields_under_root: true</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;filebeattest&quot;</span><br><span class="line">setup.template.pattern: &quot;filebeattest-*&quot;</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;123456&quot;</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;rab-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        message: &quot;Mozilla&quot;</span><br><span class="line">    - index: &quot;rab-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        message: &quot;error&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">说明</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">indices：索引过滤条件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">when.contains：当包日志内容含error信息时，数据索引为rab-error-%&#123;+yyyy.MM.<span class="built_in">dd</span>&#125;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果不定义过滤的when条件，则默认采集所有数据（访问和错误都会采集），比如indices:下可有多个index，但如果我的index不加when条件，那就默认收集所有日志数据</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当indices:下都有过滤条件，但是根据你提供的path日志内容你无法匹配到你定义的关键字，那将会以more索引filebeat-&#123;&#123;version&#125;&#125;-&#123;YYYYmmdd&#125;来输出</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">详情如下：</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /data/nginx/logs/*.log</span><br><span class="line">  scan_frequency: 10s</span><br><span class="line">  tail_files: true</span><br><span class="line">  fields:</span><br><span class="line">    index_name: &quot;nginx_log&quot;</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">不以[开头的行都合并到上一行的末尾</span></span><br><span class="line">  multiline.type: pattern</span><br><span class="line">  multiline.pattern: &#x27;^[[:space:]]+(at|\.&#123;3&#125;)[[:space:]]+\b|^Caused by:&#x27;</span><br><span class="line">  multiline.negate: false</span><br><span class="line">  multiline.match: after</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/log4j/*.log</span><br><span class="line">  fields:</span><br><span class="line">    index_name: &quot;log4j_log&quot;</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  multiline.type: pattern</span><br><span class="line">  multiline.pattern: &#x27;^[[:space:]]+(at|\.&#123;3&#125;)[[:space:]]+\b|^Caused by:&#x27;</span><br><span class="line">  multiline.negate: false</span><br><span class="line">  multiline.match: after</span><br><span class="line">  fields:</span><br><span class="line">    index_name: &quot;biz_log&quot;</span><br><span class="line">  scan_frequency: 10s</span><br><span class="line">  pipeline: &quot;extract-traceid-pipeline&quot;</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/biz/*.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="comment"># # 7.x的版本中需要禁用此索引生命周期，否则在指定es索引名字的时候会有问题</span></span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line">setup.template.name: &quot;my-log&quot;</span><br><span class="line">setup.template.pattern: &quot;my-*&quot;</span><br><span class="line">setup.template.enabled: true</span><br><span class="line">setup.template.overwrite: false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出到es</span></span><br><span class="line">output.elasticsearch:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">worker: 1</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bulk_max_size: 1500</span></span><br><span class="line">  hosts: [&quot;elasticsearch1:9200&quot;]</span><br><span class="line">  index: &quot;pb-%&#123;[fields.index_name]&#125;-*&quot;</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;pb-nginx-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.equals:</span><br><span class="line">        fields.index_name: &quot;nginx_log&quot;</span><br><span class="line">    - index: &quot;pb-log4j-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.equals:</span><br><span class="line">        fields.index_name: &quot;log4j_log&quot;</span><br><span class="line">    - index: &quot;pb-biz-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.equals:</span><br><span class="line">        fields.index_name: &quot;biz_log&quot;</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;以上就是一些基础优化，参考即可。&#x3D;&#x3D;</p>
</li>
</ul>
<h5 id="4-7-6-2-Java"><a href="#4-7-6-2-Java" class="headerlink" title="4.7.6.2 Java"></a>4.7.6.2 Java</h5><blockquote>
<p>具体案例可看 <code>4.7.5.1</code> 部分，分别对应了不同的日志格式分析。</p>
</blockquote>
<h3 id="4-8-Filebeat-Logstash-ES"><a href="#4-8-Filebeat-Logstash-ES" class="headerlink" title="4.8 Filebeat + Logstash + ES"></a>4.8 Filebeat + Logstash + ES</h3><p>关于 <code>Filebeat + ES</code> 的案例，请看 <code>4.7.6</code> 部分。</p>
<p>先看看 Logstash 的流过程：</p>
<ol>
<li>先确定数据源（可以是常规日志、Filebeat输出、Kafka集群）</li>
<li>Filters 数据过滤</li>
<li>输出到 ES 集群</li>
<li>Kibana 数据展示</li>
</ol>
<p><img src="https://www.elastic.co/guide/en/logstash/6.8/static/images/basic_logstash_pipeline.png" alt="basic logstash pipeline"></p>
<h4 id="4-8-1-Filebeat-数据采集"><a href="#4-8-1-Filebeat-数据采集" class="headerlink" title="4.8.1 Filebeat 数据采集"></a>4.8.1 Filebeat 数据采集</h4><blockquote>
<p>首先确定数据源我们使用 <code>filebeat</code> 来做数据采集。</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs<span class="punctuation">:</span></span><br><span class="line">- type<span class="punctuation">:</span> log</span><br><span class="line">  paths<span class="punctuation">:</span></span><br><span class="line">    - /data/nginx/logs/access.log</span><br><span class="line">    - /data/nginx/logs/error.log</span><br><span class="line">  tags<span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;nginx-02&quot;</span><span class="punctuation">]</span></span><br><span class="line">  fields<span class="punctuation">:</span></span><br><span class="line">    log_type<span class="punctuation">:</span> nginx_all_logs</span><br><span class="line">  fields_under_root<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"></span><br><span class="line">output.logstash<span class="punctuation">:</span></span><br><span class="line">  hosts<span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;192.168.56.140:5044&quot;</span><span class="punctuation">]</span></span><br><span class="line">  loadbalance<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  index<span class="punctuation">:</span> filebeat</span><br><span class="line">  </span><br><span class="line"># 参数说明</span><br><span class="line"># loadbalance：当你有多个logstash来做分流时（&gt;=<span class="number">2</span>），值设置为<span class="literal"><span class="keyword">true</span></span>，只有一个logstash分流，设置为<span class="literal"><span class="keyword">false</span></span>即可</span><br></pre></td></tr></table></figure>

<h4 id="4-8-2-Logstash-输出至-ES"><a href="#4-8-2-Logstash-输出至-ES" class="headerlink" title="4.8.2 Logstash 输出至 ES"></a>4.8.2 Logstash 输出至 ES</h4><blockquote>
<p>数据源确定后，接下来就是确定Logstash获取数据了</p>
</blockquote>
<p>1、Logstash 元数据</p>
<blockquote>
<p>更多元数据参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/logstash/6.8/event-dependent-configuration.html#metadata">官方文档</a></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.8.23&quot;</span> </span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span> </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>2、Logstash 配置输出</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">input <span class="punctuation">&#123;</span></span><br><span class="line">  beats <span class="punctuation">&#123;</span></span><br><span class="line">    port =&gt; <span class="number">5044</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">output <span class="punctuation">&#123;</span></span><br><span class="line">  elasticsearch <span class="punctuation">&#123;</span></span><br><span class="line">    hosts =&gt; <span class="punctuation">[</span><span class="string">&quot;http://192.168.56.133:9200&quot;</span><span class="punctuation">,</span> <span class="string">&quot;http://192.168.56.134:9200&quot;</span><span class="punctuation">,</span> <span class="string">&quot;http://192.168.56.135:9200&quot;</span><span class="punctuation">]</span></span><br><span class="line">    user =&gt; <span class="string">&quot;elastic&quot;</span></span><br><span class="line">    password =&gt; <span class="string">&quot;123456&quot;</span></span><br><span class="line">    index =&gt; <span class="string">&quot;my_nginx-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># 官方案例：index =&gt; <span class="string">&quot;%&#123;[@metadata][beat]&#125;-%&#123;[@metadata][version]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line"># 其实就是取元数据的默认值。</span><br></pre></td></tr></table></figure>

<p>3、分别启动 Logstash&#x2F;Filebeat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker restart logstash</span><br><span class="line">./filebeat -e -c conf.d/nginx_output_logstash.yml</span><br></pre></td></tr></table></figure>

<p>4、ES 验证</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220808114201901.png" alt="image-20220808114201901"></p>
<h3 id="4-9-Filebeat-Kafka-Logstash-ES"><a href="#4-9-Filebeat-Kafka-Logstash-ES" class="headerlink" title="4.9 Filebeat + Kafka + Logstash + ES"></a>4.9 Filebeat + Kafka + Logstash + ES</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        type =&gt; &quot;xgxy-v&quot;</span><br><span class="line">        codec =&gt; &quot;json&quot;</span><br><span class="line">        topics =&gt; &quot;xgxy&quot;</span><br><span class="line">        decorate_events =&gt; true</span><br><span class="line">        bootstrap_servers =&gt; &quot;192.168.56.137:9092, 192.168.56.138:9092, 192.168.56.139:9092&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;192.168.56.133:9200&quot;,&quot;192.168.56.134:9200&quot;,&quot;192.168.56.135:9200&quot;]</span><br><span class="line">        user =&gt; &quot;elastic&quot;</span><br><span class="line">        password =&gt; &quot;123456&quot;</span><br><span class="line">        index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-9-FAQ"><a href="#4-9-FAQ" class="headerlink" title="4.9 FAQ"></a>4.9 FAQ</h3><h4 id="4-9-1-es-head-插件访问不了-ES-集群"><a href="#4-9-1-es-head-插件访问不了-ES-集群" class="headerlink" title="4.9.1 es-head 插件访问不了 ES 集群"></a>4.9.1 es-head 插件访问不了 ES 集群</h4><p><strong>1、详情如下图所示：</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624174527563.png" alt="image-20220624174527563"></p>
<p><strong>2、解决方案</strong></p>
<p>修改 ES 集群配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决跨域问题</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新增以下内容</span></span><br><span class="line">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启 ES 集群</span></span><br><span class="line">docker restart es-1</span><br><span class="line">docker restart es-2</span><br><span class="line">docker restart es-3</span><br></pre></td></tr></table></figure>

<p><strong>3、es-head 插件访问</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.56.136:9100/?auth_user=elastic&amp;auth_password=123456</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">说明：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">auth_user：你在ES集群设置的用户名（其实是内置用户）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">auth_password：你当时设置的内置用户名密码</span></span><br></pre></td></tr></table></figure>

<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624180113410.png" alt="image-20220624180113410"></p>
<p><strong>4、Nginx 如何配置</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">目前配置失败，正在查找原因...</span><br></pre></td></tr></table></figure>

<h2 id="五、Kibana-基础操作"><a href="#五、Kibana-基础操作" class="headerlink" title="五、Kibana 基础操作"></a>五、Kibana 基础操作</h2><h3 id="5-1-索引管理"><a href="#5-1-索引管理" class="headerlink" title="5.1 索引管理"></a>5.1 索引管理</h3><h4 id="5-1-1-查看-ES-的索引"><a href="#5-1-1-查看-ES-的索引" class="headerlink" title="5.1.1 查看 ES 的索引"></a>5.1.1 查看 ES 的索引</h4><p>【管理】–【索引管理】</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624112809355.png" alt="image-20220624112809355"></p>
<h4 id="5-1-2-创建和使用索引"><a href="#5-1-2-创建和使用索引" class="headerlink" title="5.1.2 创建和使用索引"></a>5.1.2 创建和使用索引</h4><blockquote>
<p>当我们的数据都存储到 ES 集群中时，接下来就是 Kibana 展示的环节了，首先我们要添加索引（可以进行泛检索），这个索引我们在 Logstash 的时候已经进行自定义了。</p>
</blockquote>
<p><strong>1、在菜单栏左侧的【管理】进行创建</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624112131666.png" alt="image-20220624112131666"></p>
<p><strong>2、以时间戳的方式进行筛选</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624112511428.png" alt="image-20220624112511428"></p>
<p><strong>3、如何查看刚刚创建的索引？</strong></p>
<blockquote>
<p>展示的时间的排序可以点击【时间】字段的下角标</p>
<p>图中，深灰色表示字 key，其后对应的是 value</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624121435875.png" alt="image-20220624121435875"></p>
<p><strong>4、如何指定字段显示？</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624122223751.png" alt="image-20220624122223751"></p>
<blockquote>
<p>字段顺序调整</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624122429007.png" alt="image-20220624122429007"></p>
<h3 id="5-2-用户管理"><a href="#5-2-用户管理" class="headerlink" title="5.2 用户管理"></a>5.2 用户管理</h3><h4 id="5-2-1-创建用户"><a href="#5-2-1-创建用户" class="headerlink" title="5.2.1 创建用户"></a>5.2.1 创建用户</h4><blockquote>
<p>注意：创建用户这一功能基于 ES 集群开启了用户认证。</p>
</blockquote>
<p><strong>1、基本介绍</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624162943655.png" alt="image-20220624162943655"></p>
<p><strong>2、创建用户</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624163028763.png" alt="image-20220624163028763"></p>
<p><strong>3、填写用户相关信息</strong></p>
<blockquote>
<p>这里的注意点是，对用户角色的设置。</p>
<p>用户名：用于 Kibana 登录</p>
<p>全名：自定义（一般定义为员工真实名）</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624163439178.png" alt="image-20220624163439178"></p>
<p><strong>4、看看用户管理页面：已成功创建</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624163526240.png" alt="image-20220624163526240"></p>
<h4 id="5-2-2-删除用户"><a href="#5-2-2-删除用户" class="headerlink" title="5.2.2 删除用户"></a>5.2.2 删除用户</h4><blockquote>
<p>点击用户管理页面（上图）对应的用户名，就会进入以下页面，点击删除用户即可。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624164206168.png" alt="image-20220624164206168"></p>
<h4 id="5-2-3-更改用户密码"><a href="#5-2-3-更改用户密码" class="headerlink" title="5.2.3 更改用户密码"></a>5.2.3 更改用户密码</h4><p><strong>1、点击用户页面对应的用户名</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624163946479.png" alt="image-20220624163946479"></p>
<p><strong>2、进入用户密码修改页面</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624164115642.png" alt="image-20220624164115642"></p>
<h4 id="5-2-4-用户角色（权限）"><a href="#5-2-4-用户角色（权限）" class="headerlink" title="5.2.4 用户角色（权限）"></a>5.2.4 用户角色（权限）</h4><p>点击角色，进行相关角色管理：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624170715932.png" alt="image-20220624170715932"></p>
<p>ES 提供了<code>保留角色</code>和<code>自定义</code>角色种，可根据我们的需求对不同用户进行不同权限的绑定。更多角色参数说明，请看<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/security-privileges.html#privileges-list-indices">官方说明文档</a></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624170415424.png" alt="image-20220624170415424"></p>
<p>查看创建结果：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220624171013615.png" alt="image-20220624171013615"></p>
<h4 id="5-2-5-角色对应绑定工作区"><a href="#5-2-5-角色对应绑定工作区" class="headerlink" title="5.2.5 角色对应绑定工作区"></a>5.2.5 角色对应绑定工作区</h4><p><strong>1、例如我创建了 dev 角色</strong></p>
<blockquote>
<ul>
<li><p>创建 dev 角色</p>
</li>
<li><p>该角色中绑定了 dev 用户（Java开发）</p>
</li>
</ul>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626164107387.png" alt="image-20220626164107387"></p>
<p><strong>2、现对该角色绑定工作区</strong></p>
<blockquote>
<p>目的：使该角色仅对该工作区有相关权限，实现用户权限划分。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626163917429.png" alt="image-20220626163917429"></p>
<h4 id="5-2-6-开发人员权限"><a href="#5-2-6-开发人员权限" class="headerlink" title="5.2.6 开发人员权限"></a>5.2.6 开发人员权限</h4><p>1、基础权限</p>
<ul>
<li><p>创建索引</p>
</li>
<li><p>查看索引</p>
</li>
<li><p>删除索引</p>
<blockquote>
<p>该权限指的是删除 Kibana 创建的搜索索引，并不是真正删除 ES 本身的数据索引。</p>
</blockquote>
</li>
<li><p>查看 ES 健康状态</p>
<blockquote>
<p>暂时不开放，因为以下权限可能存在开发人员误操作将其他项目组管理空间删除的风险。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817113507505.png" alt="image-20220817113507505"></p>
</li>
<li><p>查看索引生命周期</p>
<blockquote>
<p>暂时不开放，因为同样可能存在开发人员误操作将其他项目组管理空间删除的风险。</p>
</blockquote>
</li>
<li><p>仪表板、可视化、地图等其他基本权限</p>
</li>
</ul>
<p>2、常规权限</p>
<p>&#x3D;&#x3D;一般设置以下权限即可，不同项目组仅能查看自己对应的日志信息，其他项目组管理空间无权查看。&#x3D;&#x3D;</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817120105446.png" alt="image-20220817120105446"></p>
<h3 id="5-3-ES-集群-x2F-实例状态"><a href="#5-3-ES-集群-x2F-实例状态" class="headerlink" title="5.3 ES 集群&#x2F;实例状态"></a>5.3 ES 集群&#x2F;实例状态</h3><p>在 Kibana 控制面板上，可查看 ES 集群及 Kibana 实例健康状态，如何查看？</p>
<p>点击 Kibana 菜单栏左下角的【monitoring】监控按钮即可查看：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626093604962.png" alt="image-20220626093604962"></p>
<h4 id="5-3-1-ES-集群"><a href="#5-3-1-ES-集群" class="headerlink" title="5.3.1 ES 集群"></a>5.3.1 ES 集群</h4><p><strong>1、主要指标</strong></p>
<ul>
<li>ES 集群版本；</li>
<li>ES 集群运行的时间；</li>
<li>ES 集群磁盘可用空间百分百比；</li>
<li>ES 集群的 JVM 堆大小；</li>
<li>ES 集群的索引数据详情；</li>
<li>ES 集群内存使用情况；</li>
<li>ES 状态为 Green 表示集群健康。</li>
</ul>
<p><strong>2、整体概览</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626094120204.png" alt="image-20220626094120204"></p>
<h4 id="5-3-2-Kibana-实例"><a href="#5-3-2-Kibana-实例" class="headerlink" title="5.3.2 Kibana 实例"></a>5.3.2 Kibana 实例</h4><p><strong>1、主要指标</strong></p>
<ul>
<li>Kibana 请求数</li>
<li>Kibana 连接数</li>
<li>Kibana 内存使用</li>
<li>Kibana 响应时间</li>
<li>Kibana 状态为 Green 表示实例健康</li>
</ul>
<p><strong>2、整体概览</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626094411882.png" alt="image-20220626094411882"></p>
<h3 id="5-4-常用可视化分析"><a href="#5-4-常用可视化分析" class="headerlink" title="5.4 常用可视化分析"></a>5.4 常用可视化分析</h3><blockquote>
<p>本次采用 Kibana 自带的一个样本数据（航班飞行日志）来做演示。</p>
</blockquote>
<h4 id="5-4-1-饼图"><a href="#5-4-1-饼图" class="headerlink" title="5.4.1 饼图"></a>5.4.1 饼图</h4><p>本次实现功能：展示航班数及航班占比情况。</p>
<p><strong>1、创建可视化界面</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626095737553.png" alt="image-20220626095737553"></p>
<p><strong>2、选择所需的可视化类型</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626095923091.png" alt="image-20220626095923091"></p>
<p><strong>3、选择基于什么样的索引来创建可视化界面</strong></p>
<blockquote>
<p>以航班飞行日志来展示</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626100429730.png" alt="image-20220626100429730"></p>
<p><strong>4、指标&#x2F;存储桶选择</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626101028748.png" alt="image-20220626101028748"></p>
<p>上图的字段会根据你你的索引日志内容自动检出：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626101811427.png" alt="image-20220626101811427"></p>
<p><code>Carrier 表示航班公司</code></p>
<p>可根据需求调整饼图颜色，在可视化图形的右上角配置：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626102653914.png" alt="image-20220626102653914"></p>
<p><strong>5、生成指标数据</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626101329900.png" alt="image-20220626101329900"></p>
<p>如果要继续对饼图进行界面属性优化，可点击【选项】进行设置：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626103148167.png" alt="image-20220626103148167"></p>
<p>最后点击【保存】即可</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626103248520.png" alt="image-20220626103248520"></p>
<p>【确认保存】–如果你是做同类型的可视化，标题尽量保持一定的格式，方便后期导入仪表板，比如：</p>
<ul>
<li>航班-航班数</li>
<li>航班-航班票价</li>
<li>航班-…</li>
</ul>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626103342733.png" alt="image-20220626103342733"></p>
<p><strong>结论：</strong></p>
<ol>
<li><p>该饼图表示不同航班公司承运的航班数及占比情况；</p>
</li>
<li><p>如果在游戏应用领域的话，可以展示不同国家对某款游戏使用的占比情况。</p>
</li>
</ol>
<h4 id="5-4-2-面积图"><a href="#5-4-2-面积图" class="headerlink" title="5.4.2 面积图"></a>5.4.2 面积图</h4><p>本次实现功能：</p>
<ol>
<li>根据<code>时间</code>在同一面积图中<code>展示航班数</code>及<code>航班平均票价</code>。</li>
<li>航班数使用面积图（area）展示，平均票价使用点状图展示。</li>
</ol>
<p><strong>1、新建面积图并做相关指标配置</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626110006111.png" alt="image-20220626110006111"></p>
<p><strong>2、生成指标数据</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626110125684.png" alt="image-20220626110125684"></p>
<p>此时的有两条 Y 轴（计数和平均值）合二为一，并不是很美观，可进点击【Metrics &amp; Axes】进一步优化：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626111313592.png" alt="image-20220626111313592"></p>
<p><strong>3、最后点击【保存】即可</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626111644033.png" alt="image-20220626111644033"></p>
<p><strong>结论：</strong></p>
<ul>
<li>面积图可进行相关数据统计、展示；</li>
<li>其图标类型有 area、line、bar的形式，对于多 Y 轴的情况下可选择性使用；</li>
<li>以点状形式显示的需提前创建【点大小指标】，方便点 大小调节。</li>
</ul>
<h4 id="5-4-3-垂直条形图"><a href="#5-4-3-垂直条形图" class="headerlink" title="5.4.3 垂直条形图"></a>5.4.3 垂直条形图</h4><p>本次实现功能：根据<code>时间</code>在同垂直条形图<code>展示航延误情况</code>及<code>延误类型</code>。</p>
<p><strong>1、新建垂直条形图并做相关指标配置</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626113846368.png" alt="image-20220626113846368"></p>
<p><strong>2、生成指标数据</strong></p>
<p>X 轴主要实现了在某个时间点飞机延误的类型，Y 轴负责统计延误类型出现的次数。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626114227826.png" alt="image-20220626114227826"></p>
<p><strong>3、最后点击【保存】即可</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626115032846.png" alt="image-20220626115032846"></p>
<p><strong>结论：</strong></p>
<ul>
<li>垂直条形图可统计同一时间不同类型指标的数据情况；</li>
<li>其展现形式很直观。</li>
</ul>
<h4 id="5-4-4-标签云图"><a href="#5-4-4-标签云图" class="headerlink" title="5.4.4 标签云图"></a>5.4.4 标签云图</h4><p>本次实现功能：显示目标机场的天气状况</p>
<p><strong>1、新建标签云图并做相关指标配置</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626115639325.png" alt="image-20220626115639325"></p>
<p><strong>2、可点击【选项】对标签做相关排序</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626120122191.png" alt="image-20220626120122191"></p>
<p><strong>3、最后点击【保存】即可</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626120215335.png" alt="image-20220626120215335"></p>
<p><strong>结论：</strong></p>
<ul>
<li>这个也是比较实用的一个图形展示，比如应用在我们的热搜关键词这方面；</li>
<li>如果某些关键词出现的次数越多，在可视化界面的字就会越大。</li>
</ul>
<h4 id="5-4-5-数据表"><a href="#5-4-5-数据表" class="headerlink" title="5.4.5 数据表"></a>5.4.5 数据表</h4><p>本次实现功能：航班数、航班延误、航班取消统计。</p>
<p><strong>1、新建数据表并做相关指标配置</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626144530356.png" alt="image-20220626144530356"></p>
<p>接着，在一个图表中创建多个指标，比如，出了上述的航班数之外，我再新增<code>航班延误指标</code>和<code>航班取消指标</code>两项。</p>
<p><strong>2、继续添加分组（表字段）</strong></p>
<blockquote>
<p>可对字段进行数据过滤操作。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626145947536.png" alt="image-20220626145947536"></p>
<p>但是运行结果是所有数据的聚合，我们可以继续优化：</p>
<blockquote>
<p>这样的话就可以分段统计了。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626150315406.png" alt="image-20220626150315406"></p>
<p><strong>3、最后点击【保存】即可</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626150534232.png" alt="image-20220626150534232"></p>
<p><strong>结论：</strong></p>
<ul>
<li>通过图表二维关系进行展现，更加清晰；</li>
<li>同时图表具备多字段自定义及日志数据过滤（筛选）。</li>
</ul>
<h4 id="5-4-6-区域地图"><a href="#5-4-6-区域地图" class="headerlink" title="5.4.6 区域地图"></a>5.4.6 区域地图</h4><p>本次实现功能：通过地图来展示不同国家的不同票价。</p>
<p><strong>1、新建区域地图并做相关指标配置</strong></p>
<blockquote>
<p>票价越高，地图颜色就越红（当然也可以自定义颜色）</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626151053068.png" alt="image-20220626151053068"></p>
<p><strong>2、最后点击【保存】即可</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626151629958.png" alt="image-20220626151629958"></p>
<p><strong>结论：</strong></p>
<ul>
<li>对于市场遍布全球的公司，区域地图是一个很不错的选择；</li>
<li>该模式下，可对日志数据进行相关统计（关联国际地区），统计结果将以地图形式展现。</li>
</ul>
<h4 id="5-4-7-TSVB-图"><a href="#5-4-7-TSVB-图" class="headerlink" title="5.4.7 TSVB 图"></a>5.4.7 TSVB 图</h4><p>对于较为复杂的 ES 聚合操作，需要使用到我们的 <code>TSVB</code>，即下方综合图表：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626153037832.png" alt="image-20220626153037832"></p>
<p>本次实现功能：统计航班延误率</p>
<p><strong>1、新建 Visual Builder 并做相关指标配置</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626160249808.png" alt="image-20220626160249808"></p>
<p><strong>2、接着点击面板选项生成数据</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626160425229.png" alt="image-20220626160425229"></p>
<h4 id="5-4-8-问题？"><a href="#5-4-8-问题？" class="headerlink" title="5.4.8 问题？"></a>5.4.8 问题？</h4><p>对于 kibana 上点点的操作，就可以得到对应的数据信息。创建一个可视化图表之后，其后端是如何实现数据采集的呢？</p>
<p><strong>1、点击可视化上方的【检查】按钮</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626152527228.png" alt="image-20220626152527228"></p>
<p><strong>2、查看【亲求】部分</strong></p>
<blockquote>
<p>可以看到，这其实是 <code>ES 后端的聚合查询语句</code>，也就是我们点点点操作的时候，就已经帮我们自动实现了。</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626152231495.png" alt="image-20220626152231495"></p>
<h3 id="5-5-仪表板管理"><a href="#5-5-仪表板管理" class="headerlink" title="5.5 仪表板管理"></a>5.5 仪表板管理</h3><h4 id="5-5-1-新建仪表板"><a href="#5-5-1-新建仪表板" class="headerlink" title="5.5.1 新建仪表板"></a>5.5.1 新建仪表板</h4><p><strong>1、点击右侧仪表板，并创建新的仪表板</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626122031574.png" alt="image-20220626122031574"></p>
<p><strong>2、点击上方菜单栏【添加】按钮</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626122323899.png" alt="image-20220626122323899"></p>
<p><strong>3、依次点击，就会被添加到仪表板中</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626122437730.png" alt="image-20220626122437730"></p>
<p><strong>4、最后点击【保存】即可</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626122606449.png" alt="image-20220626122606449"></p>
<p>仪表板上查看：</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626122816077.png" alt="image-20220626122816077"></p>
<p><strong>5、仪表板管理</strong></p>
<blockquote>
<ul>
<li>检查</li>
<li>编辑</li>
<li>定制</li>
<li>全屏</li>
<li>删除</li>
</ul>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626123122624.png" alt="image-20220626123122624"></p>
<h4 id="5-5-2-共享仪表板"><a href="#5-5-2-共享仪表板" class="headerlink" title="5.5.2 共享仪表板"></a>5.5.2 共享仪表板</h4><p>如果我们需要将仪表板的内容共享给同事看，这是就需要 Kibana 的<code>仪表板</code>共享功能。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626124409535.png" alt="image-20220626124409535"></p>
<p>点击【复制链接】</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626143600702.png" alt="image-20220626143600702"></p>
<h3 id="5-6-管理空间"><a href="#5-6-管理空间" class="headerlink" title="5.6 管理空间"></a>5.6 管理空间</h3><h4 id="5-6-1-用途"><a href="#5-6-1-用途" class="headerlink" title="5.6.1 用途"></a>5.6.1 用途</h4><p>管理空间可进行权限管理，比如某些组配置的可视化界面仅限该组查看，此时就可以应用到<code>管理空间</code>了，每个管理空间可管理自己独立的一套可视化界面，<code>类似于 K8s 的 namespace</code>。</p>
<h4 id="5-6-2-新建管理空间"><a href="#5-6-2-新建管理空间" class="headerlink" title="5.6.2 新建管理空间"></a>5.6.2 新建管理空间</h4><p><strong>1、如下图，点击【管理空间】</strong></p>
<blockquote>
<p>或点击菜单栏左侧【管理】—&gt;【Kibana】—&gt;【工作区】新建</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626162253440.png" alt="image-20220626162253440"></p>
<p><strong>2、点击创建空间</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626162956733.png" alt="image-20220626162956733"></p>
<p><strong>3、创建好后，就可以登录到不同的管理空间</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627102247042.png" alt="image-20220627102247042"></p>
<h3 id="5-7-日志查询"><a href="#5-7-日志查询" class="headerlink" title="5.7 日志查询"></a>5.7 日志查询</h3><h4 id="5-7-1-根据索引查询"><a href="#5-7-1-根据索引查询" class="headerlink" title="5.7.1 根据索引查询"></a>5.7.1 根据索引查询</h4><p><strong>1、Discover 下选择定义的索引</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627170107635.png" alt="image-20220627170107635"></p>
<p><strong>2、选择对应的索引就可以查看具体日志</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627170359681.png" alt="image-20220627170359681"></p>
<h4 id="5-7-2-根据时间查询"><a href="#5-7-2-根据时间查询" class="headerlink" title="5.7.2 根据时间查询"></a>5.7.2 根据时间查询</h4><p>如果你根据索引字段来匹配某个时间节点的话，则该时间点需要在下图时间范围内才能过滤出来。</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627180831755.png" alt="image-20220627180831755"></p>
<h4 id="5-7-3-根据索引字段查询"><a href="#5-7-3-根据索引字段查询" class="headerlink" title="5.7.3 根据索引字段查询"></a>5.7.3 根据索引字段查询</h4><p><strong>1、查看指定索引有哪些可用字段</strong></p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627165956033.png" alt="image-20220627165956033"></p>
<p><strong>2、根据字段筛选日志内容</strong></p>
<ul>
<li><p>单条件筛选</p>
<blockquote>
<p>根据某个文件名来匹配</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627170725521.png" alt="image-20220627170725521"></p>
<blockquote>
<p>匹配结果如下</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627170656835.png"></p>
<blockquote>
<p>被匹配的字段会以高亮形式显示</p>
</blockquote>
</li>
<li><p>多条件筛选</p>
<blockquote>
<p>精准匹配</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220627171139004.png" alt="image-20220627171139004"></p>
</li>
</ul>
<p><strong>说明</strong>：根据字段来筛选数据是比较灵活的手段，可以快速定位到日志的具体位置。</p>
<h3 id="5-8-索引生命周期管理"><a href="#5-8-索引生命周期管理" class="headerlink" title="5.8 索引生命周期管理"></a>5.8 索引生命周期管理</h3><h4 id="5-8-1-创建生命周期策略"><a href="#5-8-1-创建生命周期策略" class="headerlink" title="5.8.1 创建生命周期策略"></a>5.8.1 创建生命周期策略</h4><p>1、进入索引生命周期策略并创建策略</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220816135703698.png" alt="image-20220816135703698"></p>
<p>2、点击上图【创建策略】进入以下具体配置</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220816140755604.png" alt="image-20220816140755604"></p>
<p>3、最后查看创建的生命周期策略列表</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817104821612.png" alt="image-20220817104821612"></p>
<h4 id="5-8-2-索引添加生命周期策略"><a href="#5-8-2-索引添加生命周期策略" class="headerlink" title="5.8.2 索引添加生命周期策略"></a>5.8.2 索引添加生命周期策略</h4><p>1、进入索引管理并添加对应索引生命周期</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817105256831.png" alt="image-20220817105256831"></p>
<p>2、然后添加策略即可</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817105504026.png" alt="image-20220817105504026"></p>
<p>3、可以同个生命周期策略查看其关联的索引</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817105724955.png" alt="image-20220817105724955"></p>
<h4 id="5-8-3-索引删除生命周期策略"><a href="#5-8-3-索引删除生命周期策略" class="headerlink" title="5.8.3 索引删除生命周期策略"></a>5.8.3 索引删除生命周期策略</h4><p>1、进入索引生命周期策略执行删除即可</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817110518507.png" alt="image-20220817110518507"></p>
<p>2、如果你生命周期策略关联的索引正在被使用，是无法删除的，如下图</p>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817110009045.png" alt="image-20220817110009045"></p>
<blockquote>
<p>这种情况下，可以去索引管理解除对应的索引生命周期策略</p>
</blockquote>
<p><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220817110905668.png" alt="image-20220817110905668"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.rabcnops.cn">Rab</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.rabcnops.cn/posts/articles/ac3cbe0c.html">https://blog.rabcnops.cn/posts/articles/ac3cbe0c.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.rabcnops.cn" target="_blank">Rabcnops</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ELK/">ELK</a></div><div class="post_share"><div class="social-share" data-image="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626161553527.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/wechat.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/alipay.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/articles/29a76d20.html" title="官方都不告诉你的 Windows ISO 下载方式"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230614183145530.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">官方都不告诉你的 Windows ISO 下载方式</div></div></a></div><div class="next-post pull-right"><a href="/posts/articles/90a42e.html" title="没事千万别动生产服数据库 - 来自小菜鸟的忠告"><img class="cover" src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/common-issues-mysql-thumb.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">没事千万别动生产服数据库 - 来自小菜鸟的忠告</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Livere</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81ODIzNS8zNDY5OA=="></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/rabcnops.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Rab</div><div class="author-info__description">专注于云计算/云原生/开发。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/rabcnops/"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:zhurse@163.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="iconfont icon-minutemailer"></i></a><a class="social-icon" href="https://blog.csdn.net/IT_ZRS" rel="external nofollow noreferrer" target="_blank" title="CSDN"><i class="iconfont icon-csdn1"></i></a><a class="social-icon" href="tencent://Message/?Uin=2564395767&amp;websiteName=www.oicqzone.com&amp;Menu=yes" rel="external nofollow noreferrer" target="_blank" title="QQ"><i class="iconfont icon-QQ"></i></a><a class="social-icon" href="https://blog.rabcnops.cn/atom.xml" target="_blank" title="RSS"><i class="iconfont icon-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">2023/03/24 开通个人博客系统，会同步 CSDN 内容。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81ELK-%E4%BB%8B%E7%BB%8D"><span class="toc-text">一、ELK 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF-ELK-%EF%BC%9F"><span class="toc-text">1.1 什么是 ELK ？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-ELK-%EF%BC%9F"><span class="toc-text">1.2 为什么选择 ELK ？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-ELK-%E5%85%B7%E5%A4%87%E5%93%AA%E4%BA%9B%E7%89%B9%E7%82%B9%EF%BC%9F"><span class="toc-text">1.3 ELK 具备哪些特点？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-ELK-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.4 ELK 组件介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-Elasticsearch"><span class="toc-text">1.4.1 Elasticsearch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-Logstash"><span class="toc-text">1.4.2 Logstash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-Kibana"><span class="toc-text">1.4.3 Kibana</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">二、架构及应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84"><span class="toc-text">2.1 基础架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-text">2.2 高可用架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81VM-%E9%83%A8%E7%BD%B2-ELK-%E9%9B%86%E7%BE%A4"><span class="toc-text">三、VM 部署 ELK 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%B8%BB%E6%9C%BA%E8%A7%84%E5%88%92"><span class="toc-text">3.1 主机规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="toc-text">3.2 应用部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-ES-%E9%9B%86%E7%BE%A4"><span class="toc-text">3.3 ES 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Logstash-%E5%88%86%E6%B5%81"><span class="toc-text">3.4 Logstash 分流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Kibana-%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA"><span class="toc-text">3.5 Kibana 前端展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-Nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">3.6 Nginx 反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-Zookeeper-%E9%9B%86%E7%BE%A4"><span class="toc-text">3.7 Zookeeper 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-Kafka-%E9%9B%86%E7%BE%A4"><span class="toc-text">3.8 Kafka 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-FAQ"><span class="toc-text">3.9 FAQ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-9-1-ES-Systemd-%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99"><span class="toc-text">3.9.1 ES Systemd 启动报错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-9-2-Logstash-%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99"><span class="toc-text">3.9.2 Logstash 启动报错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-9-3-head-%E6%8F%92%E4%BB%B6-406-%E9%94%99%E8%AF%AF"><span class="toc-text">3.9.3 head 插件 406 错误</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Docker-%E9%83%A8%E7%BD%B2-ELK-%E9%9B%86%E7%BE%A4"><span class="toc-text">四、Docker 部署 ELK 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-ES-%E9%9B%86%E7%BE%A4"><span class="toc-text">4.1 ES 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-ES-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-text">4.1.1 ES 集群部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-ES-%E4%BF%AE%E6%94%B9-x2F-%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81"><span class="toc-text">4.1.2 ES 修改&#x2F;忘记密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-ES-%E5%AE%9E%E4%BE%8B%E6%93%8D%E4%BD%9C"><span class="toc-text">4.3.2 ES 实例操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Logstash-%E5%88%86%E6%B5%81"><span class="toc-text">4.2 Logstash 分流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-Kibana-%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA"><span class="toc-text">4.3 Kibana 前端展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-Nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">4.4 Nginx 反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-Zookeeper-%E9%9B%86%E7%BE%A4"><span class="toc-text">4.5 Zookeeper 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-Kafka-%E9%9B%86%E7%BE%A4"><span class="toc-text">4.6 Kafka 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-Filebeat-%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8"><span class="toc-text">4.7 Filebeat 原理及应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">4.7.1 架构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-2-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">4.7.2 工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-3-%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%BA%94%E7%94%A8"><span class="toc-text">4.7.3 部署及应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-4-%E8%B0%83%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-text">4.7.4 调用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-7-4-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F"><span class="toc-text">4.7.4.1 配置文件方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-7-4-2-%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%96%B9%E5%BC%8F"><span class="toc-text">4.7.4.2 命令行方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-5-%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95"><span class="toc-text">4.7.5 基础用法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-7-5-1-input"><span class="toc-text">4.7.5.1 input</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-7-5-2-output"><span class="toc-text">4.7.5.2 output</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-6-Filebeat-ES"><span class="toc-text">4.7.6 Filebeat + ES</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-7-6-1-Nginx"><span class="toc-text">4.7.6.1 Nginx</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-7-6-2-Java"><span class="toc-text">4.7.6.2 Java</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-Filebeat-Logstash-ES"><span class="toc-text">4.8 Filebeat + Logstash + ES</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-8-1-Filebeat-%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86"><span class="toc-text">4.8.1 Filebeat 数据采集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-8-2-Logstash-%E8%BE%93%E5%87%BA%E8%87%B3-ES"><span class="toc-text">4.8.2 Logstash 输出至 ES</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-9-Filebeat-Kafka-Logstash-ES"><span class="toc-text">4.9 Filebeat + Kafka + Logstash + ES</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-9-FAQ"><span class="toc-text">4.9 FAQ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-9-1-es-head-%E6%8F%92%E4%BB%B6%E8%AE%BF%E9%97%AE%E4%B8%8D%E4%BA%86-ES-%E9%9B%86%E7%BE%A4"><span class="toc-text">4.9.1 es-head 插件访问不了 ES 集群</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Kibana-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="toc-text">五、Kibana 基础操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-text">5.1 索引管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-%E6%9F%A5%E7%9C%8B-ES-%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="toc-text">5.1.1 查看 ES 的索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="toc-text">5.1.2 创建和使用索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-text">5.2 用户管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="toc-text">5.2.1 创建用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7"><span class="toc-text">5.2.2 删除用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-%E6%9B%B4%E6%94%B9%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-text">5.2.3 更改用户密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-4-%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%EF%BC%88%E6%9D%83%E9%99%90%EF%BC%89"><span class="toc-text">5.2.4 用户角色（权限）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-5-%E8%A7%92%E8%89%B2%E5%AF%B9%E5%BA%94%E7%BB%91%E5%AE%9A%E5%B7%A5%E4%BD%9C%E5%8C%BA"><span class="toc-text">5.2.5 角色对应绑定工作区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-6-%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E6%9D%83%E9%99%90"><span class="toc-text">5.2.6 开发人员权限</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-ES-%E9%9B%86%E7%BE%A4-x2F-%E5%AE%9E%E4%BE%8B%E7%8A%B6%E6%80%81"><span class="toc-text">5.3 ES 集群&#x2F;实例状态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-ES-%E9%9B%86%E7%BE%A4"><span class="toc-text">5.3.1 ES 集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-Kibana-%E5%AE%9E%E4%BE%8B"><span class="toc-text">5.3.2 Kibana 实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%B8%B8%E7%94%A8%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E6%9E%90"><span class="toc-text">5.4 常用可视化分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-%E9%A5%BC%E5%9B%BE"><span class="toc-text">5.4.1 饼图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-%E9%9D%A2%E7%A7%AF%E5%9B%BE"><span class="toc-text">5.4.2 面积图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-3-%E5%9E%82%E7%9B%B4%E6%9D%A1%E5%BD%A2%E5%9B%BE"><span class="toc-text">5.4.3 垂直条形图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-4-%E6%A0%87%E7%AD%BE%E4%BA%91%E5%9B%BE"><span class="toc-text">5.4.4 标签云图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-5-%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-text">5.4.5 数据表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-6-%E5%8C%BA%E5%9F%9F%E5%9C%B0%E5%9B%BE"><span class="toc-text">5.4.6 区域地图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-7-TSVB-%E5%9B%BE"><span class="toc-text">5.4.7 TSVB 图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-8-%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-text">5.4.8 问题？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E4%BB%AA%E8%A1%A8%E6%9D%BF%E7%AE%A1%E7%90%86"><span class="toc-text">5.5 仪表板管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-1-%E6%96%B0%E5%BB%BA%E4%BB%AA%E8%A1%A8%E6%9D%BF"><span class="toc-text">5.5.1 新建仪表板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-2-%E5%85%B1%E4%BA%AB%E4%BB%AA%E8%A1%A8%E6%9D%BF"><span class="toc-text">5.5.2 共享仪表板</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E7%AE%A1%E7%90%86%E7%A9%BA%E9%97%B4"><span class="toc-text">5.6 管理空间</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-1-%E7%94%A8%E9%80%94"><span class="toc-text">5.6.1 用途</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-2-%E6%96%B0%E5%BB%BA%E7%AE%A1%E7%90%86%E7%A9%BA%E9%97%B4"><span class="toc-text">5.6.2 新建管理空间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2"><span class="toc-text">5.7 日志查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-1-%E6%A0%B9%E6%8D%AE%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2"><span class="toc-text">5.7.1 根据索引查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-2-%E6%A0%B9%E6%8D%AE%E6%97%B6%E9%97%B4%E6%9F%A5%E8%AF%A2"><span class="toc-text">5.7.2 根据时间查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-3-%E6%A0%B9%E6%8D%AE%E7%B4%A2%E5%BC%95%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2"><span class="toc-text">5.7.3 根据索引字段查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-%E7%B4%A2%E5%BC%95%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="toc-text">5.8 索引生命周期管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-1-%E5%88%9B%E5%BB%BA%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="toc-text">5.8.1 创建生命周期策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-2-%E7%B4%A2%E5%BC%95%E6%B7%BB%E5%8A%A0%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="toc-text">5.8.2 索引添加生命周期策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-3-%E7%B4%A2%E5%BC%95%E5%88%A0%E9%99%A4%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="toc-text">5.8.3 索引删除生命周期策略</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/29a76d20.html" title="官方都不告诉你的 Windows ISO 下载方式"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230614183145530.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="官方都不告诉你的 Windows ISO 下载方式"/></a><div class="content"><a class="title" href="/posts/articles/29a76d20.html" title="官方都不告诉你的 Windows ISO 下载方式">官方都不告诉你的 Windows ISO 下载方式</a><time datetime="2023-06-14T12:20:00.000Z" title="发表于 2023-06-14 20:20:00">2023-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/ac3cbe0c.html" title="基于 Kafka 构建 EL(F)K 高并发分布式日志系统"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20220626161553527.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基于 Kafka 构建 EL(F)K 高并发分布式日志系统"/></a><div class="content"><a class="title" href="/posts/articles/ac3cbe0c.html" title="基于 Kafka 构建 EL(F)K 高并发分布式日志系统">基于 Kafka 构建 EL(F)K 高并发分布式日志系统</a><time datetime="2023-06-07T08:13:00.000Z" title="发表于 2023-06-07 16:13:00">2023-06-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/90a42e.html" title="没事千万别动生产服数据库 - 来自小菜鸟的忠告"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/common-issues-mysql-thumb.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="没事千万别动生产服数据库 - 来自小菜鸟的忠告"/></a><div class="content"><a class="title" href="/posts/articles/90a42e.html" title="没事千万别动生产服数据库 - 来自小菜鸟的忠告">没事千万别动生产服数据库 - 来自小菜鸟的忠告</a><time datetime="2023-06-06T10:20:14.000Z" title="发表于 2023-06-06 18:20:14">2023-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/1968d59e.html" title="Docker attach VS exec"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/docker-attach.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker attach VS exec"/></a><div class="content"><a class="title" href="/posts/articles/1968d59e.html" title="Docker attach VS exec">Docker attach VS exec</a><time datetime="2023-06-05T03:33:14.000Z" title="发表于 2023-06-05 11:33:14">2023-06-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/articles/a90bd9b5.html" title="基于 VuePress 的 RECO 主题博客系统搭建"><img src="https://csdn-rab.oss-cn-chengdu.aliyuncs.com/img/image-20230528135648671.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基于 VuePress 的 RECO 主题博客系统搭建"/></a><div class="content"><a class="title" href="/posts/articles/a90bd9b5.html" title="基于 VuePress 的 RECO 主题博客系统搭建">基于 VuePress 的 RECO 主题博客系统搭建</a><time datetime="2023-05-28T05:33:14.000Z" title="发表于 2023-05-28 13:33:14">2023-05-28</time></div></div></div></div></div></div></main><footer id="footer" style="background: #14161a"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Rab</div><div class="footer_custom_text">Hi, welcome to my <a href="https://blog.rabcnops.cn/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://blog.rabcnops.cn/posts/articles/ac3cbe0c.html'
    this.page.identifier = '/posts/articles/ac3cbe0c.html'
    this.page.title = '基于 Kafka 构建 EL(F)K 高并发分布式日志系统'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Livere' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>